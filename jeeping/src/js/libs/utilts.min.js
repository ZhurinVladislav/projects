const utilts = () => {
  /* Проверка поддержки webp, добавление класса webp или no-webp для HTML */
  const webp = callback => {
    const webP = new Image();

    webP.onload = webP.onerror = () => callback(webP.height == 2);

    webP.src = 'data:image/webp;base64,UklGRjoAAABXRUJQVlA4IC4AAACyAgCdASoCAAIALmk0mk0iIiIiIgBoSygABc6WWgAA/veff/0PP8bA//LwYAAA';
  };

  webp(support => {
    const className = support === true ? 'webp' : 'no-webp';

    document.documentElement.classList.add(className);
  });

  /* Убираем фокус после нажатия на кнопку или ссылку */
  const removeFocus = () => {
    const arrBtn = document.querySelectorAll('button');
    const arrLink = document.querySelectorAll('a');
    const arrElements = [...arrBtn, ...arrLink];

    arrElements.forEach(ev => {
      ev.addEventListener('mousedown', el => el.preventDefault());
      ev.addEventListener('mouseup', el => el.preventDefault());
    });
  };

  removeFocus();

  /* Нормализуем ссылки на номер телефона. */
  // const normalizePhoneLink = () => {
  //   const arrLinks = document.querySelectorAll('a[href^="tel:"]');

  //   if (arrLinks.length === 0) return;

  //   arrLinks.forEach(el => {
  //     const normalizeHref = el.href.replace(/[^+\d]/g, '');
  //     el.href = `tel:${normalizeHref}`;
  //   });
  // };

  // normalizePhoneLink();
  /**
   * Нормализуем ссылки на номер телефона, WhatsApp и Telegram.
   */
  const normalizePhoneLinks = () => {
    // Находим все ссылки с протоколами tel:, https://wa.me/, https://t.me/
    const links = document.querySelectorAll('a[href^="tel:"], a[href^="https://wa.me/"], a[href^="https://t.me/"]');

    if (!links || links.length === 0) return;

    links.forEach(link => {
      let href = link.getAttribute('href');

      // Извлекаем номер телефона (цифры, знак +, пробелы, скобки, дефисы и т.д.)
      const phoneMatch = href.match(/\+?[\d\s()-]+/);
      if (phoneMatch) {
        // Удаляем все нечисловые символы, кроме знака +
        const cleanPhone = phoneMatch[0].replace(/[^\d+]/g, '');

        // Обновляем ссылку в зависимости от типа
        if (href.startsWith('https://wa.me/')) {
          // Сохраняем параметры (например, text) для WhatsApp
          const url = new URL(href);
          const params = url.search ? `?${url.searchParams.toString()}` : '';
          href = `https://wa.me/${cleanPhone}${params}`;
        } else if (href.startsWith('https://t.me/')) {
          href = `https://t.me/${cleanPhone}`;
        } else if (href.startsWith('tel:')) {
          href = `tel:${cleanPhone}`;
        }

        // Устанавливаем новый атрибут href
        link.setAttribute('href', href);
      }
    });
  };

  normalizePhoneLinks();
};

utilts();
