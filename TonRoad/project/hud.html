<html
	lang="ru"
	style="
		--tg-viewport-height: 100vh;
		--tg-viewport-stable-height: 100vh;
		--vh: 9.450000000000001px;
		--scale: 1;
		--header-h: 150px;
		--footer-h: 188px;
	"
	jstcache="0"
>
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>TonRoad</title>
		<!-- fonts -->
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Chiron+GoRound+TC:wght@200..900&display=swap"
			rel="stylesheet"
		/>
		<link
			type="text/css"
			rel="stylesheet"
			href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Google+Sans:400,500,700|Google+Sans+Text:400,500,700&amp;lang=ru"
		/>
		<link
			type="text/css"
			rel="stylesheet"
			href="https://fonts.googleapis.com/css?family=Google+Sans+Text:400&amp;text=%E2%86%90%E2%86%92%E2%86%91%E2%86%93&amp;lang=ru"
		/>
		<!-- styles -->
		<style>
			.SLHIdE-sv-links-control svg > path[pano] {
				outline: none;
			}
			.SLHIdE-sv-links-control svg > path[pano]:focus-visible {
				outline: auto;
			}

			.gm-compass-turn {
				cursor: pointer;
				background-color: transparent;
				border: 0 none;
				height: 48px;
				left: 0;
				overflow: hidden;
				padding: 0;
				position: absolute;
				top: 0;
				width: 14px;
				z-index: 1;
			}
			.gm-compass-turn-opposite {
				-ms-transform: scaleX(-1);
				-ms-transform-origin: 24px 0;
				-moz-transform: scaleX(-1);
				-moz-transform-origin: 24px 0;
				-webkit-transform: scaleX(-1);
				-webkit-transform-origin: 24px 0;
				transform: scaleX(-1);
				transform-origin: 24px 0;
			}
			.gm-compass:hover .gm-compass-tooltip-text,
			.gm-compass:hover .gm-compass-arrow-right {
				opacity: 1;
				-webkit-transition-delay: 1.5s;
				transition-delay: 1.5s;
			}
			.gm-compass-tooltip-text {
				opacity: 0;
				background-color: #222;
				width: 112px;
				height: 23px;
				line-height: 23px;
				right: 58px;
				top: 7px;
				position: absolute;
				border: 1px solid #ccc;
				text-align: center;
				color: #ccc;
				font-family: Roboto, Arial;
				font-size: 12px;
				font-weight: bold;
			}
			.gm-compass-arrow-right {
				opacity: 0;
				width: 0;
				height: 0;
				border-top: 7px solid transparent;
				border-bottom: 7px solid transparent;
				top: 16px;
				position: absolute;
			}
			.gm-compass-arrow-right-outer {
				right: 52px;
				border-left: 7px solid #ccc;
			}
			.gm-compass-arrow-right-inner {
				right: 53px;
				border-left: 7px solid #222;
			}
			sentinel {
			}

			.gm-style .gm-compass-icon {
				background-image: url(https://maps.gstatic.com/mapfiles/api-3/images/sv9.png);
				-webkit-background-size: 164px 175px;
				background-size: 164px 175px;
			}
			@media (-webkit-min-device-pixel-ratio: 1.2),
				(-webkit-min-device-pixel-ratio: 1.2083333333333333),
				(min-resolution: 1.2dppx),
				(min-resolution: 116dpi) {
				.gm-style .gm-compass-icon {
					background-image: url(https://maps.gstatic.com/mapfiles/api-3/images/sv9_hdpi.png);
				}
				.gm-style.gm-china .gm-compass-icon {
					background-image: url(http://maps.gstatic.cn/mapfiles/api-3/images/sv9_hdpi.png);
				}
			}
			.gm-compass-background {
				height: 48px;
				width: 48px;
				overflow: hidden;
				position: absolute;
			}
			.gm-compass {
				position: relative;
				width: 48px;
				height: 48px;
			}
			.gm-compass-needle {
				cursor: pointer;
				background-color: transparent;
				border: 0 none;
				height: 48px;
				left: 14px;
				overflow: hidden;
				padding: 0;
				position: absolute;
				top: 0;
				width: 20px;
			}
			.gm-control-active.gm-compass-needle {
				-webkit-transform: var(--gm-compass-control-rotation-degree, 0);
				-ms-transform: var(--gm-compass-control-rotation-degree, 0);
				transform: var(--gm-compass-control-rotation-degree, 0);
			}
			sentinel {
			}

			.gm-iv-container {
				-webkit-box-align: center;
				-webkit-align-items: center;
				align-items: center;
				background-color: #222;
				border-right: 1px solid #666;
				display: -webkit-box;
				display: -webkit-flex;
				display: flex;
				font-family: Roboto, Arial, sans-serif;
				margin-top: 10px;
				opacity: 0.8;
				width: 27px;
				height: 56px;
			}
			[dir='rtl'] .gm-iv-container {
				border-left: 1px solid #666;
				border-right: none;
			}
			.gm-iv-close {
				-webkit-box-align: center;
				-webkit-align-items: center;
				align-items: center;
				background: transparent;
				border: none;
				cursor: pointer;
				display: -webkit-box;
				display: -webkit-flex;
				display: flex;
				height: 27px;
				-webkit-box-pack: center;
				-webkit-justify-content: center;
				justify-content: center;
				margin: 0;
				outline-offset: -2px;
				padding: 0;
				width: 27px;
			}
			.gm-iv-back {
				background: transparent
					url(https://maps.gstatic.com/mapfiles/api-3/images/sv9.png) no-repeat -2px -73px;
				-webkit-background-size: 164px 175px;
				background-size: 164px 175px;
				height: 12px;
				width: 15px;
			}
			.gm-iv-close:focus > .gm-iv-back,
			.gm-iv-close:hover > .gm-iv-back {
				background-position-x: -39px;
			}
			.gm-iv-close > .gm-iv-back.gm-iv-back-rtl {
				background-position-x: -137px;
			}
			.gm-iv-close:focus > .gm-iv-back.gm-iv-back-rtl,
			.gm-iv-close:hover > .gm-iv-back.gm-iv-back-rtl {
				background-position-x: -100px;
			}
			@media (-webkit-min-device-pixel-ratio: 1.2),
				(-webkit-min-device-pixel-ratio: 1.2083333333333333),
				(min-resolution: 1.2dppx),
				(min-resolution: 116dpi) {
				.gm-iv-back {
					background-image: url(https://maps.gstatic.com/mapfiles/api-3/images/sv9_hdpi.png);
					background-position-y: -72px;
				}
			}
			sentinel {
			}

			.gm-iv-address {
				background-color: #222;
				opacity: 0.8;
				font-family: Roboto, Arial, sans-serif;
				border-bottom-right-radius: 2px;
				border-top-right-radius: 2px;
				display: inline-block;
				padding: 6px 8px;
				margin-top: 10px;
				height: 56px;
				-webkit-box-sizing: border-box;
				box-sizing: border-box;
			}
			.gm-iv-marker-icon {
				background-position: -17px -48px;
				height: 22px;
				overflow: hidden;
				width: 14px;
			}
			.gm-iv-marker-link:focus > .gm-iv-marker-icon,
			.gm-iv-marker-link:hover > .gm-iv-marker-icon {
				background-position: -1px -48px;
			}
			sentinel {
			}

			.gm-iv-address-description {
				display: inline-block;
				min-width: 137px;
				max-width: 340px;
				vertical-align: top;
				position: relative;
				padding-right: 30px;
				-webkit-box-sizing: border-box;
				box-sizing: border-box;
			}
			.gm-iv-short-address-description {
				color: #fff;
				font-weight: bold;
				font-size: 12px;
				overflow: hidden;
				white-space: nowrap;
				text-overflow: ellipsis;
				padding-bottom: 2px;
			}
			.gm-iv-long-address-description {
				color: #ccc;
				font-weight: normal;
				font-size: 11px;
				overflow: hidden;
				white-space: nowrap;
				text-overflow: ellipsis;
				min-width: 70px;
			}
			.gm-iv-vertical-separator {
				display: inline-block;
				height: 56px;
				position: absolute;
				right: 28px;
				top: 10px;
				width: 1px;
				background: -webkit-gradient(
					linear,
					left bottom,
					left top,
					from(#404040),
					color-stop(#666),
					to(#404040)
				);
				background: -webkit-linear-gradient(bottom, #404040, #666, #404040);
				background: linear-gradient(to top, #404040, #666, #404040);
			}
			.gm-iv-marker {
				display: inline-block;
				height: 22px;
				position: absolute;
				right: 8px;
				top: 27px;
				width: 14px;
			}
			.gm-iv-marker-icon-background {
				background-image: url(https://maps.gstatic.com/mapfiles/api-3/images/sv9.png);
				-webkit-background-size: 164px 175px;
				background-size: 164px 175px;
			}
			.gm-iv-horizontal-separator {
				height: 1px;
				margin-bottom: 6px;
				margin-left: -8px;
				margin-right: -8px;
				background: -webkit-gradient(
					linear,
					right top,
					left top,
					from(#404040),
					color-stop(#666),
					to(#404040)
				);
				background: -webkit-linear-gradient(right, #404040, #666, #404040);
				background: linear-gradient(to left, #404040, #666, #404040);
			}
			.gm-iv-address-link {
				position: absolute;
				top: 48px;
			}
			.gm-iv-address-custom p {
				color: #777;
				text-decoration: none;
				font-size: 11px;
			}
			.gm-iv-address-link a {
				color: #aecbfa;
				text-decoration: none;
				font-size: 11px;
			}
			.gm-iv-address-link a:hover {
				text-decoration: underline;
			}
			.gm-iv-profile-link {
				color: #fff;
				font-weight: bold;
				font-size: 12px;
				overflow: hidden;
				white-space: nowrap;
				text-overflow: ellipsis;
			}
			.gm-iv-profile-url a > .iv-profile-link:hover {
				text-decoration: underline;
			}
			.gm-iv-profile-url a {
				text-decoration: none;
			}
			@media (-webkit-min-device-pixel-ratio: 1.2),
				(-webkit-min-device-pixel-ratio: 1.2083333333333333),
				(min-resolution: 1.2dppx),
				(min-resolution: 116dpi) {
				.gm-iv-marker-icon-background {
					background-image: url(https://maps.gstatic.com/mapfiles/api-3/images/sv9_hdpi.png);
				}
			}
			.gm-iv-hidden {
				display: none;
			}
			sentinel {
			}

			.LGLeeN-keyboard-shortcuts-view {
				display: -webkit-box;
				display: -webkit-flex;
				display: -moz-box;
				display: -ms-flexbox;
				display: flex;
			}
			.LGLeeN-keyboard-shortcuts-view table,
			.LGLeeN-keyboard-shortcuts-view tbody,
			.LGLeeN-keyboard-shortcuts-view td,
			.LGLeeN-keyboard-shortcuts-view tr {
				background: inherit;
				border: none;
				margin: 0;
				padding: 0;
			}
			.LGLeeN-keyboard-shortcuts-view table {
				display: table;
			}
			.LGLeeN-keyboard-shortcuts-view tr {
				display: table-row;
			}
			.LGLeeN-keyboard-shortcuts-view td {
				-moz-box-sizing: border-box;
				box-sizing: border-box;
				display: table-cell;
				color: light-dark(#000, #fff);
				padding: 6px;
				vertical-align: middle;
				white-space: nowrap;
			}
			.LGLeeN-keyboard-shortcuts-view td:first-child {
				text-align: end;
			}
			.LGLeeN-keyboard-shortcuts-view td kbd {
				background-color: light-dark(#e8eaed, #3c4043);
				border-radius: 2px;
				border: none;
				-moz-box-sizing: border-box;
				box-sizing: border-box;
				color: inherit;
				display: inline-block;
				font-family: Google Sans Text, Roboto, Arial, sans-serif;
				line-height: 16px;
				margin: 0 2px;
				min-height: 20px;
				min-width: 20px;
				padding: 2px 4px;
				position: relative;
				text-align: center;
			}

			.gm-control-active > img {
				-webkit-box-sizing: content-box;
				box-sizing: content-box;
				display: none;
				left: 50%;
				pointer-events: none;
				position: absolute;
				top: 50%;
				-webkit-transform: translate(-50%, -50%);
				-ms-transform: translate(-50%, -50%);
				transform: translate(-50%, -50%);
			}
			.gm-control-active > img:nth-child(1) {
				display: block;
			}
			.gm-control-active:focus > img:nth-child(1),
			.gm-control-active:hover > img:nth-child(1),
			.gm-control-active:active > img:nth-child(1),
			.gm-control-active:disabled > img:nth-child(1) {
				display: none;
			}
			.gm-control-active:focus > img:nth-child(2),
			.gm-control-active:hover > img:nth-child(2) {
				display: block;
			}
			.gm-control-active:active > img:nth-child(3) {
				display: block;
			}
			.gm-control-active:disabled > img:nth-child(4) {
				display: block;
			}
			sentinel {
			}

			.gm-style .gm-style-cc a,
			.gm-style .gm-style-cc button,
			.gm-style .gm-style-cc span,
			.gm-style .gm-style-mtc div {
				font-size: 10px;
				-webkit-box-sizing: border-box;
				box-sizing: border-box;
			}
			.gm-style .gm-style-cc a,
			.gm-style .gm-style-cc button,
			.gm-style .gm-style-cc span {
				outline-offset: 3px;
			}
			sentinel {
			}

			@media print {
				.gm-style .gmnoprint,
				.gmnoprint {
					display: none;
				}
			}
			@media screen {
				.gm-style .gmnoscreen,
				.gmnoscreen {
					display: none;
				}
			}

			.gm-style img {
				max-width: none;
			}
			.gm-style {
				font: 400 11px Roboto, Arial, sans-serif;
				text-decoration: none;
			}

			/* ===== ROOT / RESET ===== */
			:root {
				--container-width: 411px;
				--container-padding: 6px;
				--font-main: 'Chiron GoRound TC', sans-serif;
				--font-weight-base: 800;
				--font-line-height-base: 120%;
				--font-size-base: 10px;
				--page-color: #001716;
				--text-color: #f5fdff;
				--white-color: #fff;
				--bg-block: #2e3b55;
				--bg-border-color: #066ecb;
				--gold-color: #ffe028;
				--accent: #7a3cff;
				--design-h: 760px;
				--design-w: 422px;
				--vh: 1vh;
				--scale: 1;
				--header-h: 150px;
				--footer-h: 188px;
			}

			html,
			body {
				height: 100%;
				margin: 0;
				padding: 0;
				width: 100%;
				max-width: 100%;
				box-sizing: border-box;
				overflow: hidden;
			}
			*,
			*::before,
			*::after {
				box-sizing: border-box;
			}
			body {
				display: flex;
				flex-direction: column;
				font-family: var(--font-main);
				font-weight: var(--font-weight-base);
				line-height: var(--font-line-height-base);
				font-size: var(--font-size-base);
				color: var(--text-color);
				background-color: var(--page-color);
			}
			img {
				max-width: 100%;
				height: auto;
				border: 0;
			}
			ul {
				list-style: none;
				margin: 0;
				padding: 0;
			}
			a {
				text-decoration: none;
				color: inherit;
			}
			button {
				display: block;
				padding: 0;
				border: none;
				background: transparent;
				cursor: pointer;
				-webkit-tap-highlight-color: transparent;
			}
			a {
				-webkit-tap-highlight-color: transparent;
			}

			/* ===== FRAME ===== */
			.app-viewport {
				height: calc(var(--vh) * 100);
				display: flex;
				justify-content: center;
				align-items: flex-start;
				overflow: hidden;
			}
			.app {
				position: relative;
				max-width: 100%;
				width: var(--design-w);
				height: var(--design-h);
				/* max-width: none; */
				/* width: calc(var(--design-w) * 1px); */
				/* height: calc(var(--design-h) * 1px); */
				/* transform: scale(var(--scale)); */
				transform-origin: top center;
				overflow: hidden;
				border-radius: 10px;
			}
			/* Показать UI только когда карта готова */
			.app {
				visibility: hidden;
				opacity: 0;
				transition: opacity 0.18s ease;
			}
			.app.ready {
				visibility: visible;
				opacity: 1;
				transition: none;
			} /* ← чтобы при возврате не мигал */

			/* Layered */
			.header {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				z-index: 4;
			}
			.main {
				position: absolute;
				left: 0;
				right: 0;
				top: var(--header-h);
				bottom: var(--footer-h);
				z-index: 3;
				overflow: hidden;
			}
			.footer {
				position: fixed;
				bottom: 0;
				left: 0;
				width: 100%;
				z-index: 4;
			}

			/* ===== GOOGLE LAYER ===== */
			/* Anti-flicker при возврате из Telegram/iOS WebKit */
			.app__bg,
			#street-view,
			#drone-map {
				background: #001716;
				-webkit-backface-visibility: hidden;
				backface-visibility: hidden;
				transform: translateZ(0);
			}
			.gm-style,
			.gm-iv-container {
				background: #001716 !important;
			}

			.app__bg {
				position: absolute;
				inset: 0;
				z-index: 0;
				overflow: hidden;
			}
			#street-view,
			#drone-map {
				position: absolute;
				inset: 0;
				width: 100%;
				height: 100%;
			}
			#drone-map {
				display: none;
			}
			#block-touch {
				position: absolute;
				top: var(--header-h);
				bottom: var(--footer-h);
				left: 0;
				right: 0;
				z-index: 2;
				background: transparent;
				pointer-events: auto; /* JS переключает это поле */
				touch-action: none;
			}

			body:not(.sos-mode) .gm-iv-svlinks,
			body:not(.sos-mode) .gm-iv-arrow,
			body:not(.sos-mode) .gmnoprint {
				display: none !important;
			}

			/* ===== CONTAINER ===== */
			.container {
				position: relative;
				z-index: 3;
				margin: 0 auto;
				padding-inline: var(--container-padding);
				max-width: calc(var(--container-width) + var(--container-padding) * 2);
				width: 100%;
			}
			/* ===== HEADER ===== */
			.header::after {
				content: '';
				position: absolute;
				top: 0;
				left: 0;
				z-index: 0;
				width: 100%;
				height: 112px;
				background-image: url('header-bg-img.png');
				background-repeat: no-repeat;
				background-position: center;
			}
			.header__container {
				display: flex;
				align-items: center;
				gap: 16px;
				padding-top: 10px;
				padding-bottom: 6px;
			}

			.header__btn-menu {
				display: flex;
				margin-left: auto;
				width: 92px;
				height: 52px;
				background-image: url('menu-btn.png');
				background-repeat: no-repeat;
				background-size: contain;
				background-position: center;
				cursor: pointer;
			}

			.avatar-card {
				position: relative;
				z-index: 10;
				display: flex;
				align-items: flex-end;
				gap: 4px;
				border-radius: 4px;
				padding: 6px;
				max-width: 120px;
				min-width: 86px;
				/* width: 100%; */
				min-height: 58px;
				background-image: url('user-card.png');
				background-position: center;
				/* background-size: contain; */
				background-size: cover;
				background-repeat: no-repeat;
				overflow: hidden;
			}

			.avatar-card__img {
				width: 24px;
				flex-shrink: 0;
				object-fit: contain;
			}

			.avatar-card__text {
				font-size: 11px;
				font-weight: 900;
				color: #fff;
				white-space: nowrap;
				transform: translateY(2px);
			}

			@media (max-width: 600px) {
				.avatar-card {
					width: 78px;
					height: 54px;
					padding: 4px;
				}
				.avatar-card__img {
					width: 24px;
					height: 32px;
				}
				.avatar-card__text {
					font-size: 9.5px;
				}
			}

			.list-stat {
				display: flex;
				flex-direction: column;
				gap: 18px;
				max-width: 100px;
				width: 100%;
			}

			.list-stat-link {
				position: relative;
				display: flex;
				align-items: center;
				justify-content: space-between;
				border-radius: 10px;
				width: 100%;
				height: 100%;
				padding: 4px 4px 4px 30px;
				background-color: var(--bg-block);
			}

			.list-stat-link__img {
				width: 14px;
			}

			.list-stat-link__img_first {
				position: absolute;
				top: 50%;
				left: -4px;
				width: 26px;
				transform: translateY(-50%);
			}
			.list-stat-link__text {
				font-size: 12px;
			}

			/* chips (camera & engine) */
			.rotate-chip,
			.mute-chip {
				display: inline-flex;
				align-items: center;
				justify-content: center;
				width: 28px;
				height: 28px;
				padding: 0;
				border-radius: 8px;
				background: #1f2a3a;
				/* hide any text completely */
				color: transparent;
				font-size: 0;
				line-height: 0;
				text-indent: -9999px;
				overflow: hidden;
				font-weight: 800;
				box-shadow: 0 1px 6px rgba(34, 43, 56, 0.18);
				white-space: nowrap;
			}
			/* icons inside chips via data-URIs */
			/* rotate: OFF (камера с перечёркиванием) */
			/* .rotate-chip {
	background-image: url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23fff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'>\
<path d='M3 8h4l2-2h6l2 2h4v10H3z'/>\
<circle cx='12' cy='13' r='3'/>\
<path d='M5 5L19 19'/>\
</svg>");
	background-repeat: no-repeat;
	background-position: center;
	background-size: 18px 18px;
} */

			/* rotate: ON (камера без перечёркивания) */
			/* .rotate-chip.active {
	background-color: #3498db;
	background-image: url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23fff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'>\
<path d='M3 8h4l2-2h6l2 2h4v10H3z'/>\
<circle cx='12' cy='13' r='3'/>\
</svg>");
	background-repeat: no-repeat;
	background-position: center;
	background-size: 18px 18px;
} */

			/* speaker on */
			/* .mute-chip {
	background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23fff'><path d='M3 9v6h4l5 4V5L7 9H3z'/><path d='M14 9.23v5.54c1.24-.59 2-1.86 2-3.23s-.76-2.64-2-3.23z' fill='%23fff'/></svg>");
	background-repeat: no-repeat;
	background-position: center;
	background-size: 16px 16px;
} */

			/* speaker muted (когда класс .off) */
			/* .mute-chip.off {
	background-color: #8b99b3;
	background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23fff'><path d='M3 9v6h4l5 4V5L7 9H3z'/><path d='M16.5 8.5l4 4m0-4l-4 4' stroke='%23fff' stroke-width='2' fill='none' stroke-linecap='round'/></svg>");
	background-repeat: no-repeat;
	background-position: center;
	background-size: 16px 16px;
} */

			/* ===== VOTES BAR ===== */
			.votes-top {
				margin-top: 6px;
			}
			.votes-bar {
				display: flex;
				align-items: center;
				justify-content: center;
				flex-wrap: wrap;
				gap: 6px;
				border: 2px solid var(--bg-border-color);
				border-radius: 10px;
				margin: 0 auto;
				padding: 10px;
				max-width: 255px;
				min-height: 36px;
				color: var(--white-color);
				background-color: rgba(21, 40, 61, 0.7);
				overflow: hidden;
			}
			.votes-bar__title {
				font-weight: 900;
				font-size: 12px;
				text-transform: uppercase;
			}
			.votes-bar__list {
				display: flex;
				align-items: center;
				gap: 6px;
			}

			.vcount {
				font-weight: 600;
				font-size: 12px;
			}

			.vcount__wrap {
				display: flex;
				align-items: center;
				gap: 4px;
			}

			.vcount__wrap:not(:last-child) {
				padding-right: 7px;
				border-right: 1px solid #2c3554;
			}

			.votes-bar__wrap-bottom {
				display: flex;
				flex-direction: column;
				align-items: center;
				gap: 6px;
			}

			/* NEW: participants label */
			.votes-bar__participants {
				font-weight: 900;
				font-size: 12px;
				/* margin-left: 8px; */
				white-space: nowrap;
			}

			.votes-bar__participants-icon {
				width: 12px;
				height: 12px;
			}

			/* ===== CITY ROW + TIMER CHIP ===== */
			.timer-chip {
				display: inline-flex !important;
				align-items: center;
				gap: 8px;
				/* padding: 6px 16px; */
				border-radius: 14px;
				/* background: #b431ff !important; */
				color: #fff;
				/* font-size: 18px; */
				font-size: 12px;
				font-weight: 900;
				min-width: 105px;
				justify-content: center;
				/* box-shadow: 0 1px 8px rgba(34, 43, 56, 0.14); */
				white-space: nowrap;
				z-index: 99;
			}
			/* .city-row { */
			/* background: rgba(24, 0, 42, 0.47) !important;
	border-radius: 18px !important;
	padding: 6px 12px !important;
	gap: 16px !important; */
			/* } */
			.champions-row {
				margin-top: 4px;
				display: flex;
				align-items: center;
				justify-content: flex-start;
				gap: 10px;
				padding-top: 4px;
				border-top: 1px solid rgba(0, 0, 0, 0.08);
				width: 100%;
			}

			.champions-row {
				margin-top: 4px;
				display: flex;
				align-items: center;
				justify-content: flex-start;
				gap: 10px;
				padding-top: 4px;
				border-top: 1px solid rgba(0, 0, 0, 0.08);
				width: 100%;
			}

			/* НОВАЯ КОЛОНКА СЛЕВА, НАД КНОПКОЙ КАРТЫ */
			.champions-column {
				position: absolute;
				left: 10px; /* прижали к левому краю */
				bottom: 330px; /* подстрой: больше число = выше, меньше = ближе к кнопке карты */
				z-index: 9;
				display: flex;
				flex-direction: column;
				align-items: flex-start;
			}

			.champions-label {
				font-weight: 900;
				font-size: 11px;
				text-transform: uppercase;
				letter-spacing: 0.5px;
				color: #000;
				white-space: nowrap;
				margin-bottom: 4px;
				margin-left: -3px; /* shift label slightly to the left */
			}

			.champions-list {
				display: flex;
				flex-direction: column; /* вертикально */
				gap: 6px;
				align-items: flex-start;
			}

			.champion-card {
				display: flex;
				flex-direction: column;
				align-items: flex-start; /* выравниваем по левому краю */
				min-width: 46px;
			}

			.champion-avatar {
				width: 32px;
				height: 32px;
				border-radius: 50%;
				object-fit: cover;
				border: 2px solid #ffe028;
				background: #0003;
				box-shadow: 0 2px 8px rgba(0, 0, 0, 0.35);
			}

			.champion-name {
				margin-top: 2px;
				font-size: 9px;
				max-width: 52px;
				text-align: center;
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
				opacity: 0.9;
			}

			/* ===== INFO ===== */
			/* .main-content-bottom__info { */
			/* font-weight: 900;
	font-size: 15px; */
			/*color: #7a3cff; */ /* было var(--gold-color) */
			/* margin: 4px 0 2px 2px; */
			/* } */

			.main-content-bottom__info {
				font-weight: 900;
				font-size: 12px;
				/* margin: 4px 0 2px 2px; */
			}

			/* ===== CONTROL ARROWS ===== */
			.control-arrows {
				position: absolute;
				left: 50%;
				bottom: 230px;
				transform: translateX(-50%);
				width: 220px;
				height: 120px;
				display: flex;
				align-items: flex-end;
				justify-content: center;
				pointer-events: none;
				z-index: 20;
			}

			.control-arrows__btn {
				position: absolute;
				width: 34px;
				height: 34px;
				background-image: url('arrow-white.png');
				background-position: center;
				background-repeat: no-repeat;
				background-size: contain;
				pointer-events: auto;
				/* темнее и чуть более жирная тень */
				filter: drop-shadow(0 2px 6px rgba(0, 0, 0, 0.7)) brightness(0.6);
				opacity: 1;
				transition: filter 0.18s, opacity 0.18s;
			}

			.control-arrows__btn.left {
				left: 50%;
				bottom: 18px;
				transform: translateX(-120%) rotate(180deg); /* сместили влево, но база одна */
			}

			.control-arrows__btn.up {
				left: 50%;
				bottom: 36px; /* чуть выше нижней */
				transform: translateX(-50%) rotate(-90deg);
			}

			.control-arrows__btn.right {
				left: 50%;
				bottom: 18px;
				transform: translateX(20%) rotate(0deg); /* симметрично вправо от общей базы */
			}

			.control-arrows__btn.down {
				left: 50%;
				bottom: -4px;
				transform: translateX(-50%) rotate(90deg);
			}
			.control-arrows__hint {
				position: absolute;
				bottom: -26px;
				left: 50%;
				transform: translateX(-50%);
				font-weight: 900;
				font-size: 11px;
				color: #fff;
				text-transform: uppercase;
				white-space: nowrap;
			}

			/* ===== FOOTER ===== */
			.footer::after {
				content: '';
				position: absolute;
				bottom: 0;
				left: 0;
				z-index: 0;
				width: 100%;
				min-height: 202px;
				background-image: url('footer-bg-img.png');
				background-repeat: no-repeat;
				background-position: center;
			}
			.footer__container {
				position: relative;
				display: flex;
				flex-direction: column;
				padding-bottom: 8px;
				min-height: 188px;
				overflow: visible;
			}
			.footer__layer {
				position: relative;
				display: flex;
				align-items: center;
				justify-content: space-between;
			}
			.footer__layer_first {
				height: 78px;
			}
			.footer__layer_first .footer__layer-left {
				display: flex;
				justify-content: flex-end;
				max-width: 95px;
				width: 100%;
			}

			.footer__layer-right {
				display: flex;
				flex-direction: column;
				align-items: center;
				padding-right: 18px;
			}
			.footer__layer-right .items-list_first {
				padding-right: 18px;
			}
			.items-list {
				display: flex;
				gap: 4px;
			}
			.footer-btn-radio {
				display: flex;
				flex-direction: column;
				align-items: center;
				justify-content: center;
				border-radius: 100px;
				padding: 4px;
				font-weight: 700;
				font-size: 13px;
				color: #fff;
				max-width: 95px;
				width: 100%;
				background-color: #0086f1;

				/* iOS anti-flicker */
				-webkit-backface-visibility: hidden;
				backface-visibility: hidden;
				-webkit-transform: translateZ(0);
				transform: translateZ(0);
				will-change: transform;
			}
			.footer__layer_first .footer-btn-radio {
				position: absolute;
				top: 46px;
				left: 50%;
				z-index: 100;
				transform: translateX(-50%);
			}
			.footer-btn-radio__title {
				text-transform: uppercase;
			}

			/* iOS: keep footer stable over Street View */
			.footer,
			.footer__container {
				-webkit-backface-visibility: hidden;
				backface-visibility: hidden;
				-webkit-transform: translateZ(0);
				transform: translateZ(0);
				will-change: transform;
			}

			.footer__layer_third {
				margin: 0 auto;
				max-width: 310px;
				width: 100%;
				position: relative;
				z-index: 4;
			}
			.footer__layer_third .footer__layer-dashboard {
				padding-top: 6px;
				padding-left: 10px;
			}
			.footer__layer-dashboard-img {
				display: block;
				width: 100%;
				height: auto;
			}
			.items-list_stickers {
				flex-direction: row-reverse;
			}
			.items-list_stickers .items-list__item:nth-child(1) {
				padding-top: 4px;
			}
			.items-list_stickers .items-list__item:nth-child(2) {
				padding-top: 10px;
			}
			.items-list_stickers .items-list__item:nth-child(3) {
				padding-top: 24px;
			}
			.footer__menu-wrap {
				display: flex;
				justify-content: space-between;
				padding-top: 16px;
				position: relative;
				z-index: 5;
			}
			.footer__menu-list {
				display: flex;
				gap: 24px;
			}
			.footer-menu-link {
				display: flex;
				width: 42px;
				height: 42px;
				background-position: center;
				background-size: contain;
				background-repeat: no-repeat;
			}

			.footer-menu-link_new {
				width: 44px;
			}

			.footer__img-wheel-wrap {
				position: absolute;
				bottom: -29%;
				left: 50%;
				width: 151px;
				height: 151px;
				transform: translateX(-50%);
				z-index: 6;
			}
			.footer__img-wheel {
				display: block;
				width: 100%;
				height: 100%;
				transition: transform 0.35s ease;
				transform-origin: center;
			}

			/* horn hit area */
			#hornBtn {
				position: absolute;
				left: 50%;
				top: 50%;
				transform: translate(-50%, -50%);
				width: 64px;
				height: 64px;
				border-radius: 50%;
				background: transparent;
				border: none;
				cursor: pointer;
			}
			#hornBtn:active {
				transform: translate(-50%, -50%) scale(0.96);
			}

			/* Map & SOS */
			#btnMap {
				position: absolute;
				left: 10px;
				bottom: 232px;
				z-index: 7;
				width: 64px;
				height: 64px;
				background-image: url('gamepad.png');
				background-position: center;
				background-repeat: no-repeat;
				background-size: contain;
				cursor: pointer;
			}
			.sos-toggle {
				margin-top: 6px;
				padding: 0 12px;
				height: 30px;
				border-radius: 15px;
				background: #ff0055;
				color: #fff;
				font-size: 12px;
				font-weight: 800;
				border: 0;
				box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
				cursor: pointer;
				opacity: 0;
				pointer-events: none;
				transition: opacity 0.2s ease;
			}

			.sos-toggle.visible {
				opacity: 1;
				pointer-events: auto;
			}

			/* Back from Google/SOS to TonRoad */
			.sos-back-tonroad {
				position: fixed;
				top: 20px;
				left: 20px;
				padding: 4px 12px;
				border-radius: 16px;
				background: #111;
				color: #fff;
				font-size: 12px;
				font-weight: 700;
				border: 0;
				box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
				z-index: 2147483647;
				display: none;
			}

			/* ONLINE DROPDOWN */
			#onlineUsersPanel {
				position: absolute;
				top: 64px;
				right: 12px;
				width: 210px;
				max-height: 54vh;
				overflow-y: auto;
				background: rgba(0, 0, 0, 0.82);
				backdrop-filter: blur(3px);
				color: #fff;
				border-radius: 10px;
				padding: 6px 10px;
				font-size: 13px;
				z-index: 10;
				display: none;
				box-shadow: 0 6px 24px rgba(0, 0, 0, 0.19);
			}
			#onlineUsersPanel.active {
				display: block;
			}
			.users-header {
				background: #212e3e;
				padding: 5px 10px;
				font-weight: 900;
				border-bottom: 1px solid #24395a;
				letter-spacing: 0.4px;
				font-size: 13px;
				border-radius: 8px;
			}
			.user-row {
				display: flex;
				align-items: center;
				gap: 6px;
				margin: 6px 0 2px;
				padding: 1px 0;
				border-radius: 7px;
				font-size: 13px;
			}
			.user-row .avatar {
				width: 21px;
				height: 21px;
				border-radius: 100px;
				object-fit: cover;
				background: #fff2;
			}
			.user-row .username {
				font-weight: 900;
				color: #19e074;
				font-size: 13px;
				text-shadow: 0 1px 2px #0006;
			}
			.user-row .userid {
				font-size: 10px;
				color: #6bb0c7;
				margin-left: 2px;
			}
			.user-row .clicks {
				font-size: 11px;
			}

			/* Vertical controls */
			.header__controls-vertical {
				display: flex;
				flex-direction: column;
				align-items: flex-start;
				gap: 10px;
			}
			.header__controls-vertical .mute-chip,
			.header__controls-vertical .rotate-chip {
				width: 28px;
				height: 28px;
				padding: 0;
				flex: 0 0 28px;
			}

			/* ===== Speed overlay hit area (around speed gauge, left of wheel) ===== */
			.speedctrl-btn {
				position: absolute;
				left: 12px;
				bottom: 86px;
				width: 140px;
				height: 130px;
				z-index: 12;
				border: none;
				background: transparent;
				cursor: pointer;
			}

			@media (max-height: 680px) {
				.speedctrl-btn {
					bottom: 76px;
					height: 120px;
				}
			}
			/* ===== HUD TOP MENU (drawer) ===== */
			/*.menu-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:4000}
.menu-drawer{position:fixed;top:0;right:-80%;height:100%;width:min(80%,360px);background:#0f1725;box-shadow:-10px 0 30px rgba(0,0,0,.35);transition:right .25s ease;z-index:4001;display:flex;flex-direction:column}
.menu-drawer.open{right:0}*/
			.city-overlay {
				position: fixed;
				inset: 0;
				background: rgba(0, 0, 0, 0.45);
				display: none;
				z-index: 3500;
			}
			.city-drawer {
				position: fixed;
				top: 0;
				left: -80%;
				height: 100%;
				width: min(320px, 80%);
				background: #050816;
				border-right: 1px solid #1f2a3a;
				transition: left 0.25s ease;
				z-index: 3501;
				display: flex;
				flex-direction: column;
			}
			.city-drawer.open {
				left: 0;
			}
			.city-header {
				display: flex;
				align-items: center;
				justify-content: space-between;
				padding: 14px;
				border-bottom: 1px solid #1f2a3a;
				font-weight: 700;
				font-size: 16px;
			}
			.city-close {
				background: transparent;
				border: none;
				color: #fff;
				font-size: 14px;
				cursor: pointer;
			}
			.city-list {
				list-style: none;
				margin: 0;
				padding: 12px;
				overflow-y: auto;
			}
			.city-item {
				width: 100%;
				text-align: left;
				padding: 10px 12px;
				margin-bottom: 6px;
				border-radius: 10px;
				border: none;
				background: #111827;
				color: #fff;
				font-size: 15px;
				font-weight: 600;
				cursor: pointer;
			}
			.city-item.locked {
				opacity: 0.4;
			}
			.city-item.active {
				background: #b431ff;
			}

			/* .city-chip {
	display: inline-flex;
	align-items: center;
	gap: 8px;
	padding: 6px 16px;
	border-radius: 14px;
	background: rgba(24, 0, 42, 0.8);
	color: #fff;
	font-size: 16px;
	font-weight: 700;
	cursor: pointer;
	white-space: nowrap;
} */
			.city-chip {
				position: relative;
				z-index: 2;
				font-weight: 900;
				font-size: 16px;
				text-transform: uppercase;
				white-space: nowrap;
				cursor: pointer;
			}

			.menu-header {
				display: flex;
				align-items: center;
				gap: 10px;
				padding: 14px;
				border-bottom: 1px solid #1f2a3a;
				font-weight: 900;
				color: #fff;
			}
			.menu-close {
				margin-left: auto;
				background: #26344f;
				color: #fff;
				border: none;
				border-radius: 10px;
				padding: 6px 10px;
				cursor: pointer;
				font-weight: 900;
			}
			.menu-list {
				list-style: none;
				margin: 0;
				padding: 10px;
				display: flex;
				flex-direction: column;
				gap: 8px;
			}
			.menu-item {
				display: flex;
				align-items: center;
				gap: 10px;
				padding: 10px 12px;
				background: #121e30;
				border-radius: 10px;
				cursor: pointer;
				text-decoration: none;
				color: #fff;
			}
			.menu-item:hover {
				background: #1b2a42;
			}
			.menu-item .tag {
				margin-left: auto;
				color: #9ab;
				font-size: 12px;
			}
			/* ===== COIN ===== */
			#coinLayer {
				position: absolute;
				inset: 0;
				z-index: 8; /* above street view, below arrows (z=20) */
				pointer-events: none; /* clicks only on coin itself */
			}
			.coin {
				position: absolute;
				width: 54px;
				height: 54px;
				pointer-events: auto;
				user-select: none;
				will-change: transform, opacity;
				transition: transform 0.15s ease, opacity 0.15s ease;
				animation: coinFloat 1.5s ease-in-out infinite;
			}
			.coin:active {
				transform: scale(0.9);
			}
			@keyframes coinFloat {
				0% {
					transform: translateY(0);
				}
				50% {
					transform: translateY(-6px);
				}
				100% {
					transform: translateY(0);
				}
			}

			/* ===== ЯРКИЕ СТРЕЛКИ (добавлено) ===== */
			.control-arrows__btn {
				filter: drop-shadow(0 3px 16px #00e0ff77) brightness(1.18);
				opacity: 1;
				transition: filter 0.18s, opacity 0.18s;
			}
			.control-arrows__btn:hover {
				filter: drop-shadow(0 6px 26px #ffe028cc) brightness(1.38);
				opacity: 1;
			}
			.control-arrows__btn[style*='opacity: 0.12'] {
				filter: grayscale(100%) brightness(0.7)
					drop-shadow(0 2px 10px #00171655);
				opacity: 0.12 !important;
			}
			/* Живой пульс стрелки */
			@keyframes arrowPulse {
				0%,
				100% {
					filter: drop-shadow(0 3px 16px #00e0ff77) brightness(1.18);
				}
				50% {
					filter: drop-shadow(0 8px 32px #ffe028bb) brightness(1.38);
				}
			}
			.control-arrows__btn:not([style*='opacity: 0.12']) {
				animation: arrowPulse 2s infinite;
			}

			.city-row {
				position: relative;
				z-index: 4;
				display: flex;
				justify-content: center;
				align-items: center;
				gap: 16px;
				border-radius: 6px;
				margin: 0 auto;
				margin-top: 80px;
				padding: 6px 12px;
				max-width: 255px;
				min-width: 185px;
				width: 100%;
				min-height: 44px;
				background-color: var(--bg-border-color);
				pointer-events: auto;
			}

			.city-row::after {
				content: '';
				position: absolute;
				z-index: 1;
				top: 2px;
				left: 2px;
				border: 2px solid var(--white-color);
				border-radius: 4px;
				width: calc(100% - 4px);
				height: calc(100% - 4px);
			}
			/* .city-row {
	position: relative;
	z-index: 4;
	margin-top: 6px !important;
	display: flex;
	justify-content: center;
	align-items: center;
	gap: 16px;
	border-radius: 18px;
	margin-top: 6px;
	padding: 6px 12px;
	width: 100%;
	background: rgba(24, 0, 42, 0.47);
	pointer-events: auto;
} */

			/* >>> OVERRIDE: двигаем ТОЛЬКО группу стикеров в правой колонке (под машинкой) <<< */
			.footer__layer_first
				.footer__layer-right
				> .items-list:not(.items-list_first) {
				margin-top: 6px; /* ниже/выше относительно машинки */
				transform: translate(
					-12px,
					25px
				); /* X: -левее/+правее, Y: +ниже/-выше */
				/* при жёстком кэше можно временно добавить !important */
				/* transform: translate(-12px, 10px) !important; */
			}
			/* Двигаем кактус чуть левее, машинку чуть правее */
			.footer__layer_first .footer__layer-left .items-list {
				transform: translateX(-8px); /* - = левее, можно подправить число */
			}

			.footer__layer_first .footer__layer-right .items-list_first {
				transform: translateX(8px); /* + = правее */
			}

			/* iOS: prevent RADIO button from blinking / highlighting */
			.footer-btn-radio,
			.footer-btn-radio:focus,
			.footer-btn-radio:active {
				outline: none;
				-webkit-tap-highlight-color: transparent;
				animation: none !important;
				transition: none !important;
			}
			.chat-photo {
				width: 100%;
				max-width: 100%;
				margin-top: 2px;
				border-radius: 8px;

				/* даём блоку реальную высоту под фон */
				aspect-ratio: 4 / 3;
				max-height: 60vh;

				background-size: cover;
				background-repeat: no-repeat;
				background-position: center center;

				-webkit-touch-callout: none;
				-webkit-user-select: none;
				user-select: none;
			}

			.mapsConsumerUiSceneCoreScenecommon__impressCanvas {
				display: none;
			}
			.mapsConsumerUiSceneCoreScenecommon__activated.mapsConsumerUiSceneCoreScenecommon__impressCanvas {
				display: block;
			}
			.mapsConsumerUiSceneCoreScenecommon__impressIndicator {
				position: absolute;
				visibility: hidden;
			}
			.mapsConsumerUiSceneCoreScenecommon__activated.mapsConsumerUiSceneCoreScenecommon__impressCanvas
				+ .mapsConsumerUiSceneCoreScenecommon__impressIndicator {
				visibility: inherit;
				top: 50%;
				left: 25px;
				width: 10px;
				height: 10px;
				background-color: #188038;
			}
			.mapsConsumerLibAppPrint__printMode
				.mapsConsumerUiSceneCoreScenecommon__noprint,
			.mapsConsumerLibAppPrint__printMode
				.mapsConsumerUiSceneCoreScenecommon__impressIndicator,
			.mapsConsumerUiSceneCoreScenecommon__impressHidden,
			.mapsConsumerUiSceneCoreScenecommon__impressIndicator.mapsConsumerUiSceneCoreScenecommon__impressHidden,
			.mapsConsumerUiSceneCoreScenecommon__impressCanvas.mapsConsumerUiSceneCoreScenecommon__impressHidden {
				display: none;
			}
			.mapsConsumerUiSceneCoreScene__root {
				width: 100%;
				height: 100%;
				overflow: hidden;
				position: absolute;
				z-index: 0;
				background-color: #000;
			}
			.mapsConsumerLibAppKeynav__on
				.mapsConsumerUiSceneCoreScene__root:focus
				.mapsConsumerUiSceneCoreScene__focusOutline,
			.mapsConsumerUiSceneCoreScene__root:focus-visible
				.mapsConsumerUiSceneCoreScene__focusOutline {
				border: 2px solid #1a73e8;
				-webkit-box-sizing: border-box;
				box-sizing: border-box;
				height: 100%;
				pointer-events: none;
				position: absolute;
				width: 100%;
				z-index: 1;
			}
			.mapsConsumerLibAppPrint__printMode
				.mapsConsumerUiSceneCoreScene__root:focus
				.mapsConsumerUiSceneCoreScene__focusOutline {
				display: none;
			}
			.mapsConsumerUiSceneCoreScene__effects {
				position: absolute;
				left: 0;
				top: 0;
				z-index: 2;
			}
			.mapsConsumerUiSceneCoreScene__imageryRender {
				position: absolute;
				left: 0;
				top: 0;
				z-index: 1;
				background-color: #000;
			}
			.mapsConsumerUiSceneCoreScene__root .widget-scene-imagery-iframe {
				position: absolute;
			}
			.mapsConsumerUiSceneCoreScene__root
				.mapsVectortownJsRenderCanvasCanvasrenderer__canvasRenderer {
				left: 0;
				top: 0;
			}
			.mapsConsumerUiSceneCoreScene__canvas {
				background-color: #000;
				left: 0;
				outline: none;
				position: absolute;
				top: 0;
			}
			.mapsConsumerUiSceneCoreScene__captureCanvas {
				position: relative;
				z-index: 3;
			}
			.mapsConsumerUiSceneCoreScene__tileImage3d {
				-webkit-backface-visibility: hidden;
				backface-visibility: hidden;
			}
			.mapsConsumerLibAppPrint__printMode
				.mapsConsumerUiSceneCoreScene__captureCanvas {
				width: 100%;
				height: auto;
				-webkit-transform: none;
				-ms-transform: none;
				transform: none;
			}
			.mapsConsumerLibAppPrint__printMode .mapsConsumerUiSceneCoreScene__root {
				background: #fff;
				position: static;
				overflow: visible;
			}
			.mapsConsumerLibAppPrint__printMode
				.mapsConsumerUiSceneCoreScene__canvas {
				display: block;
				background: #fff;
			}
			.mapsConsumerLibAppPrint__printMode
				.mapsConsumerUiSceneCoreScene__canvas.mapsConsumerUiSceneCoreScenecommon__noprint {
				display: none;
			}
			.mapsConsumerLibAppPrint__printMode
				.app-globe-mode
				.mapsConsumerUiSceneCoreScene__canvas {
				background-color: #000;
			}
			.mapsConsumerLibAppPrint__printMode
				.mapsConsumerUiSceneCoreScene__imageryRender {
				position: relative;
				background: #fff;
				z-index: 4;
			}
			.mapsConsumerLibAppPrint__printMode
				.mapsConsumerUiSceneCoreScene__root
				.widget-scene-imagery-iframe {
				position: relative;
			}
			@media print {
				.mapsConsumerLibAppPrint__printMode
					.mapsConsumerUiSceneCoreScene__root
					.widget-scene-imagery-iframe {
					left: 50%;
					-webkit-transform: translateX(-50%);
					-ms-transform: translateX(-50%);
					transform: translateX(-50%);
				}
			}
			.mapsConsumerLibAppPrint__printMode
				.mapsConsumerUiSceneCoreScene__root
				.mapsVectortownJsRenderCanvasCanvasrenderer__canvasRenderer,
			.mapsConsumerLibAppPrint__printMode
				.mapsConsumerUiSceneCoreScene__root
				.mapsVectortownJsRenderCanvasCanvasrenderer__canvasContainer,
			.mapsConsumerLibAppPrint__printMode
				.mapsConsumerUiSceneCoreScene__root
				.mapsVectortownJsRenderCanvasCanvasrenderer__canvas,
			.mapsConsumerLibAppPrint__printMode
				.mapsConsumerUiSceneCoreScene__root
				.mapsConsumerUiSceneCoreScene__canvas {
				position: static;
			}
			.mapsConsumerLibAppPrint__printMode
				.mapsConsumerUiSceneCoreScene__captureCanvas
				~ .mapsConsumerUiSceneCoreScene__canvas,
			.mapsConsumerLibAppPrint__printMode
				.mapsConsumerUiSceneCoreScene__captureCanvas
				~ .mapsVectortownJsRenderCanvasCanvasrenderer__canvasRenderer {
				display: none;
			}
			sentinel {
			}

			/* media phone */
			@media (max-width: 375px) {
				.list-stat {
					max-width: 80px;
				}

				.footer__menu-list {
					gap: 6px;
				}

				.footer__layer_first .footer__layer-left {
					max-width: 60px;
				}

				.footer__layer-right {
					padding-right: 0;
				}

				.footer__img-wheel-wrap {
					bottom: -16%;
					width: 124px;
					height: 124px;
				}
			}
			/* end media phone */
		</style>
		<!-- scripts -->
		<script src="/api/keys.js"></script>
		<script
			src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLtao0F3Xm136OwD-LFglwhpBdOB6sht8&amp;callback=initApp"
			async=""
			defer=""
		></script>
		<script
			type="text/javascript"
			charset="UTF-8"
			src="https://maps.googleapis.com/maps-api-v3/api/js/63/1b/intl/ru_ALL/common.js"
		></script>
		<script
			type="text/javascript"
			charset="UTF-8"
			src="https://maps.googleapis.com/maps-api-v3/api/js/63/1b/intl/ru_ALL/util.js"
		></script>
		<script
			type="text/javascript"
			charset="UTF-8"
			src="https://maps.googleapis.com/maps-api-v3/api/js/63/1b/intl/ru_ALL/geometry.js"
		></script>
		<script
			type="text/javascript"
			charset="UTF-8"
			src="https://maps.googleapis.com/maps-api-v3/api/js/63/1b/intl/ru_ALL/streetview.js"
		></script>
		<script
			type="text/javascript"
			charset="UTF-8"
			src="https://maps.googleapis.com/maps-api-v3/api/js/63/1b/intl/ru_ALL/log.js"
		></script>
		<script
			type="text/javascript"
			charset="UTF-8"
			src="https://maps.googleapis.com/maps-api-v3/api/js/63/1b/intl/ru_ALL/imagery_viewer.js"
		></script>
		<script
			type="text/javascript"
			charset="UTF-8"
			src="https://maps.googleapis.com/maps-api-v3/api/js/63/1b/intl/ru_ALL/controls.js"
		></script>
		<script
			type="text/javascript"
			charset="UTF-8"
			src="https://maps.googleapis.com/maps-api-v3/api/js/63/1b/intl/ru_ALL/map.js"
		></script>
		<script
			type="text/javascript"
			charset="UTF-8"
			src="https://maps.googleapis.com/maps-api-v3/api/js/63/1b/intl/ru_ALL/poly.js"
		></script>
		<script
			type="text/javascript"
			charset="UTF-8"
			src="https://maps.googleapis.com/maps-api-v3/api/js/63/1b/intl/ru_ALL/marker.js"
		></script>
	</head>

	<body jstcache="0">
		<div class="app-viewport" jstcache="0">
			<div class="app ready" jstcache="0">
				<!-- Google layer -->
				<div class="app__bg" jstcache="0">
					<div
						id="street-view"
						style="background-color: rgb(229, 227, 223); overflow: hidden"
						jstcache="0"
					>
						<div
							class="gm-style"
							style="
								position: absolute;
								z-index: 1;
								left: 0px;
								top: 0px;
								height: 100%;
								width: 100%;
								padding: 0px;
								border-width: 0px;
								margin: 0px;
							"
							jstcache="0"
						>
							<div>
								<button
									draggable="false"
									aria-label="Быстрые клавиши"
									title="Быстрые клавиши"
									type="button"
									style="
										background: none transparent;
										display: block;
										border: none;
										margin: 0px;
										padding: 0px;
										text-transform: none;
										appearance: none;
										position: absolute;
										cursor: pointer;
										user-select: none;
										z-index: 1000002;
										outline-offset: 3px;
										right: 0px;
										bottom: 0px;
										transform: translateX(100%);
									"
								></button>
							</div>
							<div
								tabindex="-1"
								aria-label="Карта"
								aria-roledescription="карта"
								role="region"
								style="
									position: absolute;
									z-index: 0;
									left: 0px;
									top: 0px;
									height: 100%;
									width: 100%;
									padding: 0px;
									border-width: 0px;
									margin: 0px;
									background-color: rgb(229, 227, 223);
								"
							>
								<div
									style="
										z-index: 1;
										position: absolute;
										top: 0px;
										left: 0px;
										width: 100%;
										height: 100%;
										touch-action: none;
									"
								>
									<div
										style="
											position: absolute;
											left: 0px;
											top: 0px;
											z-index: 100;
											width: 100%;
										"
									></div>
									<div
										style="
											position: absolute;
											left: 0px;
											top: 0px;
											z-index: 101;
											width: 100%;
										"
									></div>
									<div
										style="
											position: absolute;
											left: 0px;
											top: 0px;
											z-index: 102;
											width: 100%;
										"
									></div>
									<div
										style="
											position: absolute;
											left: 0px;
											top: 0px;
											z-index: 103;
											width: 100%;
										"
									></div>
									<div
										style="
											position: absolute;
											left: 0px;
											top: 0px;
											z-index: 104;
											width: 100%;
										"
									></div>
									<div
										style="
											position: absolute;
											left: 0px;
											top: 0px;
											z-index: 105;
											width: 100%;
										"
									></div>
									<div
										style="
											position: absolute;
											left: 0px;
											top: 0px;
											z-index: 106;
											width: 100%;
										"
									>
										<slot></slot>
									</div>
									<div
										style="
											position: absolute;
											left: 0px;
											top: 0px;
											z-index: 107;
											width: 100%;
										"
									></div>
									<div style="height: 100%; width: 100%">
										<div style="width: 422px; height: 760px">
											<div
												jstcache="9"
												aria-describedby="C1A741F4-666E-4CDB-90F5-F3D3D2559408"
												aria-label="Street View"
												role="region"
												tabindex="0"
												jsaction="click: scene.viewport;dblclick: scene.viewport;mousedown: scene.viewport;mousemove: scene.viewport;mouseup: scene.viewport;mouseover: scene.viewport;mouseout: scene.viewport;touchstart: scene.viewport;touchmove: scene.viewport;touchend: scene.viewport;pointerdown: scene.viewport;pointermove: scene.viewport;pointerup: scene.viewport;pointercancel: scene.viewport;MSPointerDown: scene.viewport;MSPointerMove: scene.viewport;MSPointerUp: scene.viewport;MSPointerCancel: scene.viewport;contextmenu: scene.viewport;keydown: scene.viewport;keyup: scene.viewport;wheel: scene.viewport;mousewheel: scene.viewport;DOMMouseScroll: scene.viewport;"
												class="mapsConsumerUiSceneCoreScene__root widget-scene"
												jsan="t-LwGJzSuYg8g,7.mapsConsumerUiSceneCoreScene__root,7.widget-scene,0.aria-describedby,0.aria-label,0.role,5.cursor,0.tabindex,0.jsaction"
												style="cursor: pointer"
											>
												<canvas
													width="422"
													height="760"
													id=""
													class="mapsConsumerUiSceneCoreScene__canvas widget-scene-canvas"
													style="width: 422px; height: 760px"
												></canvas>
												<canvas
													jstcache="2"
													class="mapsConsumerUiSceneCoreScene__canvas widget-scene-canvas mapsConsumerUiSceneCoreScenecommon__impressCanvas mapsConsumerUiSceneCoreScenecommon__noprint mapsConsumerUiSceneCoreScenecommon__impressHidden"
													jsan="7.mapsConsumerUiSceneCoreScene__canvas,7.widget-scene-canvas,7.mapsConsumerUiSceneCoreScenecommon__impressCanvas,7.mapsConsumerUiSceneCoreScenecommon__noprint,7.mapsConsumerUiSceneCoreScenecommon__impressHidden"
												></canvas>
												<canvas
													jstcache="3"
													class="mapsConsumerUiSceneCoreScene__canvas widget-scene-canvas mapsConsumerUiSceneCoreScenecommon__impressCanvas mapsConsumerUiSceneCoreScenecommon__noprint mapsConsumerUiSceneCoreScenecommon__impressHidden"
													jsan="7.mapsConsumerUiSceneCoreScene__canvas,7.widget-scene-canvas,7.mapsConsumerUiSceneCoreScenecommon__impressCanvas,7.mapsConsumerUiSceneCoreScenecommon__noprint,7.mapsConsumerUiSceneCoreScenecommon__impressHidden"
												></canvas>
												<div
													jstcache="4"
													class="mapsConsumerUiSceneCoreScenecommon__impressIndicator mapsConsumerUiSceneCoreScenecommon__impressHidden"
													jsan="7.mapsConsumerUiSceneCoreScenecommon__impressIndicator,7.mapsConsumerUiSceneCoreScenecommon__impressHidden"
												></div>
												<div
													id=""
													class="mapsConsumerUiSceneCoreScene__imageryRender widget-scene-imagery-render"
													style="width: 0px; height: 0px; display: none"
												></div>
												<div
													class="mapsConsumerUiSceneCoreScene__effects mapsConsumerLibAppPrint__noprint"
												></div>
												<div
													class="mapsConsumerUiSceneCoreScene__focusOutline"
												></div>
											</div>
										</div>
									</div>
									<div
										class="gmnoprint SLHIdE-sv-links-control"
										style="
											position: absolute;
											left: 0px;
											top: 0px;
											z-index: 2;
											font-family: Roboto, Arial, sans-serif;
										"
									>
										<svg
											version="1.1"
											width="422px"
											height="760px"
											viewBox="0 0 422 760"
											style="
												position: absolute;
												left: 0px;
												top: 0px;
												pointer-events: none;
											"
										>
											<path
												fill="black"
												fill-rule="evenodd"
												fill-opacity="0.5"
												stroke="none"
												d="M 0 -100 L 40 -60 L 30 -50 L 0 -82 L -30 -50 L -40 -60"
												transform="translate(211 599.3931022920577) scale(1 0.31698729810778065) rotate(301.16446) "
												style="pointer-events: all"
											></path>
											<path
												fill="white"
												fill-rule="evenodd"
												fill-opacity="1"
												stroke="none"
												d="M 0 -100 L 40 -60 L 30 -50 L 0 -82 L -30 -50 L -40 -60"
												transform="translate(211 596.3931022920577) scale(1 0.31698729810778065) rotate(301.16446) "
												style="pointer-events: all"
											></path>
											<path
												fill="white"
												fill-rule="evenodd"
												fill-opacity="0"
												stroke="none"
												d="M 0 -120 L 60 -60 L 40 -30 L -40 -30 L -60 -60 L 0 -120"
												tabindex="0"
												aria-label="На северо-запад, ул. Советов"
												role="button"
												pano="NL7aAnFNX-DkR6rDCN5NZg"
												cursor="pointer"
												transform="translate(211 596.3931022920577) scale(1 0.31698729810778065) rotate(301.16446) "
												style="pointer-events: all"
											></path>
											<path
												fill="black"
												fill-rule="evenodd"
												fill-opacity="0.5"
												stroke="none"
												d="M 0 -100 L 40 -60 L 30 -50 L 0 -82 L -30 -50 L -40 -60"
												transform="translate(211 599.3931022920577) scale(1 0.31698729810778065) rotate(121.166176) "
												style="pointer-events: all"
											></path>
											<path
												fill="white"
												fill-rule="evenodd"
												fill-opacity="1"
												stroke="none"
												d="M 0 -100 L 40 -60 L 30 -50 L 0 -82 L -30 -50 L -40 -60"
												transform="translate(211 596.3931022920577) scale(1 0.31698729810778065) rotate(121.166176) "
												style="pointer-events: all"
											></path>
											<path
												fill="white"
												fill-rule="evenodd"
												fill-opacity="0"
												stroke="none"
												d="M 0 -120 L 60 -60 L 40 -30 L -40 -30 L -60 -60 L 0 -120"
												tabindex="0"
												aria-label="На восток, ул. Советов"
												role="button"
												pano="VoQQjNupSmWQWOTmNd6UOw"
												cursor="pointer"
												transform="translate(211 596.3931022920577) scale(1 0.31698729810778065) rotate(121.166176) "
												style="pointer-events: all"
											></path>
										</svg>
									</div>
								</div>
								<div
									class="LGLeeN-keyboard-shortcuts-view"
									id="C1A741F4-666E-4CDB-90F5-F3D3D2559408"
									style="display: none"
								>
									<table>
										<tbody>
											<tr>
												<td><kbd aria-label="Стрелка влево">←</kbd></td>
												<td aria-label="Переместить влево.">
													Переместить влево
												</td>
											</tr>
											<tr>
												<td><kbd aria-label="Стрелка вправо">→</kbd></td>
												<td aria-label="Переместить вправо.">
													Переместить вправо
												</td>
											</tr>
											<tr>
												<td><kbd aria-label="Стрелка вверх">↑</kbd></td>
												<td aria-label="Переместить вверх.">
													Переместить вверх
												</td>
											</tr>
											<tr>
												<td><kbd aria-label="Стрелка вниз">↓</kbd></td>
												<td aria-label="Переместить вниз.">Переместить вниз</td>
											</tr>
											<tr>
												<td><kbd>+</kbd></td>
												<td aria-label="Приблизить.">Приблизить</td>
											</tr>
											<tr>
												<td><kbd>-</kbd></td>
												<td aria-label="Уменьшить.">Уменьшить</td>
											</tr>
										</tbody>
									</table>
								</div>
							</div>
							<div class="exCVRN-size-observer-view" aria-hidden="true">
								<style>
									.exCVRN-size-observer-view {
										bottom: 0;
										left: 0;
										opacity: 0;
										position: absolute;
										right: 0;
										top: 0;
										z-index: -1;
									}
									.exCVRN-size-observer-view iframe {
										border: 0;
										height: 100%;
										left: 0;
										position: absolute;
										top: 0;
										width: 100%;
									}
								</style>
								<iframe src="about:blank" tabindex="-1"></iframe>
							</div>
							<div jstcache="0">
								<div
									dir="ltr"
									jstcache="0"
									style="
										z-index: 24601;
										position: absolute;
										display: none;
										left: 0px;
										top: 0px;
									"
								>
									<div jstcache="4" class="gm-iv-container">
										<button
											aria-label="Закрыть Просмотр улиц"
											title="Закрыть Просмотр улиц"
											type="button"
											jstcache="2"
											jsaction="closeControl.click"
											class="gm-iv-close"
										>
											<div
												jstcache="3"
												class="gm-iv-back"
												jsan="7.gm-iv-back"
											></div>
										</button>
									</div>
								</div>
								<div
									dir="ltr"
									style="display: none; position: absolute; left: 0px; top: 0px"
									jstcache="0"
								>
									<div jstcache="19" class="gm-iv-address">
										<div class="gm-iv-address-description">
											<div
												jstcache="6"
												class="gm-iv-short-address-description"
												jsan="7.gm-iv-short-address-description"
											>
												14 ул. Советов
											</div>
											<div
												jstcache="7"
												class="gm-iv-long-address-description"
												jsan="7.gm-iv-long-address-description"
											>
												Новороссийск, Краснодарский край
											</div>
											<div
												jstcache="8"
												class="gm-iv-profile-url gm-iv-hidden"
												jsan="7.gm-iv-profile-url,7.gm-iv-hidden"
											>
												<a target="_blank" jstcache="9" href="#">
													<div
														jstcache="10"
														class="gm-iv-profile-link"
														jsan="7.gm-iv-profile-link"
													>
														14 ул. Советов
													</div>
												</a>
											</div>
										</div>
										<div
											jstcache="11"
											jsaction="address.click"
											class="gm-iv-address-link"
											jsan="7.gm-iv-address-link,22.jsaction"
										>
											<a
												target="_blank"
												jstcache="12"
												href="https://www.google.com/maps/@44.724077,37.7675653,0a,45.2y,90t/data=!3m4!1e1!3m2!1slJVFuFcgQjYH-Ju38-4o3A!2e0?source=apiv3"
												jsan="8.href,0.target"
												>Посмотреть на Google Картах</a
											>
										</div>
										<div
											jstcache="13"
											class="gm-iv-address-custom gm-iv-hidden"
											jsan="7.gm-iv-address-custom,7.gm-iv-hidden"
										>
											<p>Custom Imagery</p>
										</div>
										<div
											jstcache="14"
											class="gm-iv-vertical-separator"
											jsan="7.gm-iv-vertical-separator"
										></div>
										<div
											jstcache="15"
											jsaction="address.click"
											class="gm-iv-marker"
											jsan="7.gm-iv-marker,22.jsaction"
										>
											<a
												aria-label="Показать местоположение"
												title="Показать местоположение"
												target="_blank"
												jstcache="16"
												href="https://www.google.com/maps/@44.724076973691545,37.76756528494562,13z?hl=ru-RU&amp;gl=US"
												class="gm-iv-marker-link"
												jsan="7.gm-iv-marker-link,8.href,0.aria-label,0.title,0.target"
											>
												<div
													class="gm-iv-marker-icon gm-iv-marker-icon-background"
												></div>
											</a>
										</div>
									</div>
								</div>
							</div>
							<div></div>
							<div></div>
							<div></div>
							<div>
								<button
									draggable="false"
									aria-label="Включить полноэкранный режим"
									title="Включить полноэкранный режим"
									type="button"
									aria-pressed="false"
									class="gm-control-active gm-fullscreen-control"
									style="
										background: none rgb(68, 68, 68);
										border: 0px;
										margin: 10px;
										padding: 0px;
										text-transform: none;
										appearance: none;
										position: absolute;
										cursor: pointer;
										user-select: none;
										border-radius: 2px;
										height: 40px;
										width: 40px;
										box-shadow: rgba(0, 0, 0, 0.3) 0px 1px 4px -1px;
										overflow: hidden;
										display: none;
										top: 0px;
										right: 0px;
									"
								>
									<img
										src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2018%2018%22%3E%3Cpath%20fill%3D%22%23b3b3b3%22%20d%3D%22M0%200v6h2V2h4V0H0zm16%200h-4v2h4v4h2V0h-2zm0%2016h-4v2h6v-6h-2v4zM2%2012H0v6h6v-2H2v-4z%22/%3E%3C/svg%3E"
										alt=""
										style="height: 18px; width: 18px"
									/><img
										src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2018%2018%22%3E%3Cpath%20fill%3D%22%23e6e6e6%22%20d%3D%22M0%200v6h2V2h4V0H0zm16%200h-4v2h4v4h2V0h-2zm0%2016h-4v2h6v-6h-2v4zM2%2012H0v6h6v-2H2v-4z%22/%3E%3C/svg%3E"
										alt=""
										style="height: 18px; width: 18px"
									/><img
										src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2018%2018%22%3E%3Cpath%20fill%3D%22%23fff%22%20d%3D%22M0%200v6h2V2h4V0H0zm16%200h-4v2h4v4h2V0h-2zm0%2016h-4v2h6v-6h-2v4zM2%2012H0v6h6v-2H2v-4z%22/%3E%3C/svg%3E"
										alt=""
										style="height: 18px; width: 18px"
									/>
								</button>
							</div>
							<div></div>
							<div>
								<div
									draggable="false"
									style="
										color: white;
										font-family: Roboto, Arial, sans-serif;
										background-color: black;
										padding: 4px;
										border: 2px solid white;
										user-select: none;
										display: none;
										position: absolute;
										left: 211px;
										top: 380px;
									"
								>
									Изображение недоступно
								</div>
							</div>
							<div></div>
							<div></div>
							<div>
								<div
									style="
										position: absolute;
										background-color: rgb(34, 34, 34);
										border-radius: 2px;
										margin-right: 10px;
										width: 40px;
										height: 40px;
										z-index: 1;
										display: none;
										bottom: 14px;
										right: 0px;
									"
								>
									<button
										type="button"
										title="Включить или отключить отслеживание движения"
										aria-label="Включить или отключить отслеживание движения"
										aria-pressed="false"
										style="
											background: transparent;
											border: none;
											cursor: pointer;
											margin: 0px;
											padding: 0px;
											height: 40px;
											width: 40px;
										"
									>
										<img
											alt=""
											src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2040%2040%22%3E%3Cpath%20fill%3D%22%23b3b3b3%22%20d%3D%22M27.42%200H12.58C10.61%200%209%201.61%209%203.58v32.83C9%2038.39%2010.61%2040%2012.58%2040h14.83c1.97%200%203.58-1.61%203.58-3.58v-32.84C31%201.61%2029.39%200%2027.42%200zM29%2032c0%20.55-.45%201-1%201H12c-.55%200-1-.45-1-1V8c0-.55.45-1%201-1h16c.55%200%201%20.45%201%201v24z%22/%3E%3C/svg%3E"
											style="width: 40px; height: 40px"
										/>
									</button>
								</div>
							</div>
							<div>
								<div
									style="
										margin: 0px 5px;
										z-index: 1000000;
										position: absolute;
										left: 0px;
										bottom: 0px;
									"
								>
									<a
										target="_blank"
										rel="noopener"
										title="Открыть эту область в Google Картах (в новом окне)"
										aria-label="Открыть эту область в Google Картах (в новом окне)"
										href="https://maps.google.com/maps/@44.724077,37.7675653,0a,45.2y,90t/data=!3m4!1e1!3m2!1slJVFuFcgQjYH-Ju38-4o3A!2e0?source=apiv3"
										style="display: inline"
										><div style="width: 66px; height: 26px">
											<img
												alt="Google"
												src="data:image/svg+xml,%3Csvg%20fill%3D%22none%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2069%2029%22%3E%3Cg%20opacity%3D%22.3%22%20fill%3D%22%23000%22%20stroke%3D%22%23000%22%20stroke-width%3D%221.5%22%3E%3Cpath%20d%3D%22M17.4706%207.33616L18.0118%206.79504%2017.4599%206.26493C16.0963%204.95519%2014.2582%203.94522%2011.7008%203.94522c-4.613699999999999%200-8.50262%203.7551699999999997-8.50262%208.395779999999998C3.19818%2016.9817%207.0871%2020.7368%2011.7008%2020.7368%2014.1712%2020.7368%2016.0773%2019.918%2017.574%2018.3689%2019.1435%2016.796%2019.5956%2014.6326%2019.5956%2012.957%2019.5956%2012.4338%2019.5516%2011.9316%2019.4661%2011.5041L19.3455%2010.9012H10.9508V14.4954H15.7809C15.6085%2015.092%2015.3488%2015.524%2015.0318%2015.8415%2014.403%2016.4629%2013.4495%2017.1509%2011.7008%2017.1509%209.04835%2017.1509%206.96482%2015.0197%206.96482%2012.341%206.96482%209.66239%209.04835%207.53119%2011.7008%207.53119%2013.137%207.53119%2014.176%208.09189%2014.9578%208.82348L15.4876%209.31922%2016.0006%208.80619%2017.4706%207.33616z%22/%3E%3Cpath%20d%3D%22M24.8656%2020.7286C27.9546%2020.7286%2030.4692%2018.3094%2030.4692%2015.0594%2030.4692%2011.7913%2027.953%209.39009%2024.8656%209.39009%2021.7783%209.39009%2019.2621%2011.7913%2019.2621%2015.0594c0%203.25%202.514499999999998%205.6692%205.6035%205.6692zM24.8656%2012.8282C25.8796%2012.8282%2026.8422%2013.6652%2026.8422%2015.0594%2026.8422%2016.4399%2025.8769%2017.2905%2024.8656%2017.2905%2023.8557%2017.2905%2022.8891%2016.4331%2022.8891%2015.0594%2022.8891%2013.672%2023.853%2012.8282%2024.8656%2012.8282z%22/%3E%3Cpath%20d%3D%22M35.7511%2017.2905v0H35.7469C34.737%2017.2905%2033.7703%2016.4331%2033.7703%2015.0594%2033.7703%2013.672%2034.7343%2012.8282%2035.7469%2012.8282%2036.7608%2012.8282%2037.7234%2013.6652%2037.7234%2015.0594%2037.7234%2016.4439%2036.7554%2017.2961%2035.7511%2017.2905zM35.7387%2020.7286C38.8277%2020.7286%2041.3422%2018.3094%2041.3422%2015.0594%2041.3422%2011.7913%2038.826%209.39009%2035.7387%209.39009%2032.6513%209.39009%2030.1351%2011.7913%2030.1351%2015.0594%2030.1351%2018.3102%2032.6587%2020.7286%2035.7387%2020.7286z%22/%3E%3Cpath%20d%3D%22M51.953%2010.4357V9.68573H48.3999V9.80826C47.8499%209.54648%2047.1977%209.38187%2046.4808%209.38187%2043.5971%209.38187%2041.0168%2011.8998%2041.0168%2015.0758%2041.0168%2017.2027%2042.1808%2019.0237%2043.8201%2019.9895L43.7543%2020.0168%2041.8737%2020.797%2041.1808%2021.0844%2041.4684%2021.7772C42.0912%2023.2776%2043.746%2025.1469%2046.5219%2025.1469%2047.9324%2025.1469%2049.3089%2024.7324%2050.3359%2023.7376%2051.3691%2022.7367%2051.953%2021.2411%2051.953%2019.2723v-8.8366zm-7.2194%209.9844L44.7334%2020.4196C45.2886%2020.6201%2045.878%2020.7286%2046.4808%2020.7286%2047.1616%2020.7286%2047.7866%2020.5819%2048.3218%2020.3395%2048.2342%2020.7286%2048.0801%2021.0105%2047.8966%2021.2077%2047.6154%2021.5099%2047.1764%2021.7088%2046.5219%2021.7088%2045.61%2021.7088%2045.0018%2021.0612%2044.7336%2020.4201zM46.6697%2012.8282C47.6419%2012.8282%2048.5477%2013.6765%2048.5477%2015.084%2048.5477%2016.4636%2047.6521%2017.2987%2046.6697%2017.2987%2045.6269%2017.2987%2044.6767%2016.4249%2044.6767%2015.084%2044.6767%2013.7086%2045.6362%2012.8282%2046.6697%2012.8282zM55.7387%205.22081v-.75H52.0788V20.4412H55.7387V5.22081z%22/%3E%3Cpath%20d%3D%22M63.9128%2016.0614L63.2945%2015.6492%2062.8766%2016.2637C62.4204%2016.9346%2061.8664%2017.3069%2061.0741%2017.3069%2060.6435%2017.3069%2060.3146%2017.2088%2060.0544%2017.0447%2059.9844%2017.0006%2059.9161%2016.9496%2059.8498%2016.8911L65.5497%2014.5286%2066.2322%2014.2456%2065.9596%2013.5589%2065.7406%2013.0075C65.2878%2011.8%2063.8507%209.39832%2060.8278%209.39832%2057.8445%209.39832%2055.5034%2011.7619%2055.5034%2015.0676%2055.5034%2018.2151%2057.8256%2020.7369%2061.0659%2020.7369%2063.6702%2020.7369%2065.177%2019.1378%2065.7942%2018.2213L66.2152%2017.5963%2065.5882%2017.1783%2063.9128%2016.0614zM61.3461%2012.8511L59.4108%2013.6526C59.7903%2013.0783%2060.4215%2012.7954%2060.9017%2012.7954%2061.067%2012.7954%2061.2153%2012.8161%2061.3461%2012.8511z%22/%3E%3C/g%3E%3Cpath%20d%3D%22M11.7008%2019.9868C7.48776%2019.9868%203.94818%2016.554%203.94818%2012.341%203.94818%208.12803%207.48776%204.69522%2011.7008%204.69522%2014.0331%204.69522%2015.692%205.60681%2016.9403%206.80583L15.4703%208.27586C14.5751%207.43819%2013.3597%206.78119%2011.7008%206.78119%208.62108%206.78119%206.21482%209.26135%206.21482%2012.341%206.21482%2015.4207%208.62108%2017.9009%2011.7008%2017.9009%2013.6964%2017.9009%2014.8297%2017.0961%2015.5606%2016.3734%2016.1601%2015.7738%2016.5461%2014.9197%2016.6939%2013.7454h-4.9931V11.6512h7.0298C18.8045%2012.0207%2018.8456%2012.4724%2018.8456%2012.957%2018.8456%2014.5255%2018.4186%2016.4637%2017.0389%2017.8434%2015.692%2019.2395%2013.9838%2019.9868%2011.7008%2019.9868zM29.7192%2015.0594C29.7192%2017.8927%2027.5429%2019.9786%2024.8656%2019.9786%2022.1884%2019.9786%2020.0121%2017.8927%2020.0121%2015.0594%2020.0121%2012.2096%2022.1884%2010.1401%2024.8656%2010.1401%2027.5429%2010.1401%2029.7192%2012.2096%2029.7192%2015.0594zM27.5922%2015.0594C27.5922%2013.2855%2026.3274%2012.0782%2024.8656%2012.0782S22.1391%2013.2937%2022.1391%2015.0594C22.1391%2016.8086%2023.4038%2018.0405%2024.8656%2018.0405S27.5922%2016.8168%2027.5922%2015.0594zM40.5922%2015.0594C40.5922%2017.8927%2038.4159%2019.9786%2035.7387%2019.9786%2033.0696%2019.9786%2030.8851%2017.8927%2030.8851%2015.0594%2030.8851%2012.2096%2033.0614%2010.1401%2035.7387%2010.1401%2038.4159%2010.1401%2040.5922%2012.2096%2040.5922%2015.0594zM38.4734%2015.0594C38.4734%2013.2855%2037.2087%2012.0782%2035.7469%2012.0782%2034.2851%2012.0782%2033.0203%2013.2937%2033.0203%2015.0594%2033.0203%2016.8086%2034.2851%2018.0405%2035.7469%2018.0405%2037.2087%2018.0487%2038.4734%2016.8168%2038.4734%2015.0594zM51.203%2010.4357v8.8366C51.203%2022.9105%2049.0595%2024.3969%2046.5219%2024.3969%2044.132%2024.3969%2042.7031%2022.7955%2042.161%2021.4897L44.0417%2020.7095C44.3784%2021.5143%2045.1997%2022.4588%2046.5219%2022.4588%2048.1479%2022.4588%2049.1499%2021.4487%2049.1499%2019.568V18.8617H49.0759C48.5914%2019.4612%2047.6552%2019.9786%2046.4808%2019.9786%2044.0171%2019.9786%2041.7668%2017.8352%2041.7668%2015.0758%2041.7668%2012.3%2044.0253%2010.1319%2046.4808%2010.1319%2047.6552%2010.1319%2048.5914%2010.6575%2049.0759%2011.2323H49.1499V10.4357H51.203zM49.2977%2015.084C49.2977%2013.3512%2048.1397%2012.0782%2046.6697%2012.0782%2045.175%2012.0782%2043.9267%2013.3429%2043.9267%2015.084%2043.9267%2016.8004%2045.175%2018.0487%2046.6697%2018.0487%2048.1397%2018.0487%2049.2977%2016.8004%2049.2977%2015.084zM54.9887%205.22081V19.6912H52.8288V5.22081H54.9887zM63.4968%2016.6854L65.1722%2017.8023C64.6301%2018.6072%2063.3244%2019.9869%2061.0659%2019.9869%2058.2655%2019.9869%2056.2534%2017.827%2056.2534%2015.0676%2056.2534%2012.1439%2058.2901%2010.1483%2060.8278%2010.1483%2063.3818%2010.1483%2064.6301%2012.1768%2065.0408%2013.2773L65.2625%2013.8357%2058.6843%2016.5623C59.1853%2017.5478%2059.9737%2018.0569%2061.0741%2018.0569%2062.1746%2018.0569%2062.9384%2017.5067%2063.4968%2016.6854zM58.3312%2014.9115L62.7331%2013.0884C62.4867%2012.4724%2061.764%2012.0454%2060.9017%2012.0454%2059.8012%2012.0454%2058.2737%2013.0145%2058.3312%2014.9115z%22%20fill%3D%22%23fff%22/%3E%3C/svg%3E"
												draggable="false"
												style="
													position: absolute;
													left: 0px;
													top: 0px;
													width: 66px;
													height: 26px;
													user-select: none;
													border: 0px;
													padding: 0px;
													margin: 0px;
												"
											/></div
									></a>
								</div>
							</div>
							<div></div>
							<div>
								<div
									style="
										display: inline-flex;
										position: absolute;
										right: 0px;
										bottom: 0px;
									"
								>
									<div class="gmnoprint" style="z-index: 1000001">
										<div
											draggable="false"
											class="gm-style-cc"
											style="
												user-select: none;
												position: relative;
												height: 14px;
												line-height: 14px;
											"
										>
											<div
												style="
													opacity: 0.7;
													width: 100%;
													height: 100%;
													position: absolute;
												"
											>
												<div style="width: 1px"></div>
												<div
													style="
														background-color: rgb(0, 0, 0);
														width: auto;
														height: 100%;
														margin-left: 1px;
													"
												></div>
											</div>
											<div
												style="
													position: relative;
													padding-right: 6px;
													padding-left: 6px;
													box-sizing: border-box;
													font-family: Roboto, Arial, sans-serif;
													font-size: 10px;
													color: rgb(255, 255, 255);
													white-space: nowrap;
													direction: ltr;
													text-align: right;
													vertical-align: middle;
													display: inline-block;
												"
											>
												<button
													draggable="false"
													aria-label="Быстрые клавиши"
													title="Быстрые клавиши"
													type="button"
													style="
														background: none;
														display: inline-block;
														border: 0px;
														margin: 0px;
														padding: 0px;
														text-transform: none;
														appearance: none;
														position: relative;
														cursor: pointer;
														user-select: none;
														color: rgb(255, 255, 255);
														font-family: inherit;
														line-height: inherit;
													"
												>
													Быстрые клавиши
												</button>
											</div>
										</div>
									</div>
									<div class="gmnoprint" style="z-index: 1000001">
										<div
											draggable="false"
											class="gm-style-cc"
											style="
												user-select: none;
												position: relative;
												height: 14px;
												line-height: 14px;
											"
										>
											<div
												style="
													opacity: 0.7;
													width: 100%;
													height: 100%;
													position: absolute;
												"
											>
												<div style="width: 1px"></div>
												<div
													style="
														background-color: rgb(0, 0, 0);
														width: auto;
														height: 100%;
														margin-left: 1px;
													"
												></div>
											</div>
											<div
												style="
													position: relative;
													padding-right: 6px;
													padding-left: 6px;
													box-sizing: border-box;
													font-family: Roboto, Arial, sans-serif;
													font-size: 10px;
													color: rgb(255, 255, 255);
													white-space: nowrap;
													direction: ltr;
													text-align: right;
													vertical-align: middle;
													display: inline-block;
												"
											>
												<button
													draggable="false"
													aria-label="Картографические данные"
													title="Картографические данные"
													type="button"
													style="
														background: none;
														border: 0px;
														margin: 0px;
														padding: 0px;
														text-transform: none;
														appearance: none;
														position: relative;
														cursor: pointer;
														user-select: none;
														color: rgb(255, 255, 255);
														font-family: inherit;
														line-height: inherit;
														display: none;
													"
												>
													Картографические данные</button
												><span style="">© 2025 Google</span>
											</div>
										</div>
									</div>
									<div class="gmnoscreen">
										<div
											style="
												font-family: Roboto, Arial, sans-serif;
												font-size: 11px;
												color: rgb(0, 0, 0);
												direction: ltr;
												text-align: right;
												background-color: rgb(245, 245, 245);
											"
										>
											© 2025 Google
										</div>
									</div>
									<div
										class="gmnoprint gm-style-cc"
										draggable="false"
										style="
											z-index: 1000001;
											user-select: none;
											position: relative;
											height: 14px;
											line-height: 14px;
										"
									>
										<div
											style="
												opacity: 0.7;
												width: 100%;
												height: 100%;
												position: absolute;
											"
										>
											<div style="width: 1px"></div>
											<div
												style="
													background-color: rgb(0, 0, 0);
													width: auto;
													height: 100%;
													margin-left: 1px;
												"
											></div>
										</div>
										<div
											style="
												position: relative;
												padding-right: 6px;
												padding-left: 6px;
												box-sizing: border-box;
												font-family: Roboto, Arial, sans-serif;
												font-size: 10px;
												color: rgb(255, 255, 255);
												white-space: nowrap;
												direction: ltr;
												text-align: right;
												vertical-align: middle;
												display: inline-block;
											"
										>
											<a
												aria-label="Условия (ссылка откроется в новой вкладке)"
												href="https://www.google.com/intl/ru-RU_US/help/terms_maps.html"
												target="_blank"
												rel="noopener"
												style="
													text-decoration: none;
													cursor: pointer;
													color: rgb(255, 255, 255);
												"
												>Условия</a
											>
										</div>
									</div>
									<div
										draggable="false"
										class="gm-style-cc"
										style="
											user-select: none;
											position: relative;
											height: 14px;
											line-height: 14px;
										"
									>
										<div
											style="
												opacity: 0.7;
												width: 100%;
												height: 100%;
												position: absolute;
											"
										>
											<div style="width: 1px"></div>
											<div
												style="
													background-color: rgb(0, 0, 0);
													width: auto;
													height: 100%;
													margin-left: 1px;
												"
											></div>
										</div>
										<div
											style="
												position: relative;
												padding-right: 6px;
												padding-left: 6px;
												box-sizing: border-box;
												font-family: Roboto, Arial, sans-serif;
												font-size: 10px;
												color: rgb(255, 255, 255);
												white-space: nowrap;
												direction: ltr;
												text-align: right;
												vertical-align: middle;
												display: inline-block;
											"
										>
											<a
												target="_new"
												title='Сообщить Google о проблеме в сервисе "Просмотр улиц"'
												dir="ltr"
												href="https://www.google.com/local/imagery/report/?cb_client=apiv3&amp;image_key=!1e2!2slJVFuFcgQjYH-Ju38-4o3A&amp;cbp=1,0,,0,0&amp;hl=ru-RU"
												style="text-decoration: none; color: rgb(255, 255, 255)"
												>Сообщить о проблеме</a
											>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div id="drone-map"></div>
					<div id="block-touch" style="pointer-events: auto"></div>
					<!-- Coins layer -->
					<div id="coinLayer" aria-hidden="true"></div>
				</div>

				<!-- header -->
				<header class="app__header header">
					<div class="header__container container">
						<!-- Лицензия слева -->
						<a
							id="avatarBtn"
							class="header__avatar-card avatar-card"
							href="/profile.html"
							data-shop-id="unlock_online"
						>
							<img class="avatar-card__img" src="avatar.png" alt="Avatar" />
							<span class="avatar-card__text">
								Уровень <span id="playerLevel">100</span>
							</span>
						</a>

						<!-- Монеты и энергия -->
						<ul class="header__list-stat list-stat">
							<li>
								<a class="list-stat-link" href="#">
									<img
										class="list-stat-link__img list-stat-link__img_first"
										src="coin.png"
										alt=""
									/>
									<span class="list-stat-link__text" id="scoreCoins">0</span>
									<img class="list-stat-link__img" src="plus.png" alt="" />
								</a>
							</li>
							<li>
								<a class="list-stat-link" href="#">
									<img
										class="list-stat-link__img list-stat-link__img_first"
										src="energy.png"
										alt=""
									/>
									<span class="list-stat-link__text" title="Energy: 1440 / 1440"
										>1440</span
									>
									<img class="list-stat-link__img" src="plus.png" alt="" />
								</a>
							</li>
						</ul>

						<!-- Камера и звук -->
						<div class="header__controls-vertical">
							<button
								id="toggle-rotation"
								class="rotate-chip"
								aria-label="Toggle rotation"
							></button>
							<button
								class="mute-chip"
								id="toggle-engine"
								aria-label="Engine mute"
							></button>
						</div>

						<!-- Меню справа -->
						<a id="topMenuBtn" class="header__btn-menu" aria-label="Menu"></a>
					</div>
				</header>

				<!-- Выбор города и таймер — тоже ВНЕ header -->
				<div class="city-row">
					<!-- <span id="timerChip" class="timer-chip active">Старт через:</span> -->

					<div id="cityChip" class="city-chip">
						<span id="currentCityLabel">Novorossiysk</span>
					</div>

					<!-- Hidden native select (keeps all old logic working) -->
					<select
						id="citySelect"
						data-shop-id="unlock_city"
						style="
							display: none;
							min-width: 150px;
							font-size: 15px;
							text-transform: uppercase;
						"
					>
						<option value="Paris">Paris</option>
						<option value="Berlin">Berlin</option>
						<option value="Moscow">Moscow</option>
						<option value="Karaganda">Karaganda</option>
						<option value="Astana">Astana</option>
						<option value="Washington">Washington</option>
						<option value="Rome">Rome</option>
						<option value="Monaco">Monaco</option>
						<option value="Vatican">Vatican</option>
						<option value="Istanbul">Istanbul</option>
						<option value="Dubai">Dubai</option>
						<option value="Safari">Safari</option>
					</select>
				</div>

				<!-- Блок голосования — ВНЕ header! -->
				<div class="votes-top container">
					<div class="votes-bar">
						<span id="i18n-votes" class="votes-bar__title">Голоса:</span>

						<div
							class="votes-bar__list votes-bf &lt;!-- Map (left) and SOS (right) --&gt;ar__list"
						>
							<div id="routeInfo" class="vcount__wrap">
								<svg
									class="votes-bar__participants-icon"
									xmlns="http://www.w3.org/2000/svg"
									viewBox="40.00025177001953 20 431.999755859375 472"
								>
									<g>
										<path
											d="m245.725 48.284-99.871 213.008-94.138 94.138c-15.621 15.621-15.621 40.948 0 56.569l28.285 28.285c15.621 15.621 40.948 15.621 56.569 0l94.138-94.138 213.008-99.871M472 274.558 217.441 20M431.289 120.711 472 100M371.289 60.711 392 20"
											style="
												stroke-width: 40;
												stroke-linecap: round;
												stroke-linejoin: round;
												stroke-miterlimit: 10;
											"
											fill="none"
											stroke="#fff"
											stroke-width="40"
											stroke-linecap="round"
											stroke-linejoin="round"
											stroke-miterlimit="10"
											data-original="#fff"
										></path>
										<path
											d="m174.145 402.708 77.158 77.158C258.572 487.349 268.742 492 280 492c22.092 0 40-17.91 40-40 0-11.257-4.651-21.428-12.134-28.696L145.854 261.292"
											style="
												stroke-width: 40;
												stroke-linecap: round;
												stroke-linejoin: round;
												stroke-miterlimit: 10;
											"
											fill="none"
											stroke="#fff"
											stroke-width="40"
											stroke-linecap="round"
											stroke-linejoin="round"
											stroke-miterlimit="10"
											data-original="#fff"
										></path>
									</g>
								</svg>
								80
							</div>
							<div class="vcount__wrap">
								← <span id="vLeft" class="vcount">0</span>
							</div>
							<div class="vcount__wrap">
								↑ <span id="vStraight" class="vcount">0</span>
							</div>
							<div class="vcount__wrap">
								→ <span id="vRight" class="vcount">0</span>
							</div>
							<div class="vcount__wrap">
								↓ <span id="vBack" class="vcount">0</span>
							</div>
						</div>

						<!-- NEW: participants line -->
						<div class="votes-bar__wrap-bottom">
							<span id="participantsInfo" class="votes-bar__participants">
								Водителей в сети: 87
							</span>
							<span id="timerChip" class="timer-chip active">
								Старт через:
							</span>
							<!-- <span id="routeInfo" class="votes-bar__participants">
								<svg
									class="votes-bar__participants-icon"
									xmlns="http://www.w3.org/2000/svg"
									version="1.1"
									xmlns:xlink="http://www.w3.org/1999/xlink"
									viewBox="0 0 511.999 511.999"
									xml:space="preserve"
								>
									<path
										d="M467.069 212.578 267.381 12.861c-11.777-11.748-30.828-11.609-42.451-.015-11.689 11.719-11.689 30.747 0 42.451L424.647 255c11.7 11.7 30.721 11.7 42.422 0 11.732-11.732 11.732-30.692 0-42.422zM210.115 82.905l-1.503 7.534c-10.587 52.958-36.317 103.269-71.118 144.046l108.647 108.647c40.772-34.794 90.39-61.215 143.35-71.815l7.548-1.503L210.115 82.905zM117.575 256.989l-74.253 74.238c-17.545 17.545-17.618 46.029 0 63.647l42.422 42.422c17.545 17.545 46.029 17.617 63.647 0l74.246-74.246-106.062-106.061zm10.606 116.675c-5.859 5.859-15.352 5.859-21.211 0-5.859-5.859-5.859-15.352 0-21.211l21.211-21.211c5.859-5.859 15.352-5.859 21.211 0 5.859 5.859 5.859 15.352 0 21.211l-21.211 21.211zM286.266 445.278l20.405-20.405c17.619-17.616 17.561-46.1.001-63.631l-15.156-15.167c-8.377 5.627-16.377 11.741-24.155 18.265l18.1 18.127c5.845 5.815 5.886 15.279 0 21.196l-20.742 20.742-30.482-29.533-42.424 42.424 68.057 65.947c11.614 11.644 30.683 11.71 42.407-.015 11.704-11.704 11.704-30.732 0-42.437l-16.011-15.513zM346.864 0c-8.291 0-15 6.709-15 15v30c0 8.291 6.709 15 15 15s15-6.709 15-15V15c0-8.291-6.709-15-15-15zM466.864 120h-30c-8.291 0-15 6.709-15 15s6.709 15 15 15h30c8.291 0 15-6.709 15-15s-6.709-15-15-15zM447.469 34.394c-5.859-5.859-15.352-5.859-21.211 0l-30 30c-5.859 5.859-5.859 15.352 0 21.211s15.352 5.86 21.211 0l30-30c5.859-5.859 5.859-15.352 0-21.211z"
									></path>
								</svg>
								Голосов: 4&nbsp;522
							</span> -->

							<!-- <div id="routeInfo" class="main-content-bottom__info">
								В пути: 0.03 км · 0 ч · Голосов: 4&nbsp;522
							</div> -->
						</div>
						<!-- CHAMPIONS INSIDE VOTES BAR -->
					</div>
				</div>

				<!-- footer -->
				<footer class="app__footer footer">
					<div class="footer__container container">
						<!-- Champions column + Map (left) -->
						<div class="champions-column">
							<div class="champions-label" id="i18n-champions">Лидеры</div>
							<div class="champions-list" id="championsList">
								<div class="champion-card" title="WIN3396: 935 clicks">
									<div class="champion-medal">🥇</div>
									<img
										class="champion-avatar"
										src="https://t.me/i/userpic/320/5qbRW6J4-WRd-oiPXmgotFXBN4odlFmJ3uvGryxklJw.svg"
									/>
									<div class="champion-name">WIN3396</div>
								</div>
								<div class="champion-card" title="Victoria Mut: 707 clicks">
									<div class="champion-medal">🥈</div>
									<img
										class="champion-avatar"
										src="https://t.me/i/userpic/320/od8XBjpLqkFlc1QRHV4UCdC77btY5cMoo2GkNkfkeFquqm7dUdjpUi5UVYag23Su.svg"
									/>
									<div class="champion-name">Victoria Mut</div>
								</div>
								<div class="champion-card" title="С М: 612 clicks">
									<div class="champion-medal">🥉</div>
									<img
										class="champion-avatar"
										src="https://t.me/i/userpic/320/O-Hx-vXV0tdLvLi7l0fR9vK8wxT-8WFoBtb9ffgjphnXD_rqjPcR9Bs6qiWybOWb.svg"
									/>
									<div class="champion-name">С М</div>
								</div>
							</div>
							<button id="sosToggle" class="sos-toggle" type="button">
								SOS
							</button>
						</div>

						<a id="btnMap" data-shop-id="unlock_map" aria-label="Open map"></a>

						<!-- control arrows above the wheel -->
						<div class="control-arrows">
							<a
								class="control-arrows__btn left"
								href="javascript:void(0)"
								data-dir="left"
								aria-label="Left"
							></a>
							<a
								class="control-arrows__btn up"
								href="javascript:void(0)"
								data-dir="straight"
								aria-label="Up"
								style="
									opacity: 0.12;
									pointer-events: none;
									filter: grayscale(100%);
								"
							></a>
							<a
								class="control-arrows__btn right"
								href="javascript:void(0)"
								data-dir="right"
								aria-label="Right"
							></a>
							<a
								class="control-arrows__btn down"
								href="javascript:void(0)"
								data-dir="backward"
								aria-label="Down"
								style="
									opacity: 0.12;
									pointer-events: none;
									filter: grayscale(100%);
								"
							></a>
							<p
								id="i18n-pickdir"
								class="control-arrows__hint"
								style="display: block"
							>
								нажмите стрелку
							</p>
						</div>
						<script>
							(function () {
								const key = 'tutorial_arrow_done';
								const hint = document.getElementById('i18n-pickdir');

								if (hint && !localStorage.getItem(key)) {
									hint.style.display = 'block';
								}

								document.addEventListener('click', function (e) {
									const btn = e.target.closest('.control-arrows__btn');
									if (btn && !localStorage.getItem(key)) {
										localStorage.setItem(key, '1');
										if (hint) hint.style.display = 'none';
									}
								});
							})();
						</script>

						<div class="footer__layer footer__layer_first">
							<div class="footer__layer-left">
								<ul class="footer__layer-list items-list">
									<li class="items-list__item">
										<img
											id="plantSlot"
											data-shop-id="plant_cactus"
											class="items-list__item-img"
											src="cactus.png"
											data-default-src="cactus.png"
											alt="Plant"
										/>
									</li>
								</ul>
							</div>

							<button
								class="footer__layer-btn footer-btn-radio"
								id="btnRadio"
								aria-label="Radio"
								style="pointer-events: auto"
							>
								<span id="i18n-radio" class="footer-btn-radio__title"
									>РАДИО</span
								>
								<span class="footer-btn-radio__text">104,5 FM</span>
							</button>

							<div class="footer__layer-right">
								<ul class="footer__layer-list items-list items-list_first">
									<li class="items-list__item">
										<img
											id="carModel"
											data-shop-id="toy_modelcar"
											class="items-list__item-img"
											src="car.png"
											data-default-src="car.png"
											alt="Car"
											style="pointer-events: none"
										/>
									</li>
								</ul>
								<ul class="footer__layer-list items-list">
									<li class="items-list__item">
										<img
											id="toySlot"
											data-shop-id="toy_slot"
											class="items-list__item-img"
											data-default-src=""
											alt="Toy/Sticker"
											style=""
											src="Mask group-2.png"
										/>
									</li>
								</ul>
							</div>
						</div>

						<div class="footer__layer footer__layer_third">
							<div class="footer__layer-dashboard">
								<img
									class="footer__layer-dashboard-img"
									src="dashboard.png"
									alt="Панель"
								/>
							</div>
						</div>

						<div class="footer__img-wheel-wrap">
							<img class="footer__img-wheel" id="wheelImg" data-shop...t"=""
							src="rudder.png" data-default-src="rudder.png" alt="Wheel"
							style="pointer-events: none; transform: rotate(0deg);">
							<button id="hornBtn" aria-label="Horn"></button>
						</div>

						<!-- Invisible big hit area over the speed gauge -->
						<button
							id="speedCtrlBtn"
							class="speedctrl-btn"
							aria-label="Speed settings"
						></button>

						<div class="footer__menu-wrap">
							<nav class="footer__menu">
								<ul class="footer__menu-list">
									<li>
										<a
											class="footer__menu-list-item-link footer-menu-link"
											href="javascript:void(0)"
											style="background-image: url('menu-home.png')"
											aria-label="Home"
											id="btnHome"
											data-shop-id="unlock_home"
										></a>
									</li>
									<li>
										<a
											class="footer__menu-list-item-link footer-menu-link"
											href="javascript:void(0)"
											style="background-image: url('menu-game.png')"
											aria-label="Drone/Car"
											id="btnDroneToggle"
											data-shop-id="unlock_drone"
										></a>
									</li>
								</ul>
							</nav>
							<nav class="footer__menu">
								<ul class="footer__menu-list">
									<li>
										<a
											class="footer__menu-list-item-link footer-menu-link footer-menu-link_new"
											href="javascript:void(0)"
											style="background-image: url('menu-tasks.png')"
											aria-label="Chat via list"
											id="btnReset"
											data-shop-id="unlock_steps"
										></a>
									</li>
									<li>
										<a
											class="footer__menu-list-item-link footer-menu-link"
											href="javascript:void(0)"
											style="background-image: url('menu-shop.png')"
											aria-label="Magazin"
											id="btnShop"
										></a>
									</li>
								</ul>
							</nav>
						</div>
					</div>
				</footer>

				<!-- ONLINE DROPDOWN -->
				<div id="onlineUsersPanel">
					<div class="users-header">Онлайн:</div>
					<div class="user-row">
						<img
							class="avatar"
							src="https://www.gravatar.com/avatar/?d=mp&amp;s=40"
						/>
						<span class="username">Guest</span>
						<span class="userid">#guest_z</span>
						<span
							class="clicks"
							style="color: #ffc43c; font-weight: bold; margin-left: 8px"
							>Кликов: 3</span
						>
					</div>
					<div class="user-row">
						<img
							class="avatar"
							src="https://t.me/i/userpic/320/b43j-fZZjcW8FJFoGHuS-2Jql_XjxoZK_ofAfHzxEIo.svg"
						/>
						<span class="username">WEBmrWHO</span>
						<span class="userid">#1846591</span>
						<span
							class="clicks"
							style="color: #ffc43c; font-weight: bold; margin-left: 8px"
							>Кликов: 9</span
						>
					</div>
				</div>
			</div>
		</div>

		<!-- City drawer -->
		<div id="cityOverlay" class="city-overlay"></div>

		<aside id="cityDrawer" class="city-drawer" aria-hidden="true">
			<div class="city-header">
				<span>City</span>
				<button id="cityClose" class="city-close">Close</button>
			</div>
			<ul class="city-list">
				<li>
					<button
						class="city-item"
						data-city-item=""
						data-city="Paris"
						data-required-level="1"
					>
						Paris
					</button>
				</li>
				<li>
					<button
						class="city-item locked"
						data-city-item=""
						data-city="Berlin"
						data-required-level="20"
					>
						Berlin
					</button>
				</li>
				<li>
					<button
						class="city-item locked"
						data-city-item=""
						data-city="Moscow"
						data-required-level="20"
					>
						Moscow
					</button>
				</li>
				<li>
					<button
						class="city-item locked"
						data-city-item=""
						data-city="Karaganda"
						data-required-level="20"
					>
						Karaganda
					</button>
				</li>
				<li>
					<button
						class="city-item locked"
						data-city-item=""
						data-city="Astana"
						data-required-level="20"
					>
						Astana
					</button>
				</li>
				<li>
					<button
						class="city-item locked"
						data-city-item=""
						data-city="Washington"
						data-required-level="20"
					>
						Washington
					</button>
				</li>
				<li>
					<button
						class="city-item locked"
						data-city-item=""
						data-city="Rome"
						data-required-level="20"
					>
						Rome
					</button>
				</li>
				<li>
					<button
						class="city-item locked"
						data-city-item=""
						data-city="Monaco"
						data-required-level="20"
					>
						Monaco
					</button>
				</li>
				<li>
					<button
						class="city-item locked"
						data-city-item=""
						data-city="Vatican"
						data-required-level="20"
					>
						Vatican
					</button>
				</li>
				<li>
					<button
						class="city-item locked"
						data-city-item=""
						data-city="Istanbul"
						data-required-level="20"
					>
						Istanbul
					</button>
				</li>
				<li>
					<button
						class="city-item locked"
						data-city-item=""
						data-city="Dubai"
						data-required-level="20"
					>
						Dubai
					</button>
				</li>
				<li>
					<button
						class="city-item locked"
						data-city-item=""
						data-city="Safari"
						data-required-level="20"
					>
						Safari
					</button>
				</li>
			</ul>
		</aside>

		<!-- Map popup as left drawer -->
		<div
			id="mapPopup"
			style="
				position: fixed;
				top: 0;
				left: 0;
				right: 0;
				bottom: var(--footer-h);
				display: none;
				z-index: 3000;
				pointer-events: none;
			"
		>
			<div
				id="mapPanel"
				style="
					position: absolute;
					top: 0px; /* маленький отступ от верхнего края */
					left: 0;
					bottom: 65px; /* снизу оставляем место, чтобы стрелки были видны/живые */

					width: 100vw; /* немного шире, но не на весь экран */
					max-width: 700px; /* можно подогнать цифру, если нужно */

					background: #ffffff;
					box-shadow: 4px 0 20px rgba(0, 0, 0, 0.35);
					border-radius: 0 20px 20px 0;
					display: flex;
					flex-direction: column;
					transform: translateX(-100%);
					transition: transform 0.25s ease-out;
					pointer-events: auto;
					overflow: hidden;
				"
			>
				<button
					id="hideMapBtn"
					style="
						border: none;
						background: #19e074;
						color: #fff;
						font-weight: 900;
						padding: 10px 14px;
						font-size: 15px;
						display: flex;
						align-items: center;
						gap: 8px;
					"
				>
					Скрыть карту ▲
				</button>

				<div id="mapCanvas" style="flex: 1; background: #e9f3ff">
					<div style="height: 100%; width: 100%">
						<div style="overflow: hidden"></div>
					</div>
				</div>
			</div>
		</div>

		<!-- CHAT POPUP -->
		<div
			id="chatPopup"
			style="
				display: none;
				position: fixed;
				bottom: 0;
				right: 0;
				width: 320px;
				max-width: 90vw;
				height: 400px;
				background: #fff;
				color: #222;
				border-radius: 16px 16px 0 0;
				box-shadow: 0 0 18px rgba(0, 0, 0, 0.2);
				z-index: 3000;
				flex-direction: column;
				overflow: hidden;
			"
		>
			<div
				style="
					background: #19e074;
					color: #fff;
					padding: 10px 16px;
					font-weight: bold;
					display: flex;
					align-items: center;
				"
			>
				<span id="i18n-chat-title">Чат &amp; Подарки</span>

				<button
					id="chatCloseBtn"
					style="
						margin-left: auto;
						background: none;
						border: none;
						color: #fff;
						font-size: 22px;
						cursor: pointer;
					"
				>
					×
				</button>
			</div>
			<div
				id="chatMessages"
				style="
					flex: 1 1 auto;
					padding: 8px 10px;
					overflow-y: auto;
					font-size: 14px;
				"
			></div>
			<div
				style="
					display: flex;
					gap: 4px;
					border-top: 1px solid #eee;
					padding: 6px;
					align-items: center;
				"
			>
				<button
					id="chatAttachBtn"
					type="button"
					style="
						border: none;
						background: #f0f0f0;
						border-radius: 6px;
						width: 32px;
						height: 32px;
						display: flex;
						align-items: center;
						justify-content: center;
						font-size: 18px;
						padding: 0;
					"
				>
					📎
				</button>
				<input
					id="chatImageInput"
					type="file"
					accept="image/*"
					style="display: none"
				/>

				<button
					id="chatVoiceBtn"
					type="button"
					style="
						border: none;
						background: #f0f0f0;
						border-radius: 6px;
						width: 32px;
						height: 32px;
						display: flex;
						align-items: center;
						justify-content: center;
						font-size: 18px;
						padding: 0;
					"
				>
					🎙
				</button>

				<input
					id="chatInput"
					placeholder="Сообщение или 👑🎂🎁"
					style="
						flex: 1;
						padding: 6px;
						border-radius: 6px;
						border: 1px solid #ccc;
						font-size: 14px;
					"
				/>

				<button
					id="chatSendBtn"
					style="
						background: #26a96e;
						color: #fff;
						border: none;
						border-radius: 6px;
						font-weight: bold;
						padding: 0 12px;
						height: 32px;
					"
				>
					→
				</button>
			</div>
		</div>

		<audio id="carAudio" src="autosound.mp3" preload="auto"></audio>
		<audio id="hornAudio" src="horn.mp3" preload="auto"></audio>
		<audio id="radioAudio" preload="none" crossorigin="anonymous"></audio>
		<audio id="coinSound" src="coin.mp3" preload="auto"></audio>
		<audio id="coinMissSound" src="miss.mp3" preload="auto"></audio>

		<script src="https://telegram.org/js/telegram-web-app.js"></script>

		<script>
			/* ==== I18N ru/en/zh ==== */
			window.currentLang = localStorage.getItem('lang') || 'ru';
			const DICT = {
				ru: {
					menuTitle: 'Меню',
					close: 'Закрыть',
					menuNft: 'NFT Магазин',
					menuDrivers: 'Все водители',
					menuShop: 'Магазин',
					menuSupportEmail: 'Поддержка (Email)',
					menuSupportBot: 'Поддержка (Бот)',
					votesTitle: 'Голоса',
					enRoute: 'В пути',
					km: 'км',
					votes: 'Голосов',
					startAlwaysIn: 'Старт через',
					startIn: 'Старт через',
					pickDirection: 'нажмите стрелку',
					radio: 'РАДИО',
					hideMap: 'Скрыть карту ▲',
					chatTitle: 'Чат & Подарки',
					chatPlaceholder: 'Сообщение или 👑🎂🎁',
					send: '→',
					online: 'Онлайн',
					nobody: 'Пока никого нет',
					nowPlaying: 'Сейчас играет',
					stop: '⏹️ Стоп',
					closeBtn: 'Закрыть',
					daysShort: 'дн.',
					hoursShort: 'ч',
					participants: 'Участников',
					championsLabel: 'Лидеры',
				},
				en: {
					menuTitle: 'Menu',
					close: 'Close',
					menuNft: 'NFT Shop',
					menuDrivers: 'All drivers',
					menuShop: 'Shop',
					menuSupportEmail: 'Support (Email)',
					menuSupportBot: 'Support (Bot)',
					votesTitle: 'Votes',
					enRoute: 'Distance',
					km: 'km',
					votes: 'Votes',
					startAlwaysIn: 'Start in',
					startIn: 'Start in',
					pickDirection: 'PICK A DIRECTION',
					radio: 'RADIO',
					hideMap: 'Hide map ▲',
					chatTitle: 'Chat & Gifts',
					chatPlaceholder: 'Message or 👑🎂🎁',
					send: '→',
					online: 'Online',
					nobody: 'Nobody yet',
					nowPlaying: 'Now playing',
					stop: '⏹️ Stop',
					closeBtn: 'Close',
					daysShort: 'd',
					hoursShort: 'h',
					participants: 'Players',
					championsLabel: 'Leaders',
				},
				zh: {
					menuTitle: '菜单',
					close: '关闭',
					menuNft: 'NFT 商店',
					menuDrivers: '所有司机',
					menuShop: '商店',
					menuSupportEmail: '支持（邮箱）',
					menuSupportBot: '支持（机器人）',
					votesTitle: '票数',
					enRoute: '里程',
					km: '公里',
					votes: '票',
					startAlwaysIn: '倒计时',
					startIn: '倒计时',
					pickDirection: '选择方向',
					radio: '收音机',
					hideMap: '隐藏地图 ▲',
					chatTitle: '聊天与礼物',
					chatPlaceholder: '输入消息或 👑🎂🎁',
					send: '→',
					online: '在线',
					nobody: '暂无用户',
					nowPlaying: '正在播放',
					stop: '⏹️ 停止',
					closeBtn: '关闭',
					daysShort: '天',
					hoursShort: '小时',
					participants: '玩家',
					championsLabel: '领袖',
				},
			};

			function t(k) {
				const d = DICT[window.currentLang] || DICT.ru;
				return d[k] || DICT.ru[k] || k;
			}
			function secSuffix() {
				return window.currentLang === 'ru'
					? 'с'
					: window.currentLang === 'zh'
					? '秒'
					: 's';
			}
			function setLang(lang) {
				window.currentLang = ['ru', 'en', 'zh'].includes(lang) ? lang : 'ru';
				localStorage.setItem('lang', window.currentLang);
				document.documentElement.lang = window.currentLang;
				applyTranslations();
			}
			function applyTranslations() {
				const set = (id, txt) => {
					const el = document.getElementById(id);
					if (el) el.textContent = txt;
				};
				set('i18n-menu-title', t('menuTitle'));
				set('i18n-close', t('close'));
				set('i18n-menu-nft', t('menuNft'));
				set('i18n-menu-drivers', t('menuDrivers'));
				set('i18n-menu-shop', t('menuShop'));
				const sm = document.getElementById('i18n-menu-support-mail');
				if (sm) sm.textContent = t('menuSupportEmail');
				const sb = document.getElementById('i18n-menu-support-bot');
				if (sb) sb.textContent = t('menuSupportBot');
				set('i18n-votes', t('votesTitle') + ':');
				set('i18n-champions', t('championsLabel'));
				set('i18n-pickdir', t('pickDirection'));
				set('i18n-radio', t('radio'));
				const hideBtn = document.getElementById('hideMapBtn');
				if (hideBtn) hideBtn.textContent = t('hideMap');
				const chatTitle = document.getElementById('i18n-chat-title');
				if (chatTitle) chatTitle.textContent = t('chatTitle');
				const chatInput = document.getElementById('chatInput');
				if (chatInput) chatInput.placeholder = t('chatPlaceholder');
				const sendBtn = document.getElementById('chatSendBtn');
				if (sendBtn) sendBtn.textContent = t('send');
				const tChip = document.getElementById('timerChip');
				if (tChip) {
					tChip.textContent = `${t('startAlwaysIn')}:`;
				}

				const sel = document.getElementById('langSelect');
				if (sel) sel.value = window.currentLang;
			}

			// Prevent Android long‑press system menu on audio, images and chat messages
			document.addEventListener(
				'contextmenu',
				function (e) {
					const t = e.target;
					if (!t) return;
					if (
						t.tagName === 'AUDIO' ||
						t.tagName === 'IMG' ||
						(t.closest && t.closest('.chat-message'))
					) {
						e.preventDefault();
						e.stopPropagation();
						return false;
					}
				},
				{ capture: true }
			);
			document.addEventListener('DOMContentLoaded', () => {
				setLang(localStorage.getItem('lang') || 'ru');

				const tg = window.Telegram && window.Telegram.WebApp;
				const u = tg && tg.initDataUnsafe && tg.initDataUnsafe.user;

				if (u && u.photo_url) {
					const img = document.querySelector('.avatar-card__img');
					if (img) {
						img.src = u.photo_url;
					}
				}
			});
		</script>

		<script>
			/* ===== CONFIG ===== */
			const ROUTE_URL = `${window.SUPABASE_URL}/rest/v1/route_points`;

			// Support links
			const SUPPORT_MAIL = 'mailto:tonroad.map@web.de';
			const SUPPORT_BOT = ''; // e.g. "https://t.me/YourBot"; keep empty to hide
			const CITIES = {
				Berlin: { lat: 52.519747, lng: 13.405104 },
				Leipzig: { lat: 51.337589, lng: 12.37106 },
				Dresden: { lat: 51.052473, lng: 13.740141 },
				Novorossiysk: { lat: 44.7243, lng: 37.76768 },
				Karaganda: { lat: 49.812974, lng: 73.086586 },
				Vienna: { lat: 48.206648, lng: 16.367441 },
				Moscow: { lat: 55.734001, lng: 37.612931 },
				SaintPetersburg: { lat: 59.86219, lng: 30.321149 },
				London: { lat: 51.509228, lng: -0.066898 },
				Paris: { lat: 48.869826, lng: 2.307674 },
				Konstanz: { lat: 47.664023, lng: 9.173386 },

				Astana: { lat: 51.1605, lng: 71.4704 },
				Washington: { lat: 38.9072, lng: -77.0369 },
				Rome: { lat: 41.9028, lng: 12.4964 },
				Monaco: { lat: 43.7384, lng: 7.4246 },
				Vatican: { lat: 41.9029, lng: 12.4534 },
				Istanbul: { lat: 41.0082, lng: 28.9784 },
				Dubai: { lat: 25.2048, lng: 55.2708 },
				Safari: { lat: 0.63, lng: 37.55 },
			};

			/* ===== STATE ===== */
			let panorama, mapPopup, mapRoutePath, droneMap, droneMarker;
			let droneInited = false;
			let routeHistory = {};
			let routeCarMarker; // маркер машинки на всплывающей карте
			let deadEnds = [];

			let selectedCity = localStorage.getItem('selectedCity') || 'Paris';
			let timerSeconds = parseInt(
				localStorage.getItem('timerSeconds') || '7',
				10
			);
			let moveSteps = parseInt(localStorage.getItem('moveSteps') || '1', 10);

			// keep in global window for UI (timer chip etc.)
			window.timerSeconds = timerSeconds;
			window.moveSteps = moveSteps;

			let votes = { left: 0, straight: 0, right: 0, backward: 0 };

			let timerValue = 0,
				timerActive = false,
				timerInterval = null;
			let hasVoted = !!localStorage.getItem(`voted_${selectedCity}`);
			let allowRotation = false;

			let fixedHeading = 0,
				fixedPitch = 0;
			let lastPosition = {};
			let forcedDirection = null;
			let isDriving = false;
			/* ===== COINS STATE ===== */
			let coinsTotal = parseInt(localStorage.getItem('coins_total') || '0', 10);
			let coinSpawnTimer = null;
			let coinAlive = false;

			let isEngineMuted = localStorage.getItem('engine_mute') === '1';
			let radioIsPlaying = false;
			let lastHonkAt = 0;

			/* speed delay (0=fastest) */

			// === ARROW VISIBILITY WIRING ===
			function attachArrowVisibilityListeners() {
				if (!panorama) return;
				// Снимаем старые, если уже были
				google.maps.event.clearListeners(panorama, 'links_changed');
				google.maps.event.clearListeners(panorama, 'pov_changed');
				// Вешаем заново
				panorama.addListener('links_changed', updateArrowVisibility);
				panorama.addListener('pov_changed', updateArrowVisibility);
				// Дать таймаут на появление ссылок
				setTimeout(updateArrowVisibility, 900);
			}

			/* ===== UTIL ===== */
			function computeHeading(from, to) {
				const lat1 = (from.lat * Math.PI) / 180,
					lng1 = (from.lng * Math.PI) / 180;
				const lat2 = (to.lat * Math.PI) / 180,
					lng2 = (to.lng * Math.PI) / 180;
				const dLng = lng2 - lng1;
				const y = Math.sin(dLng) * Math.cos(lat2);
				const x =
					Math.cos(lat1) * Math.sin(lat2) -
					Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLng);
				let brng = (Math.atan2(y, x) * 180) / Math.PI;
				return (brng + 360) % 360;
			}
			function fitViewport() {
				const cs = getComputedStyle(document.documentElement);
				const designH = parseInt(cs.getPropertyValue('--design-h')) || 760;
				const designW = parseInt(cs.getPropertyValue('--design-w')) || 422;
				const vw = window.innerWidth,
					vh = window.innerHeight;
				const scale = Math.min(1, vh / designH, vw / designW);
				document.documentElement.style.setProperty('--vh', vh * 0.01 + 'px');
				document.documentElement.style.setProperty('--scale', scale);
			}
			// Берём актуальную картинку машинки (как на панели)
			function getCarImageUrl() {
				// 1) что уже показано справа в HUD
				const carEl = document.getElementById('carModel');
				if (carEl && carEl.getAttribute('src'))
					return carEl.getAttribute('src');

				// 2) только магазинный слот машины
				const direct = localStorage.getItem('active_car_img');
				if (direct) return direct;

				// 3) дефолт
				return 'car.png';
			}

			// Иконка маркера для карт (одно изображение без поворота)
			function getCarMarkerIcon(size = 48) {
				const url = getCarImageUrl();
				return {
					url,
					scaledSize: new google.maps.Size(size, size),
					anchor: new google.maps.Point(size / 2, size / 2),
				};
			}

			// Обновить иконку машины на всех картах (когда что-то поменяли в магазине)
			function refreshCarIcon() {
				const icon48 = getCarMarkerIcon(48);
				const icon36 = getCarMarkerIcon(36);
				if (droneMarker) droneMarker.setIcon(icon48);
				if (routeCarMarker) routeCarMarker.setIcon(icon36);
			}
			/* ===== LEVEL SYSTEM SHARED WITH PROFILE ===== */
			const LEVEL_THRESHOLDS = [
				0, 10, 30, 60, 100, 160, 230, 310, 400, 500, 619, 741, 866, 994, 1125,
				1259, 1396, 1536, 1679, 1825, 1974, 2126, 2281, 2439, 2600, 2764, 2931,
				3101, 3274, 3449, 3627, 3808, 3992,
			];

			function calcLevel() {
				let coins = 0;
				try {
					const tg = window.Telegram && window.Telegram.WebApp;
					const u = tg && tg.initDataUnsafe && tg.initDataUnsafe.user;
					const uid = u && u.id ? String(u.id) : 'guest';
					coins = parseInt(
						localStorage.getItem(`coins_total_${uid}`) || '0',
						10
					);
				} catch (e) {
					// fallback на старый ключ, если вдруг что-то пойдёт не так
					coins = parseInt(localStorage.getItem('coins_total') || '0', 10);
				}

				let lvl = 1;
				for (let i = 0; i < LEVEL_THRESHOLDS.length; i++) {
					if (coins >= LEVEL_THRESHOLDS[i]) lvl = i + 1;
				}
				return lvl;
			}

			/* ===== COINS LOGIC ===== */
			/* ===== LEVEL-BASED FORMULAS ===== */

			// Returns max energy based on level
			function getMaxEnergyByLevel(level) {
				return 1440 + Math.floor((level - 1) / 5) * 120;
			}

			// Coins per click based on level
			function getIncomePerClick(level) {
				return 1.0 + Math.floor((level - 1) / 8) * 0.05;
			}

			// Energy regeneration per minute based on level
			function getEnergyRegenPerMin(level) {
				return 1.0 + Math.floor((level - 1) / 12) * 0.05;
			}

			// Bonus coins when reaching new level
			function getLevelBonusByCoinsRequired(req) {
				if (req === 0) return 0;
				if (req <= 100) return 5;
				if (req <= 500) return 10;
				if (req <= 2000) return 20;
				if (req <= 5000) return 50;
				return 100;
			}
			/* ===== LEVEL SYSTEM SHARED WITH PROFILE ===== */

			// Update playerLevel text in HUD
			function updateLevelUI() {
				const lvl = calcLevel();
				const el = document.getElementById('playerLevel');
				if (el) el.textContent = String(lvl);
			}
			updateLevelUI();

			/* ===== ENERGY SYSTEM (INSERTED) ===== */
			/* ===== ENERGY SYSTEM (INSERTED) ===== */
			(function () {
				// Keys
				const ENERGY_KEY = 'energy_current';
				const ENERGY_MAX_KEY = 'energy_max';
				const ENERGY_LAST_TS_KEY = 'energy_last_ts';

				// Settings
				function getRegenPerMinDynamic() {
					return getEnergyRegenPerMin(calcLevel());
				}

				// per minute
				const ENERGY_REGEN_MS = 60_000; // timer tick
				const ENERGY_PER_COIN_CLICK = 60; // cost per coin click
				const DEFAULT_MAX_ENERGY = getMaxEnergyByLevel(calcLevel());

				const START_WITH_FULL = true;

				// Init
				function ensureEnergyKeys() {
					if (localStorage.getItem(ENERGY_MAX_KEY) === null) {
						localStorage.setItem(ENERGY_MAX_KEY, String(DEFAULT_MAX_ENERGY));
					}
					if (localStorage.getItem(ENERGY_KEY) === null) {
						const maxv = Number(
							localStorage.getItem(ENERGY_MAX_KEY) || DEFAULT_MAX_ENERGY
						);
						const start = START_WITH_FULL ? maxv : maxv;
						localStorage.setItem(ENERGY_KEY, String(start));
					}
					if (localStorage.getItem(ENERGY_LAST_TS_KEY) === null) {
						localStorage.setItem(ENERGY_LAST_TS_KEY, String(Date.now()));
					}
				}
				ensureEnergyKeys();

				// UI element for energy number
				function findEnergyDomEl() {
					const candidates = document.querySelectorAll('.list-stat-link');
					for (const node of candidates) {
						const img = node.querySelector('img');
						if (!img) continue;
						const src =
							img.getAttribute('src') ||
							img.getAttribute('data-default-src') ||
							'';
						if (src.includes('energy.png') || src.includes('energy')) {
							const span = node.querySelector('.list-stat-link__text');
							if (span) return span;
						}
					}
					const all = document.querySelectorAll('.list-stat-link__text');
					if (all && all.length >= 2) return all[1];
					return null;
				}
				const energyDom = findEnergyDomEl();

				// API helpers
				function getMaxEnergy() {
					return Math.max(
						0,
						Number(localStorage.getItem(ENERGY_MAX_KEY) || DEFAULT_MAX_ENERGY)
					);
				}
				function setMaxEnergy(n) {
					const v = Math.max(0, Math.floor(n));
					localStorage.setItem(ENERGY_MAX_KEY, String(v));
					updateEnergyUI();
				}
				function getEnergy() {
					return Math.max(0, Number(localStorage.getItem(ENERGY_KEY) || 0));
				}
				function setEnergy(n) {
					const maxv = getMaxEnergy();
					const v = Math.max(0, Math.min(maxv, Math.floor(n)));
					localStorage.setItem(ENERGY_KEY, String(v));
					// update "last touched" timestamp
					localStorage.setItem(ENERGY_LAST_TS_KEY, String(Date.now()));
					updateEnergyUI();
					return v;
				}
				function addEnergy(n) {
					return setEnergy(getEnergy() + Number(n || 0));
				}
				function consumeEnergy(n) {
					const cur = getEnergy();
					if (cur < n) return false;
					setEnergy(cur - n);
					return true;
				}

				// Offline regen: apply energy based on time difference
				function applyOfflineRegen() {
					const now = Date.now();
					const lastStr = localStorage.getItem(ENERGY_LAST_TS_KEY);
					if (!lastStr) {
						localStorage.setItem(ENERGY_LAST_TS_KEY, String(now));
						return;
					}
					const last = parseInt(lastStr, 10) || 0;
					if (last <= 0) {
						localStorage.setItem(ENERGY_LAST_TS_KEY, String(now));
						return;
					}

					const diffMs = now - last;
					if (diffMs < 60_000) {
						return; // less than a minute passed
					}

					const minutes = Math.floor(diffMs / 60_000);
					if (minutes <= 0) return;

					const maxv = getMaxEnergy();
					const cur = getEnergy();
					if (cur >= maxv) {
						localStorage.setItem(ENERGY_LAST_TS_KEY, String(now));
						return;
					}

					const gained = minutes * getRegenPerMinDynamic();

					const next = Math.min(maxv, cur + gained);
					setEnergy(next);
					localStorage.setItem(ENERGY_LAST_TS_KEY, String(now));
				}

				// UI update
				function updateEnergyUI() {
					const el = energyDom || document.querySelector('#energyAmount');
					if (!el) return;
					el.textContent = String(getEnergy());
					const maxv = getMaxEnergy();
					el.title = `Energy: ${getEnergy()} / ${maxv}`;
				}

				// Regen loop while app is open (keeps "last_ts" fresh)
				let energyRegenInterval = null;

				function startEnergyRegen() {
					if (energyRegenInterval) return;
					energyRegenInterval = setInterval(() => {
						const prev = getEnergy();
						const maxv = getMaxEnergy();
						if (prev >= maxv) return;
						const regen = getRegenPerMinDynamic();
						const next = Math.min(maxv, prev + regen);

						setEnergy(next);
						localStorage.setItem(ENERGY_LAST_TS_KEY, String(Date.now()));
					}, ENERGY_REGEN_MS);
				}

				// Init: first apply offline regen, then start online loop
				setTimeout(() => {
					applyOfflineRegen();
					updateEnergyUI();
				}, 200);

				startEnergyRegen();

				// Public helpers
				window.gameEnergy = {
					get: getEnergy,
					max: getMaxEnergy,
					set: setEnergy,
					add: addEnergy,
					consume: consumeEnergy,
					grant: function (n) {
						addEnergy(n);
						try {
							const t = document.createElement('div');
							t.textContent = `+${n} energy`;
							Object.assign(t.style, {
								position: 'fixed',
								left: '50%',
								top: '18px',
								transform: 'translateX(-50%)',
								background: '#222',
								color: '#fff',
								padding: '8px 12px',
								borderRadius: '10px',
								zIndex: 6000,
								fontWeight: 900,
								opacity: 0,
								transition: 'opacity .18s',
							});
							document.body.appendChild(t);
							requestAnimationFrame(() => (t.style.opacity = '1'));
							setTimeout(() => {
								t.style.opacity = '0';
								setTimeout(() => t.remove(), 180);
							}, 1200);
						} catch (e) {}
					},
					setMax: setMaxEnergy,
				};

				// When tab becomes visible again, recalc offline regen
				document.addEventListener('visibilitychange', () => {
					if (document.visibilityState === 'visible') {
						applyOfflineRegen();
						updateEnergyUI();
					}
				});
			})();

			// send coins to Supabase
			async function sendCoinsToServer(amount) {
				const user = getCurrentUser();
				if (!user || !user.id) return;

				try {
					await fetch(
						`${window.SUPABASE_URL}/rest/v1/rpc/increment_user_counters`,
						{
							method: 'POST',
							headers: {
								apikey: window.SUPABASE_ANON_KEY,
								Authorization: `Bearer ${window.SUPABASE_ANON_KEY}`,
								'Content-Type': 'application/json',
							},
							body: JSON.stringify({
								p_user_id: user.id,
								p_clicks_delta: 0,
								p_stars_delta: 0,
								p_coins_delta: amount,
								p_votes_delta: 0,
							}),
						}
					);
				} catch (e) {
					console.warn('sendCoinsToServer error', e);
				}
			}

			function updateCoinsUI() {
				const el = document.getElementById('scoreCoins');
				if (el) el.textContent = String(coinsTotal);
			}

			// TEST MODE: тест тест тест нвая ситсемм TEST MODE: referral activation unlimited
			const REFERRAL_TEST_MODE = true;

			function addCoins(n) {
				const delta = Number(n) || 0;
				if (!delta) return;

				coinsTotal += delta;
				localStorage.setItem(
					`coins_total_${getCurrentUser().id}`,
					String(coinsTotal)
				);
				updateCoinsUI();
			}

			// === ЗАМЕНА coinAreaRect НА ВОТ ЭТО ===
			function coinAreaBoxLocal() {
				// локальные (немасштабированные) размеры app
				const app = document.querySelector('.app');
				const cs = getComputedStyle(document.documentElement);
				const headerH = parseInt(cs.getPropertyValue('--header-h')) || 150;
				const footerH = parseInt(cs.getPropertyValue('--footer-h')) || 188;
				const scale = parseFloat(cs.getPropertyValue('--scale')) || 1;

				// реальный пиксельный rect на странице
				const rect = app.getBoundingClientRect();

				// размеры app в локальных координатах (до transform)
				const appW = rect.width / scale;
				const appH = rect.height / scale;

				const pad = 12; // уже локальные px
				const top = headerH + pad;
				const bottom = appH - footerH - pad;
				const left = pad;
				const right = appW - pad;

				return {
					top,
					bottom,
					left,
					right,
					scale,
					appLeft: rect.left,
					appTop: rect.top,
				};
			}

			// === ЗАМЕНА spawnCoinOnce НА ВОТ ЭТО ===
			// ЗАМЕНА: новая версия spawnCoinOnce
			function spawnCoinOnce() {
				if (coinAlive) return;
				const layer = document.getElementById('coinLayer');
				if (!layer) return;

				const box = coinAreaBoxLocal();
				if (box.bottom - box.top < 80 || box.right - box.left < 80) return;

				const xLocal = Math.random() * (box.right - box.left - 54) + box.left;
				const yLocal = Math.random() * (box.bottom - box.top - 54) + box.top;

				const img = document.createElement('img');
				img.src = 'coin.png';
				img.className = 'coin';
				img.style.left = `${xLocal}px`;
				img.style.top = `${yLocal}px`;

				let resolved = false;

				const removeCoin = () => {
					if (!img.parentNode) return;
					img.style.opacity = '0';
					img.style.transform += ' scale(1.15)';
					setTimeout(() => img.remove(), 160);
					coinAlive = false;
				};

				img.addEventListener(
					'click',
					async () => {
						if (resolved) return;
						resolved = true;

						// проверяем энергию
						try {
							if (
								!window.gameEnergy ||
								typeof window.gameEnergy.consume !== 'function'
							) {
								// если энергия не инициализирована — просто даём монету (совместимость)
								addCoins(getIncomePerClick(calcLevel()));

								await incrementClicksTotal(5);
								playSound('coinSound');
								removeCoin();
								return;
							}

							const ok = window.gameEnergy.consume(60); // ENERGY_PER_COIN_CLICK
							if (!ok) {
								// мало энергии — звук и сообщение
								playSound('coinMissSound');
								// покачать coin и показать сообщение
								try {
									img.style.transform += ' translateY(-6px)';
									(function flash() {
										img.style.opacity = '0.7';
										setTimeout(() => (img.style.opacity = '1'), 120);
									})();
								} catch (e) {}
								// неперебивное сообщение
								try {
									const t = document.createElement('div');
									t.textContent = 'Недостаточно энергии';
									Object.assign(t.style, {
										position: 'fixed',
										left: '50%',
										top: '18px',
										transform: 'translateX(-50%)',
										background: '#ff4d57',
										color: '#fff',
										padding: '8px 12px',
										borderRadius: '10px',
										zIndex: 6500,
										fontWeight: 900,
									});
									document.body.appendChild(t);
									setTimeout(() => t.remove(), 1400);
								} catch (e) {}
								// apply coin miss flow (decrement clicks total small penalty if exists)
								try {
									await incrementClicksTotal(0);
								} catch (_) {}
								removeCoin();
								return;
							}

							// успешный сбор
							addCoins(1);
							sendCoinsToServer(1);

							await incrementClicksTotal(5);
							playSound('coinSound');
						} finally {
							removeCoin();
						}
					},
					{ passive: true }
				);

				layer.appendChild(img);
				coinAlive = true;

				setTimeout(async () => {
					if (resolved || !coinAlive) return;
					resolved = true;
					try {
						await incrementClicksTotal(0);
						playSound('coinMissSound');
					} finally {
						removeCoin();
					}
				}, 5000);
			}

			function maybeSpawnCoin() {
				if (!isDriving) return;
				const chance = 0.35; // 35% per step
				if (Math.random() < chance) spawnCoinOnce();
			}

			/* ===== USER ===== */
			function getCurrentUser() {
				if (
					window.Telegram &&
					Telegram.WebApp &&
					Telegram.WebApp.initDataUnsafe.user
				) {
					const tgUser = Telegram.WebApp.initDataUnsafe.user;

					// displayName = username, иначе first + last, иначе fallback
					let displayName = tgUser.username || '';
					if (!displayName) {
						displayName =
							(tgUser.first_name || '') +
							(tgUser.last_name ? ' ' + tgUser.last_name : '');
						displayName = displayName.trim();
					}
					if (!displayName) {
						displayName = 'Driver';
					}

					return {
						id: String(tgUser.id),
						username: displayName,
						photo_url: tgUser.photo_url || null,
					};
				}

				// guests (без Telegram) – будут только читать, не писать
				let guestId = localStorage.getItem('guest_id');
				if (!guestId) {
					guestId = 'guest_' + Math.random().toString(36).substr(2, 9);
					localStorage.setItem('guest_id', guestId);
				}
				return { id: guestId, username: 'Guest', photo_url: null };
			}
			// === COINS SYNC (local <-> server, server is source of truth) ===

			// === FINAL SAFE SYNC (local <-> server) ===
			async function syncCoinsFromServer() {
				try {
					const user = getCurrentUser();
					if (
						!user ||
						!user.id ||
						!window.SUPABASE_URL ||
						!window.SUPABASE_ANON_KEY
					)
						return;

					// читаем монеты сервера
					const url = `${
						window.SUPABASE_URL
					}/rest/v1/users?select=coins_total&user_id=eq.${encodeURIComponent(
						user.id
					)}&limit=1`;

					const res = await fetch(url, {
						headers: {
							apikey: window.SUPABASE_ANON_KEY,
							Authorization: `Bearer ${window.SUPABASE_ANON_KEY}`,
						},
					});
					if (!res.ok) return;

					const arr = await res.json().catch(() => null);
					if (!Array.isArray(arr) || arr.length === 0) return;

					const remote = parseInt(arr[0]?.coins_total ?? 0, 10);
					if (Number.isNaN(remote)) return;

					const local = coinsTotal;

					// === 1) Сервер > локалка → подтягиваем локалку (доходы от рефералов) ===
					if (remote > local) {
						coinsTotal = remote;
						localStorage.setItem(`coins_total_${user.id}`, String(coinsTotal));
						updateCoinsUI();
						return;
					}

					// === 2) Локалка > сервер → сервер догоняет локалку (ловля монет, покупки) ===
					if (local > remote) {
						const delta = local - remote; // может быть отрицательным (после покупки)
						try {
							await sendCoinsToServer(delta);
						} catch (e) {
							console.warn('sync delta error', e);
						}
						return;
					}

					// === 3) Равны → ничего не делаем ===
				} catch (e) {
					console.warn('syncCoinsFromServer error', e);
				}
			}

			// запуск синхронизации каждые 5 секунд
			function startCoinsSyncWhenUserReady() {
				const u = getCurrentUser();
				if (!u || !u.id || u.id.startsWith('guest')) {
					// Telegram user ещё НЕ ЗАГРУЖЕН → ждём
					setTimeout(startCoinsSyncWhenUserReady, 200);
					return;
				}

				// Теперь user.id НАСТОЯЩИЙ
				console.log('SYNC STARTED FOR USER:', u.id);

				// Загружаем локальные монеты ЭТОГО пользователя
				coinsTotal = parseInt(
					localStorage.getItem(`coins_total_${u.id}`) || '0',
					10
				);
				updateCoinsUI();

				// Запускаем синхронизацию
				setInterval(syncCoinsFromServer, 5000);
			}

			// Запускаем механизм ожидания загрузки Telegram user
			startCoinsSyncWhenUserReady();

			// === ROUTE API (route_points) ===

			// === ROUTE API (route_points) ===
			async function saveRoutePoint(city, lat, lng) {
				const r = await fetch(`${window.SUPABASE_URL}/rest/v1/route_points`, {
					method: 'POST',
					headers: {
						apikey: window.SUPABASE_ANON_KEY,
						Authorization: `Bearer ${window.SUPABASE_ANON_KEY}`,
						'Content-Type': 'application/json',
						Prefer: 'return=minimal',
					},
					body: JSON.stringify({ city, lat, lng }),
				});
				if (!r.ok) {
					console.warn('saveRoutePoint failed:', r.status, await r.text());
				}
			}

			async function loadRoute(city) {
				const res = await fetch(
					`${ROUTE_URL}?city=eq.${city}&select=lat,lng,created_at&order=created_at.asc`,
					{
						headers: {
							apikey: window.SUPABASE_ANON_KEY,
							Prefer: 'count=exact',
						},
					}
				);
				const arr = await res.json();
				// Возвращаем и координаты, и время
				return Array.isArray(arr)
					? arr.map(p => ({
							lat: p.lat,
							lng: p.lng,
							ts: p.created_at ? new Date(p.created_at).getTime() : null,
					  }))
					: [];
			}
			function pointsToLatLng(points) {
				return points.map(p => ({ lat: p.lat, lng: p.lng }));
			}
			function getRouteHours(points) {
				if (!points || points.length < 2) return 0;
				// берем первую и последнюю метку времени
				const first = points.find(p => p.ts);
				const last = [...points].reverse().find(p => p.ts);
				if (!first || !last || !first.ts || !last.ts) return 0;
				const ms = Math.max(0, last.ts - first.ts);
				return ms / 3600000; // часы
			}
			async function getVotesTotal(city) {
				const candidates = ['votes', 'votes_log', 'votes_history']; // перебор возможных имён
				for (const table of candidates) {
					try {
						const url = `${window.SUPABASE_URL}/rest/v1/${table}?city=eq.${city}&select=id`;
						const res = await fetch(url, {
							headers: {
								apikey: window.SUPABASE_ANON_KEY,
								Prefer: 'count=exact',
							},
						});
						// В Supabase счёт лежит в Content-Range: items 0-.../TOTAL
						const cr = res.headers.get('Content-Range');
						if (cr && /\/\d+$/i.test(cr)) {
							const total = parseInt(cr.split('/').pop() || '0', 10);
							if (!Number.isNaN(total)) return total;
						}
						// fallback: если API вернул массив без заголовка
						const data = await res.json().catch(() => []);
						if (Array.isArray(data)) return data.length;
					} catch (_) {}
				}
				return 0;
			}

			async function clearRoute(city) {
				await fetch(`${ROUTE_URL}?city=eq.${city}`, {
					method: 'DELETE',
					headers: { apikey: window.SUPABASE_ANON_KEY },
				});
			}

			/* ===== SUPABASE ===== */
			async function getLastPosition(city) {
				// 1) читаем последнюю позицию
				const resp = await fetch(
					`${window.SUPABASE_URL}/rest/v1/current_position?city=eq.${city}&select=lat,lng,heading&limit=1`,
					{ headers: { apikey: window.SUPABASE_ANON_KEY } }
				);
				const data = await resp.json();
				if (Array.isArray(data) && data.length) {
					return {
						lat: data[0].lat,
						lng: data[0].lng,
						heading: data[0].heading || 0,
					};
				}

				// 2) записи ещё нет — создаём её ИДЕМПОТЕНТНО (upsert по city)
				const def = CITIES[city];
				await fetch(
					`${window.SUPABASE_URL}/rest/v1/current_position?on_conflict=city`,
					{
						method: 'POST',
						headers: {
							apikey: window.SUPABASE_ANON_KEY,
							Authorization: `Bearer ${window.SUPABASE_ANON_KEY}`,
							'Content-Type': 'application/json',
							Prefer: 'resolution=merge-duplicates,return=minimal',
						},
						body: JSON.stringify({
							city,
							lat: def.lat,
							lng: def.lng,
							heading: 0,
						}),
					}
				);

				// 3) возвращаем дефолт — дальше код уже синхронизирует setLastPosition(...)
				return { lat: def.lat, lng: def.lng, heading: 0 };
			}

			// ДОЛЖНО БЫТЬ ТАК
			async function setLastPosition(city, lat, lng, heading) {
				const res = await fetch(
					`${window.SUPABASE_URL}/rest/v1/current_position?on_conflict=city`,
					{
						method: 'POST',
						headers: {
							apikey: window.SUPABASE_ANON_KEY,
							Authorization: `Bearer ${window.SUPABASE_ANON_KEY}`,
							'Content-Type': 'application/json',
							Prefer: 'resolution=merge-duplicates,return=minimal',
						},
						body: JSON.stringify({ city, lat, lng, heading }),
					}
				);
				if (!res.ok) {
					console.warn(
						'setLastPosition upsert failed:',
						res.status,
						await res.text()
					);
				}
			}

			async function loadSyncedSettings() {
				const resp = await fetch(
					`${window.SUPABASE_URL}/rest/v1/sync_settings?city=eq.${selectedCity}&select=steps,seconds,updated_at&order=updated_at.desc&limit=1`,
					{ headers: { apikey: window.SUPABASE_ANON_KEY } }
				);
				const data = await resp.json();
				if (data && data.length) {
					if (typeof data[0].steps === 'number') {
						moveSteps = data[0].steps;
						localStorage.setItem('moveSteps', moveSteps);
					}
					if (typeof data[0].seconds === 'number') {
						timerSeconds = data[0].seconds;
						localStorage.setItem('timerSeconds', timerSeconds);
					}
					// sync to window for UI
					window.moveSteps = moveSteps;
					window.timerSeconds = timerSeconds;
				}
			}

			async function updateVotes() {
				const url = `${window.SUPABASE_URL}/rest/v1/votes_summary?select=direction,count&city=eq.${selectedCity}&mode=eq.voting`;
				const res = await fetch(url, {
					headers: { apikey: window.SUPABASE_ANON_KEY },
				});
				const data = await res.json();
				votes = { left: 0, straight: 0, right: 0, backward: 0 };
				let total = 0;
				data.forEach(v => {
					votes[v.direction] = v.count;
					total += v.count;
				});
				document.getElementById('vLeft').textContent = votes.left || 0;
				document.getElementById('vStraight').textContent = votes.straight || 0;
				document.getElementById('vRight').textContent = votes.right || 0;
				document.getElementById('vBack').textContent = votes.backward || 0;
				rotateWheelToLeader();

				// timer visibility logic
				if (total === 0) {
					// Показываем "Старт через:" (без секунд)
					if (timerChipEl) {
						timerChipEl.classList.add('active');
					}
					if (!timerActive && !isDriving) resetTimer();

					// anti-stale local lock: if server has 0, allow re-vote
					if (hasVoted) {
						hasVoted = false;
						localStorage.removeItem(`voted_${selectedCity}`);
					}
				} else {
					if (!timerActive && !isDriving) startTimer();
				}
			}
			async function castVote(dir, { instant = false } = {}) {
				if (hasVoted) return;

				let ok = false;
				try {
					const r = await fetch(
						`${window.SUPABASE_URL}/functions/v1/cast_vote-ts`,
						{
							method: 'POST',
							headers: {
								'Content-Type': 'application/json',
								apikey: window.SUPABASE_ANON_KEY,
								Authorization: `Bearer ${window.SUPABASE_ANON_KEY}`,
							},
							body: JSON.stringify({
								city: selectedCity,
								mode: 'voting',
								direction: dir,
							}),
						}
					);
					ok = r.ok;
				} catch (e) {
					ok = false;
				}

				if (!ok) {
					// do NOT mark hasVoted on failure
					try {
						await incrementClicksTotal();
					} catch (_) {}
					// Let user click again; no local lock
					return;
				}

				// backend accepted the vote -> lock locally
				try {
					await incrementClicksTotal();
				} catch (_) {}
				hasVoted = true;
				localStorage.setItem(`voted_${selectedCity}`, '1');

				setWheelAngle(dirToAngle(dir));

				// Start countdown immediately; do not wait for polling lag
				if (!timerActive && !isDriving) startTimer();

				// Refresh UI counts (might still be catching up, but harmless)
				await updateVotes();
			}

			async function incrementClicksTotal(delta = 1) {
				const user = getCurrentUser();
				if (!user || !user.id) return;

				const d = Number(delta) || 0;

				try {
					const res = await fetch(
						`${window.SUPABASE_URL}/rest/v1/rpc/increment_user_counters`,
						{
							method: 'POST',
							headers: {
								apikey: window.SUPABASE_ANON_KEY,
								Authorization: `Bearer ${window.SUPABASE_ANON_KEY}`,
								'Content-Type': 'application/json',
							},
							body: JSON.stringify({
								p_user_id: user.id,
								p_clicks_delta: d,
								p_stars_delta: 0,
								p_coins_delta: 0,
								p_votes_delta: 0,
							}),
						}
					);

					// (не обязательно, но полезно держать локальный UI в актуальном состоянии)
					if (res.ok) {
						const rows = await res.json().catch(() => null);
						const updated = Number(rows?.[0]?.clicks_total);
						if (Number.isFinite(updated)) {
							// если где-то показываешь «мой баланс» на HUD — обнови DOM как нужно
							// например: document.querySelector('[data-my-clicks]')?.textContent = String(updated);
						}
					} else {
						console.warn('increment_user_counters failed', await res.text());
					}
				} catch (e) {
					console.warn('incrementClicksTotal exception', e);
				}
			}

			/* upsert for "apply all" */
			async function syncSettingsToServer() {
				// silent no-op: не показываем алерты и ничего не пишем
				return;
			}

			/* ===== WHEEL CONTROL ===== */
			function leaderDirection() {
				const order = ['straight', 'left', 'right', 'backward'];
				const entries = Object.entries(votes);
				let max = -1,
					leaders = [];
				for (const [d, c] of entries) {
					if (c > max) {
						max = c;
						leaders = [d];
					} else if (c === max) {
						leaders.push(d);
					}
				}
				if (max <= 0) return 'straight';
				return order.find(d => leaders.includes(d)) || leaders[0];
			}
			function dirToAngle(dir) {
				switch (dir) {
					case 'left':
						return -90;
					case 'right':
						return 90;
					case 'backward':
						return 180;
					case 'straight':
					default:
						return 0;
				}
			}
			function setWheelAngle(deg) {
				const w = document.getElementById('wheelImg');
				if (w) w.style.transform = `rotate(${deg}deg)`;
			}
			function rotateWheelToLeader() {
				if (!forcedDirection) setWheelAngle(dirToAngle(leaderDirection()));
			}
			function resetWheel() {
				setWheelAngle(0);
			}

			/* ===== SV CAMERA ===== */
			/* ===== SV CAMERA ===== */
			function updateRotationUi() {
				const btn = document.getElementById('toggle-rotation');
				const blocker = document.getElementById('block-touch');
				btn.textContent = '';
				btn.classList.toggle('active', allowRotation);
				blocker.style.pointerEvents = allowRotation ? 'none' : 'auto';
				// важное: синхронизируем motion tracking
				applyMotionTracking();
			}

			function applyMotionTracking() {
				if (!panorama) return;
				// Когда allowRotation=false — полностью глушим гироскоп и любые автоповороты POV
				// Когда true — разрешаем гироскоп
				try {
					panorama.setOptions({
						motionTracking: allowRotation,
						motionTrackingControl: false, // не показывать кнопку
					});
				} catch (e) {}
			}

			function lockCamera() {
				// чистим предыдущие слушатели
				if (!panorama) return;
				google.maps.event.clearListeners(panorama, 'pov_changed');

				if (!allowRotation) {
					// фиксируем POV и подавляем любые изменения
					panorama.addListener('pov_changed', function () {
						const pov = panorama.getPov();
						if (
							Math.abs(pov.heading - fixedHeading) > 1 ||
							Math.abs(pov.pitch - fixedPitch) > 1
						) {
							panorama.setPov({ heading: fixedHeading, pitch: fixedPitch });
						}
					});
				}
				// синхронизируем состояние гироскопа
				applyMotionTracking();
			}

			function setStreetViewTo(lat, lng, heading = 0) {
				const sv = new google.maps.StreetViewService();
				sv.getPanorama(
					{
						location: { lat, lng },
						radius: 120,
						source: google.maps.StreetViewSource.OUTDOOR,
					},
					function (data, status) {
						if (status === google.maps.StreetViewStatus.OK) {
							panorama.setPano(data.location.pano);
							fixedHeading = heading;
							fixedPitch = 0;
							panorama.setPov({ heading: fixedHeading, pitch: fixedPitch });
							panorama.setVisible(true);
							setTimeout(() => {
								lockCamera();
								updateArrowVisibility();
							}, 300);
						} else {
							panorama.setVisible(false);
						}
					}
				);
			}

			/* ===== DRONE ===== */
			function initDroneMap(pos) {
				droneMap = new google.maps.Map(document.getElementById('drone-map'), {
					center: pos,
					zoom: 18,
					mapTypeId: 'satellite',
				});
				droneMarker = new google.maps.Marker({
					position: pos,
					map: droneMap,
					icon: getCarMarkerIcon(48), // машинка из магазина
				});

				droneInited = true;
			}
			function switchToDrone() {
				document.getElementById('street-view').style.display = 'none';
				document.getElementById('drone-map').style.display = 'block';
				const pos = panorama
					? panorama.getPosition()
					: new google.maps.LatLng(
							CITIES[selectedCity].lat,
							CITIES[selectedCity].lng
					  );
				if (!droneInited) initDroneMap(pos);
				else {
					droneMarker.setPosition(pos);
					droneMap.setCenter(pos);
				}
			}
			function switchToCar() {
				document.getElementById('drone-map').style.display = 'none';
				document.getElementById('street-view').style.display = 'block';
				if (
					lastPosition &&
					typeof lastPosition.lat !== 'undefined' &&
					typeof lastPosition.lng !== 'undefined'
				) {
					setStreetViewTo(
						lastPosition.lat,
						lastPosition.lng,
						lastPosition.heading || 0
					);
				}
			}

			/* ===== MAP POPUP ===== */
			function showMapPopup() {
				const popup = document.getElementById('mapPopup');
				const panel = document.getElementById('mapPanel');
				if (!popup || !panel) return;

				// show overlay
				popup.style.display = 'block';

				// start slide-in animation
				requestAnimationFrame(function () {
					panel.style.transform = 'translateX(0)';
				});

				// refresh map and route
				try {
					if (typeof drawRouteOnMap === 'function') {
						drawRouteOnMap();
					}
					if (
						typeof google !== 'undefined' &&
						typeof mapPopup !== 'undefined' &&
						mapPopup
					) {
						google.maps.event.trigger(mapPopup, 'resize');
					}
				} catch (e) {
					console.warn('showMapPopup error', e);
				}
			}

			function hideMapPopup() {
				const popup = document.getElementById('mapPopup');
				const panel = document.getElementById('mapPanel');
				if (!popup || !panel) return;

				// slide-out animation
				panel.style.transform = 'translateX(-100%)';

				// hide overlay after animation
				setTimeout(function () {
					popup.style.display = 'none';
				}, 250);
			}

			function drawRouteOnMap() {
				if (!routeHistory[selectedCity]?.length) return;
				mapRoutePath.setPath(routeHistory[selectedCity]);
				mapPopup.setCenter(
					routeHistory[selectedCity][routeHistory[selectedCity].length - 1]
				);
			}

			function markDeadEnd(pos) {
				deadEnds.push(pos);
				// Покажи череп на карте
				if (mapPopup) {
					new google.maps.Marker({
						position: pos,
						map: mapPopup,
						icon: {
							url: 'skull.png', // добавь свой файл (или png, или svg, или emoji)
							scaledSize: new google.maps.Size(36, 36),
						},
					});
				}
			}

			/* ===== SOUND ===== */
			const carAudio = document.getElementById('carAudio');
			function stopCarSound() {
				if (!carAudio) return;
				carAudio.pause();
				carAudio.currentTime = 0;
				carAudio.loop = false;
			}
			function engineTargetVolume(mode) {
				const base = mode === 'drive' ? 0.9 : 0.35;
				return radioIsPlaying ? Math.min(0.12, base * 0.2) : base;
			}
			function enginePlay(mode) {
				if (!carAudio || isEngineMuted) return;
				const v = engineTargetVolume(mode);
				carAudio.volume = v;
				carAudio.loop = true;
				carAudio.muted = false;
				if (carAudio.paused) {
					carAudio.currentTime = 0;
					carAudio.play().catch(() => {});
				}
			}
			function updateEngineBtn() {
				const b = document.getElementById('toggle-engine');
				if (!b) return;
				b.textContent = '';

				b.classList.toggle('off', isEngineMuted);
			}
			function applyEngineMute() {
				if (carAudio) carAudio.muted = isEngineMuted;
			}

			/* horn */
			function honk() {
				const horn = document.getElementById('hornAudio');
				if (!horn) return;
				const now = Date.now();
				if (now - lastHonkAt < 400) return;
				lastHonkAt = now;
				try {
					horn.currentTime = 0;
					horn.play().catch(() => {});
				} catch (e) {}
			}
			function playSound(id) {
				const el = document.getElementById(id);
				if (!el) return;
				try {
					el.currentTime = 0;
					el.play().catch(() => {});
				} catch (e) {}
			}

			/* ===== TIMER / DRIVE ===== */
			const timerChipEl = document.getElementById('timerChip');

			/**
			 * Стартуем однократный отсчёт при первом голосе.
			 * Повторные клики НЕ перезапускают таймер, т.к. timerActive=true.
			 */
			function startTimer() {
				if (timerActive) return;
				if (!timerChipEl) {
					drive();
					return;
				}
				timerValue = Math.max(1, Number(timerSeconds) || 7);
				timerActive = true;
				timerChipEl.textContent = `${t(
					'startIn'
				)}: ${timerValue}${secSuffix()}`;
				timerChipEl.classList.add('active');
				try {
					enginePlay('idle');
				} catch (e) {}
				if (timerInterval) clearInterval(timerInterval);
				timerInterval = setInterval(() => {
					timerValue--;
					if (timerValue > 0) {
						timerChipEl.textContent = `${t(
							'startIn'
						)}: ${timerValue}${secSuffix()}`;
					} else {
						clearInterval(timerInterval);
						timerInterval = null;
						timerActive = false;
						timerChipEl.classList.remove('active');
						drive();
					}
				}, 1000);
			}

			function resetTimer() {
				if (timerInterval) {
					clearInterval(timerInterval);
					timerInterval = null;
				}
				timerActive = false;
				timerValue = 0;
				if (timerChipEl) {
					timerChipEl.textContent = `${t('startAlwaysIn')}:`;
					timerChipEl.classList.add('active');
				}
			}

			let speedMode = localStorage.getItem('speedMode') || 'normal';

			const SPEED = {
				slow: { targetStepMs: 2000, zoomMs: 600, zoomFrom: 0.8, zoomTo: 1.0 },
				normal: { targetStepMs: 1100, zoomMs: 300, zoomFrom: 0.9, zoomTo: 1.0 },
				fast: { targetStepMs: 320, zoomMs: 80, zoomFrom: 0.96, zoomTo: 1.0 },
			};

			function zoomPulse(ms, from, to) {
				if (!panorama || ms <= 0) return Promise.resolve();
				return new Promise(resolve => {
					const t0 = performance.now();
					function tick(t) {
						const p = Math.min(1, (t - t0) / ms);
						const z = from + (to - from) * p;
						try {
							panorama.setZoom(z);
						} catch {}
						if (p < 1) requestAnimationFrame(tick);
						else resolve();
					}
					try {
						panorama.setZoom(from);
					} catch {}
					requestAnimationFrame(tick);
				});
			}

			function ensureLinksReady(timeoutMs = 7000) {
				return new Promise((resolve, reject) => {
					if (!panorama) return reject(new Error('no-panorama'));

					const hasLinks = () => {
						try {
							const arr = panorama.getLinks() || [];
							return arr.length > 0;
						} catch (e) {
							return false;
						}
					};

					if (hasLinks()) return resolve();

					const timer = setTimeout(() => {
						cleanup();
						reject(new Error('links-timeout'));
					}, timeoutMs);

					const onLinks = panorama.addListener('links_changed', () => {
						if (hasLinks()) {
							cleanup();
							resolve();
						}
					});

					const onPano = panorama.addListener('pano_changed', () => {
						if (hasLinks()) {
							cleanup();
							resolve();
						}
					});

					function cleanup() {
						clearTimeout(timer);
						if (onLinks) google.maps.event.removeListener(onLinks);
						if (onPano) google.maps.event.removeListener(onPano);
					}
				});
			}

			function findBestLink(direction) {
				if (!panorama) throw new Error('no-panorama');
				let links = [];
				try {
					links = panorama.getLinks() || [];
				} catch (e) {
					links = [];
				}
				if (!links.length) throw new Error('no-links');

				const base =
					typeof fixedHeading === 'number'
						? fixedHeading
						: panorama.getPov()?.heading || 0;

				let target = base;
				switch (direction) {
					case 'left':
						target = (base - 90 + 360) % 360;
						break;
					case 'right':
						target = (base + 90) % 360;
						break;
					case 'backward':
						target = (base + 180) % 360;
						break;
					case 'straight':
					default:
						target = base;
						break;
				}

				const angDiff = (a, b) => {
					let d = Math.abs(a - b) % 360;
					return d > 180 ? 360 - d : d;
				};

				let best = null,
					bestScore = Infinity;
				for (const l of links) {
					if (typeof l.heading !== 'number') continue;
					const score = angDiff(l.heading, target);
					if (score < bestScore) {
						bestScore = score;
						best = l;
					}
				}

				if (!best) throw new Error('no-suitable-link');
				return best;
			}

			async function drive(dirOverride = null) {
				isDriving = true;

				resetTimer();
				stopCarSound();
				enginePlay('drive');
				resetWheel();

				let stepsToGo = moveSteps;
				for (let step = 0; step < stepsToGo; step++) {
					// Ждём, пока Street View отдаст ссылки (особенно важно на телефонах)
					try {
						await ensureLinksReady();
					} catch (e) {
						alert('Нет направления для движения');
						break;
					}

					const direction =
						dirOverride ||
						forcedDirection ||
						Object.keys(votes).reduce((a, b) => (votes[a] > votes[b] ? a : b));
					if (
						!direction ||
						(dirOverride == null &&
							forcedDirection == null &&
							votes[direction] === 0)
					)
						break;

					let bestLink;
					try {
						bestLink = findBestLink(direction);
					} catch {
						alert('Нет направления для движения');
						break;
					}

					const sv = new google.maps.StreetViewService();
					const nextLoaded = new Promise((resolve, reject) => {
						sv.getPanorama({ pano: bestLink.pano }, async (data, status) => {
							if (status === google.maps.StreetViewStatus.OK) {
								const nextLL = data.location.latLng,
									prevLL = panorama.getPosition();
								panorama.setPano(data.location.pano);

								const linkHeading =
									typeof bestLink.heading === 'number'
										? bestLink.heading
										: computeHeading(
												{ lat: prevLL.lat(), lng: prevLL.lng() },
												{ lat: nextLL.lat(), lng: nextLL.lng() }
										  );

								fixedHeading = linkHeading;
								fixedPitch = 0;

								panorama.setPov({ heading: fixedHeading, pitch: 0 });
								lockCamera();

								setTimeout(() => {
									panorama.setPov({ heading: fixedHeading, pitch: 0 });
									lockCamera();
								}, 250);

								if (!routeHistory[selectedCity])
									routeHistory[selectedCity] = [];
								routeHistory[selectedCity].push({
									lat: nextLL.lat(),
									lng: nextLL.lng(),
								});
								await saveRoutePoint(selectedCity, nextLL.lat(), nextLL.lng());
								// мгновенно обновить большую карту, не дожидаясь интервалов
								if (mapRoutePath)
									mapRoutePath.setPath(routeHistory[selectedCity]);
								if (routeCarMarker)
									routeCarMarker.setPosition({
										lat: nextLL.lat(),
										lng: nextLL.lng(),
									});

								if (
									document.getElementById('drone-map').style.display ===
										'block' &&
									droneMarker
								) {
									droneMarker.setPosition(nextLL);
									droneMap.setCenter(nextLL);
								}
								drawRouteOnMap();
								if (routeCarMarker) {
									routeCarMarker.setPosition(nextLL);
									// центрить всплывающую карту не обязательно, но можно:
									// mapPopup && mapPopup.setCenter(nextLL);
								}

								await setLastPosition(
									selectedCity,
									nextLL.lat(),
									nextLL.lng(),
									fixedHeading
								);
								lastPosition = {
									lat: nextLL.lat(),
									lng: nextLL.lng(),
									heading: fixedHeading,
								};
								let links = [];
								try {
									links = panorama.getLinks() || [];
								} catch (e) {
									links = [];
								}
								if (links.length === 0) {
									markDeadEnd(lastPosition);
								}

								resolve();
							} else reject();
						});
					});
					try {
						const t0ElapsedStart = performance.now();

						await nextLoaded;
						let links = [];
						try {
							links = panorama.getLinks() || [];
						} catch (e) {
							links = [];
						}
						if (links.length === 0) {
							markDeadEnd(lastPosition);
						}

						maybeSpawnCoin();

						const elapsed = performance.now() - t0ElapsedStart;
						const rest = Math.max(0, SPEED[speedMode].targetStepMs - elapsed);
						if (rest > 0) await new Promise(r => setTimeout(r, rest));
					} catch {
						break;
					}
				}

				stopCarSound();
				await fetch(
					`${window.SUPABASE_URL}/rest/v1/votes_summary?city=eq.${selectedCity}&mode=eq.voting`,
					{
						method: 'PATCH',
						headers: {
							apikey: window.SUPABASE_ANON_KEY,
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({ count: 0 }),
					}
				);
				hasVoted = false;
				localStorage.removeItem(`voted_${selectedCity}`);
				forcedDirection = null;
				await updateVotes();
				isDriving = false;
			}

			/* ===== SPEED POPUP (steps/seconds/speed) ===== */
			function openSpeedPopup() {
				const ex = document.getElementById('speedPopup');
				if (ex) ex.remove();

				const wrap = document.createElement('div');
				wrap.id = 'speedPopup';
				Object.assign(wrap.style, {
					position: 'fixed',
					inset: '0',
					background: 'rgba(0,0,0,.45)',
					display: 'flex',
					alignItems: 'center',
					justifyContent: 'center',
					zIndex: '3000',
				});

				const box = document.createElement('div');
				Object.assign(box.style, {
					background: '#111c',
					color: '#fff',
					padding: '14px 16px',
					borderRadius: '12px',
					fontWeight: '900',
					minWidth: '260px',
					boxShadow: '0 10px 32px rgba(0,0,0,.35)',
					backdropFilter: 'blur(4px)',
				});

				box.innerHTML = `
    <div style="font-size:14px;margin-bottom:8px;text-align:center;">Настройки движения</div>

    <label style="display:block;margin:6px 0;">Шаги:
      <select id="spdSteps" style="width:100%;padding:6px;border:none;border-radius:8px;">
        ${Array.from(
					{ length: 10 },
					(_, i) => `<option>${i + 1}</option>`
				).join('')}
      </select>
    </label>

    <label style="display:block;margin:6px 0;">Секунды до старта:
      <select id="spdSeconds" style="width:100%;padding:6px;border:none;border-radius:8px;">
        ${Array.from(
					{ length: 10 },
					(_, i) => `<option>${i + 1}</option>`
				).join('')}
      </select>
    </label>

   <div style="margin:8px 0;">Скорость:
  <div style="display:flex;gap:6px;margin-top:6px;">
    <button data-mode="slow"   class="spd-btn" style="flex:1;padding:8px 10px;border:none;border-radius:8px;background:#2d7;color:#fff;font-weight:900;cursor:pointer;">Медленно</button>
    <button data-mode="normal" class="spd-btn" style="flex:1;padding:8px 10px;border:none;border-radius:8px;background:#2d7;color:#fff;font-weight:900;cursor:pointer;">Нормально</button>
    <button data-mode="fast"   class="spd-btn" style="flex:1;padding:8px 10px;border:none;border-radius:8px;background:#2d7;color:#fff;font-weight:900;cursor:pointer;">Быстро</button>
  </div>
</div>


    <div style="display:flex;gap:8px;margin-top:10px;">
      <button id="applyAllBtn"   style="flex:1;padding:8px 10px;border:none;border-radius:8px;background:#7a3cff;color:#fff;font-weight:900;cursor:pointer;">Применить всем</button>
    </div>

    <button id="closeSpd" style="display:block;margin:10px auto 0;padding:6px 12px;border:none;border-radius:8px;background:#555;color:#fff;font-weight:900;">Закрыть</button>
  `;

				wrap.appendChild(box);
				document.body.appendChild(wrap);

				// current values
				const st = document.getElementById('spdSteps');
				const sc = document.getElementById('spdSeconds');
				st.value = String(moveSteps);
				sc.value = String(timerSeconds);

				// speed buttons
				box.querySelectorAll('.spd-btn').forEach(b => {
					if (b.dataset.mode === speedMode) b.style.outline = '2px solid #fff';
					b.onclick = () => {
						speedMode = b.dataset.mode;
						localStorage.setItem('speedMode', speedMode);
						box
							.querySelectorAll('.spd-btn')
							.forEach(x => (x.style.outline = ''));
						b.style.outline = '2px solid #fff';
					};
				});

				// Apply to all (sync steps+seconds)
				document.getElementById('applyAllBtn').onclick = async () => {
					moveSteps = parseInt(st.value, 10);
					localStorage.setItem('moveSteps', moveSteps);
					timerSeconds = parseInt(sc.value, 10);
					localStorage.setItem('timerSeconds', timerSeconds);
					window.moveSteps = moveSteps;
					window.timerSeconds = timerSeconds;
					await syncSettingsToServer(); // сейчас это no-op, только локально
					if (typeof applyTranslations === 'function') applyTranslations();
					wrap.remove();
				};

				document.getElementById('closeSpd').onclick = () => wrap.remove();
			}

			/* ===== SYNC POSITION ===== */
			async function syncPosition() {
				try {
					const resp = await fetch(
						`${window.SUPABASE_URL}/rest/v1/current_position?city=eq.${selectedCity}&select=lat,lng,heading&limit=1`,
						{ headers: { apikey: window.SUPABASE_ANON_KEY } }
					);
					const data = await resp.json();
					if (data && data.length) {
						const p = data[0];

						// если координаты реально поменялись — обновляем всё
						if (
							lastPosition.lat !== p.lat ||
							lastPosition.lng !== p.lng ||
							lastPosition.heading !== p.heading
						) {
							// 1) Street View (HUD)
							setStreetViewTo(p.lat, p.lng, p.heading || 0);
							lastPosition = {
								lat: p.lat,
								lng: p.lng,
								heading: p.heading || 0,
							};

							// 2) История маршрута (линия)
							if (!routeHistory[selectedCity]) routeHistory[selectedCity] = [];
							routeHistory[selectedCity].push({ lat: p.lat, lng: p.lng });
							drawRouteOnMap(); // перерисуем полилинию

							// 3) МАРКЕР НА КАРТЕ — ВАЖНО!
							if (routeCarMarker) {
								routeCarMarker.setPosition({ lat: p.lat, lng: p.lng });
							}
							if (mapPopup) {
								// можно центрить мягче, но для надёжности просто центрируем
								mapPopup.setCenter({ lat: p.lat, lng: p.lng });
							}

							// 4) Маркер “дрона” (вид со спутника)
							if (droneMarker) {
								droneMarker.setPosition({ lat: p.lat, lng: p.lng });
								if (
									document.getElementById('drone-map')?.style.display ===
										'block' &&
									droneMap
								) {
									droneMap.setCenter({ lat: p.lat, lng: p.lng });
								}
							}
						}
					}
				} catch (e) {
					// тихо
				}
			}

			// === UNIVERSAL TELEPORT (click/drag helper) ===
			async function teleportToLatLng(target) {
				// target: {lat:Number, lng:Number}
				try {
					// найдём ближайшую панораму
					const sv = new google.maps.StreetViewService();
					const pano = await new Promise((resolve, reject) => {
						sv.getPanorama(
							{
								location: target,
								radius: 150,
								source: google.maps.StreetViewSource.OUTDOOR,
							},
							(data, status) => {
								if (
									status === google.maps.StreetViewStatus.OK &&
									data?.location?.latLng
								)
									resolve(data);
								else reject(new Error('no-pano-nearby'));
							}
						);
					});

					const nextLL = pano.location.latLng;
					const prev = lastPosition?.lat
						? { lat: lastPosition.lat, lng: lastPosition.lng }
						: nextLL.toJSON();

					// фиксируем направление «из прошлого в новую точку»
					fixedHeading = computeHeading(prev, {
						lat: nextLL.lat(),
						lng: nextLL.lng(),
					});
					fixedPitch = 0;

					// переключаем SV
					panorama.setPano(pano.location.pano);
					panorama.setPov({ heading: fixedHeading, pitch: 0 });
					setTimeout(lockCamera, 250);

					// обновляем локальный стейт
					lastPosition = {
						lat: nextLL.lat(),
						lng: nextLL.lng(),
						heading: fixedHeading,
					};

					// карта-попап + дрон + маршрут
					if (!routeHistory[selectedCity]) routeHistory[selectedCity] = [];
					routeHistory[selectedCity].push({
						lat: nextLL.lat(),
						lng: nextLL.lng(),
					});
					mapRoutePath && mapRoutePath.setPath(routeHistory[selectedCity]);
					routeCarMarker &&
						routeCarMarker.setPosition({
							lat: nextLL.lat(),
							lng: nextLL.lng(),
						});
					if (
						document.getElementById('drone-map').style.display === 'block' &&
						droneMarker &&
						droneMap
					) {
						droneMarker.setPosition(nextLL);
						droneMap.setCenter(nextLL);
					}

					// сервер
					await setLastPosition(
						selectedCity,
						nextLL.lat(),
						nextLL.lng(),
						fixedHeading
					).catch(() => {});
					await saveRoutePoint(selectedCity, nextLL.lat(), nextLL.lng()).catch(
						() => {}
					);

					// UI
					await updateVotes().catch(() => {});
					await updateRouteInfo().catch(() => {});
				} catch (e) {
					alert(
						'Нет доступной панорамы рядом. Попробуйте кликнуть ближе к дороге.'
					);
				}
			}

			/* ===== SOS ===== */
			function showSosMenu() {
				/* disabled */
			}
			async function sosEscapeForward(maxSteps = 8) {
				stopCarSound();
				resetTimer();
				forcedDirection = null;
				let currPos = lastPosition;
				let moved = 0;
				for (let i = 0; i < maxSteps; i++) {
					try {
						await ensureLinksReady(3500);
						let links = [];
						try {
							links = panorama.getLinks() || [];
						} catch (e) {
							links = [];
						}
						if (!links.length) break;

						// берем любой link (лучше не тот, откуда пришли)
						let chosen = links[0];
						const sv = new google.maps.StreetViewService();
						const movedThisStep = await new Promise((resolve, reject) => {
							sv.getPanorama({ pano: chosen.pano }, (data, status) => {
								if (status === google.maps.StreetViewStatus.OK) {
									const nextLL = data.location.latLng;
									panorama.setPano(data.location.pano);
									fixedHeading = computeHeading(currPos, {
										lat: nextLL.lat(),
										lng: nextLL.lng(),
									});
									panorama.setPov({ heading: fixedHeading, pitch: 0 });
									setTimeout(lockCamera, 300);
									lastPosition = {
										lat: nextLL.lat(),
										lng: nextLL.lng(),
										heading: fixedHeading,
									};
									if (!routeHistory[selectedCity])
										routeHistory[selectedCity] = [];
									routeHistory[selectedCity].push({
										lat: nextLL.lat(),
										lng: nextLL.lng(),
									});
									if (routeHistory[selectedCity].length > 30) {
										routeHistory[selectedCity] =
											routeHistory[selectedCity].slice(-30);
									}

									mapRoutePath &&
										mapRoutePath.setPath(routeHistory[selectedCity]);
									if (routeCarMarker)
										routeCarMarker.setPosition({
											lat: nextLL.lat(),
											lng: nextLL.lng(),
										});
									if (
										droneMarker &&
										droneMap &&
										document.getElementById('drone-map').style.display ===
											'block'
									) {
										droneMarker.setPosition({
											lat: nextLL.lat(),
											lng: nextLL.lng(),
										});
										droneMap.setCenter({
											lat: nextLL.lat(),
											lng: nextLL.lng(),
										});
									}
									setLastPosition(
										selectedCity,
										nextLL.lat(),
										nextLL.lng(),
										fixedHeading
									);
									currPos = {
										lat: nextLL.lat(),
										lng: nextLL.lng(),
										heading: fixedHeading,
									};
									resolve(true);
								} else {
									reject();
								}
							});
						});
						if (movedThisStep) moved++;
					} catch {
						break;
					}

					// если после перехода появилось хотя бы 2 стрелки — стоп, ты на улице!
					await ensureLinksReady(1500);
					let links = [];
					try {
						links = panorama.getLinks() || [];
					} catch (e) {
						links = [];
					}
					if (links.length >= 2) {
						alert('Вышли на перекрёсток или улицу! Можно ехать дальше.');
						break;
					}
				}
				if (moved === 0) {
					alert(
						'Не удалось найти выход вперед. Попробуй шаги назад или другую улицу.'
					);
				}
				hasVoted = false;
				localStorage.removeItem(`voted_${selectedCity}`);
				await updateVotes();
			}

			async function sosJumpForward(steps = 1) {
				stopCarSound();
				resetTimer();
				forcedDirection = null;
				let moved = 0;
				let currPos = lastPosition;
				for (let i = 0; i < steps; i++) {
					try {
						await ensureLinksReady(3000);
						let links = [];
						try {
							links = panorama.getLinks() || [];
						} catch (e) {
							links = [];
						}
						if (!links.length) break;

						// “Прямой” если есть, иначе любой первый
						let best = null,
							minScore = 999;
						const base =
							typeof fixedHeading === 'number'
								? fixedHeading
								: panorama.getPov()?.heading || 0;
						for (const l of links) {
							if (typeof l.heading !== 'number') continue;
							let diff = Math.abs(((l.heading - base + 540) % 360) - 180);
							if (diff < minScore) {
								minScore = diff;
								best = l;
							}
						}
						let chosen = best || links[0];

						const sv = new google.maps.StreetViewService();
						const nextStep = await new Promise((resolve, reject) => {
							sv.getPanorama({ pano: chosen.pano }, (data, status) => {
								if (status === google.maps.StreetViewStatus.OK) {
									const nextLL = data.location.latLng;
									panorama.setPano(data.location.pano);
									fixedHeading = computeHeading(currPos, {
										lat: nextLL.lat(),
										lng: nextLL.lng(),
									});
									panorama.setPov({ heading: fixedHeading, pitch: 0 });
									setTimeout(lockCamera, 300);
									lastPosition = {
										lat: nextLL.lat(),
										lng: nextLL.lng(),
										heading: fixedHeading,
									};
									if (!routeHistory[selectedCity])
										routeHistory[selectedCity] = [];
									routeHistory[selectedCity].push({
										lat: nextLL.lat(),
										lng: nextLL.lng(),
									});
									if (routeHistory[selectedCity].length > 30) {
										routeHistory[selectedCity] =
											routeHistory[selectedCity].slice(-30);
									}

									mapRoutePath &&
										mapRoutePath.setPath(routeHistory[selectedCity]);
									if (routeCarMarker)
										routeCarMarker.setPosition({
											lat: nextLL.lat(),
											lng: nextLL.lng(),
										});
									if (
										droneMarker &&
										droneMap &&
										document.getElementById('drone-map').style.display ===
											'block'
									) {
										droneMarker.setPosition({
											lat: nextLL.lat(),
											lng: nextLL.lng(),
										});
										droneMap.setCenter({
											lat: nextLL.lat(),
											lng: nextLL.lng(),
										});
									}
									setLastPosition(
										selectedCity,
										nextLL.lat(),
										nextLL.lng(),
										fixedHeading
									);
									currPos = {
										lat: nextLL.lat(),
										lng: nextLL.lng(),
										heading: fixedHeading,
									};
									resolve(true);
								} else {
									reject();
								}
							});
						});
						if (nextStep) moved++;
						await new Promise(r => setTimeout(r, 320));
					} catch {
						break;
					}
				}
				hasVoted = false;
				localStorage.removeItem(`voted_${selectedCity}`);
				await updateVotes();
			}

			async function sosTeleport(steps) {
				stopCarSound();
				resetTimer();
				forcedDirection = null;
				const hist = routeHistory[selectedCity] || [];
				if (hist.length === 0) return;

				const idxTarget = Math.max(0, hist.length - 1 - Math.max(1, steps));
				const target = hist[idxTarget];
				const prev = hist[idxTarget - 1] || target;
				const heading = computeHeading(prev, target);

				setStreetViewTo(target.lat, target.lng, heading);
				lastPosition = { lat: target.lat, lng: target.lng, heading };

				hist.length = idxTarget + 1;
				mapRoutePath && mapRoutePath.setPath(hist);

				if (
					document.getElementById('drone-map').style.display === 'block' &&
					droneMarker
				) {
					droneMarker.setPosition(target);
					droneMap.setCenter(target);
				}
				if (routeCarMarker) {
					routeCarMarker.setPosition(target);
				}
				await setLastPosition(selectedCity, target.lat, target.lng, heading);
				await saveRoutePoint(selectedCity, target.lat, target.lng).catch(
					() => {}
				);
				hasVoted = false;
				localStorage.removeItem(`voted_${selectedCity}`);
				await updateVotes();
			}

			/* ===== CHAT ===== */
			/* ===== CHAT ===== */

			const CHAT_MEDIA_BUCKET = 'chat-media';

			async function uploadChatMedia(data, mediaType) {
				const user = getCurrentUser();
				if (!user || !user.id) {
					throw new Error('No current user for media upload');
				}

				const uid = String(user.id);
				const now = Date.now();
				const rand = Math.random().toString(36).slice(2);

				const ext = mediaType === 'audio' ? 'webm' : 'jpg';
				const objectName = `chat_${uid}_${now}_${rand}.${ext}`;

				const baseUrl = window.SUPABASE_URL;
				const uploadUrl = `${baseUrl}/storage/v1/object/${CHAT_MEDIA_BUCKET}/${objectName}`;

				const contentType =
					data.type || (mediaType === 'audio' ? 'audio/webm' : 'image/jpeg');

				const res = await fetch(uploadUrl, {
					method: 'POST',
					headers: {
						apikey: window.SUPABASE_ANON_KEY,
						Authorization: `Bearer ${window.SUPABASE_ANON_KEY}`,
						'Content-Type': contentType,
					},
					body: data,
				});

				if (!res.ok) {
					throw new Error('Media upload failed');
				}

				return objectName;
			}

			function getChatMediaPublicUrl(objectName) {
				if (!objectName) return null;
				const baseUrl = window.SUPABASE_URL;
				return `${baseUrl}/storage/v1/object/public/${CHAT_MEDIA_BUCKET}/${encodeURIComponent(
					objectName
				)}`;
			}

			async function deleteChatMedia(objectName) {
				if (!objectName) return;
				try {
					const baseUrl = window.SUPABASE_URL;
					const deleteUrl = `${baseUrl}/storage/v1/object/${CHAT_MEDIA_BUCKET}/${encodeURIComponent(
						objectName
					)}`;
					await fetch(deleteUrl, {
						method: 'DELETE',
						headers: {
							apikey: window.SUPABASE_ANON_KEY,
							Authorization: `Bearer ${window.SUPABASE_ANON_KEY}`,
						},
					});
				} catch (e) {
					console.warn('deleteChatMedia error:', e);
				}
			}

			let chatRecorder = null;

			let currentVoiceBubble = null;
			let currentVoiceAudio = null;
			let chatRecorderStream = null;
			let chatRecorderChunks = [];
			let chatIsRecording = false;

			function showChat() {
				const popup = document.getElementById('chatPopup');
				if (popup) popup.style.display = 'flex';
				setupChatLongPress();
				setupChatControls();
				setupChatImagePreview();
				loadChat();
			}

			function hideChat() {
				const popup = document.getElementById('chatPopup');
				if (popup) popup.style.display = 'none';
			}

			async function loadChat() {
				try {
					const [msgRes, usersRes] = await Promise.all([
						fetch(
							`${window.SUPABASE_URL}/rest/v1/messages_and_gifts?select=*&order=created_at.desc&limit=30`,
							{
								headers: {
									apikey: window.SUPABASE_ANON_KEY,
									Authorization: `Bearer ${window.SUPABASE_ANON_KEY}`,
								},
							}
						),
						fetch(
							`${window.SUPABASE_URL}/rest/v1/users?select=user_id,name,avatar`,
							{
								headers: {
									apikey: window.SUPABASE_ANON_KEY,
									Authorization: `Bearer ${window.SUPABASE_ANON_KEY}`,
								},
							}
						),
					]);

					const messages = await msgRes.json();
					const usersArr = await usersRes.json();

					const usersById = {};
					(usersArr || []).forEach(u => {
						if (!u || !u.user_id) return;
						usersById[String(u.user_id)] = {
							name: u.name || 'Driver',
							avatar: u.avatar || null,
						};
					});

					renderChatMessages(messages.reverse(), usersById);
				} catch (e) {
					console.warn('loadChat error:', e);
				}
			}

			function renderChatMessages(messages, usersById) {
				const block = document.getElementById('chatMessages');
				if (!block) return;

				const current = getCurrentUser();
				const myId = current && current.id ? String(current.id) : null;

				const html = (messages || [])
					.map(m => {
						const fromId = m.from_user ? String(m.from_user) : '';
						const uInfo = usersById && fromId ? usersById[fromId] : null;

						const displayName =
							uInfo && uInfo.name ? uInfo.name : fromId ? 'Driver' : 'Guest';
						const avatarUrl =
							uInfo && uInfo.avatar
								? uInfo.avatar
								: 'https://www.gravatar.com/avatar/?d=mp&s=40';

						const isSelf = myId && fromId && myId === fromId;

						const msgType = m.type || (m.gift_type ? 'gift' : 'text');
						const msgText = m.message
							? `<span>${escapeHTML(m.message)}</span>`
							: '';
						const giftText = m.gift_type
							? `<span style="font-size:18px;">${escapeHTML(
									m.gift_type
							  )}</span>`
							: '';

						let contentHtml = '';

						if (msgType === 'image' && m.media_path) {
							const url = getChatMediaPublicUrl(m.media_path);
							if (url) {
								const safeUrl = url.replace(/"/g, '&quot;');
								contentHtml = `
          <div class="chat-photo"
               data-photo-url="${safeUrl}"
               style="background-image:url('${safeUrl}');">
          </div>
        `;
							}
						} else if (msgType === 'audio' && m.media_path) {
							const url = getChatMediaPublicUrl(m.media_path);
							if (url) {
								const isSelfClass = isSelf ? ' self' : '';
								contentHtml = `
          <div class="voice-bubble${isSelfClass}" data-voice-id="${m.id || ''}">
            <button class="voice-play-btn paused" type="button">▶</button>
            <div class="voice-wave">
              <div class="voice-wave-fill"></div>
            </div>
            <div class="voice-time">
              <span class="voice-time-current">0:00</span>
            </div>
            <audio class="voice-audio" preload="metadata" src="${url}"></audio>
          </div>
        `;
							}
						} else {
							contentHtml = `${msgText} ${giftText}`;
						}

						return `
      <div class="chat-message"
           data-msg-id="${m.id || ''}"
           data-from-id="${fromId}"
           style="
             display:flex;
             align-items:flex-start;
             margin-bottom:7px;
             ${isSelf ? 'background:#e8fff1;' : ''}
             padding:4px 6px;
             border-radius:8px;
           ">
        <img src="${avatarUrl}"
             style="width:26px;height:26px;border-radius:50%;object-fit:cover;margin-right:6px;" />
        <div>
          <div style="font-weight:bold;font-size:13px;margin-bottom:2px;">
            ${escapeHTML(displayName)}
          </div>
          <div style="font-size:14px;word-break:break-word;">
            ${contentHtml}
          </div>
        </div>
      </div>
    `;
					})
					.join('');

				const isNearBottom =
					block.scrollHeight - block.scrollTop - block.clientHeight < 40;

				block.innerHTML = html;

				if (isNearBottom) {
					block.scrollTop = block.scrollHeight;
				}

				setupVoicePlayers();
			}

			function setupVoicePlayers() {
				const container = document.getElementById('chatMessages');
				if (!container) return;

				const bubbles = container.querySelectorAll('.voice-bubble');
				bubbles.forEach(bubble => {
					if (bubble.dataset.voiceInit === '1') return;
					bubble.dataset.voiceInit = '1';

					const btn = bubble.querySelector('.voice-play-btn');
					const audio = bubble.querySelector('.voice-audio');
					const waveFill = bubble.querySelector('.voice-wave-fill');
					const timeCurrent = bubble.querySelector('.voice-time-current');

					if (!btn || !audio || !waveFill || !timeCurrent) return;

					const formatTime = sec => {
						if (!isFinite(sec) || sec < 0) sec = 0;
						const m = Math.floor(sec / 60);
						const s = Math.floor(sec % 60);
						return `${m}:${s.toString().padStart(2, '0')}`;
					};

					const resetBubble = () => {
						btn.textContent = '▶';
						btn.classList.remove('playing');
						btn.classList.add('paused');
						waveFill.style.width = '0%';
						timeCurrent.textContent = '0:00';
					};

					audio.addEventListener('timeupdate', () => {
						const dur = audio.duration || 0;
						const cur = audio.currentTime || 0;
						timeCurrent.textContent = formatTime(cur);
						if (dur > 0) {
							const pct = Math.min(100, Math.max(0, (cur / dur) * 100));
							waveFill.style.width = pct + '%';
						} else {
							waveFill.style.width = '0%';
						}
					});

					audio.addEventListener('ended', () => {
						resetBubble();
						if (currentVoiceBubble === bubble) {
							currentVoiceBubble = null;
							currentVoiceAudio = null;
						}
					});

					btn.addEventListener('click', () => {
						if (
							currentVoiceBubble &&
							currentVoiceBubble !== bubble &&
							currentVoiceAudio
						) {
							currentVoiceAudio.pause();
							const otherBtn =
								currentVoiceBubble.querySelector('.voice-play-btn');
							const otherWave =
								currentVoiceBubble.querySelector('.voice-wave-fill');
							const otherTime = currentVoiceBubble.querySelector(
								'.voice-time-current'
							);
							if (otherBtn) {
								otherBtn.textContent = '▶';
								otherBtn.classList.remove('playing');
								otherBtn.classList.add('paused');
							}
							if (otherWave) otherWave.style.width = '0%';
							if (otherTime) otherTime.textContent = '0:00';
						}

						if (
							currentVoiceBubble === bubble &&
							currentVoiceAudio &&
							!audio.paused
						) {
							audio.pause();
							btn.textContent = '▶';
							btn.classList.remove('playing');
							btn.classList.add('paused');
							return;
						}

						currentVoiceBubble = bubble;
						currentVoiceAudio = audio;

						btn.textContent = '⏸';
						btn.classList.remove('paused');
						btn.classList.add('playing');

						audio.play().catch(err => {
							console.warn('voice play error:', err);
							resetBubble();
						});
					});
				});
			}

			async function sendChat(payload) {
				const input = document.getElementById('chatInput');
				if (!input) return;

				let text = null;
				let gift = null;
				let msgType = 'text';
				let mediaPath = null;
				let durationMs = null;

				if (payload && payload.type) {
					msgType = payload.type;
					mediaPath = payload.media_path || null;
					durationMs = payload.duration_ms != null ? payload.duration_ms : null;
					if (payload.message) text = payload.message;
					if (payload.gift_type) gift = payload.gift_type;
				} else {
					text = input.value.trim();
					if (!text) return;

					if (/^[^\w\s]{1,2}$/.test(text)) {
						gift = text;
						text = null;
						msgType = 'gift';
					} else {
						msgType = 'text';
					}
				}

				const user = getCurrentUser();

				// only real Telegram users can send messages
				if (!user || !user.id || String(user.id).startsWith('guest_')) {
					alert('Only Telegram players can send messages.');
					return;
				}

				try {
					await fetch(`${window.SUPABASE_URL}/rest/v1/messages_and_gifts`, {
						method: 'POST',
						headers: {
							apikey: window.SUPABASE_ANON_KEY,
							Authorization: `Bearer ${window.SUPABASE_ANON_KEY}`,
							'Content-Type': 'application/json',
							Prefer: 'return=representation',
						},
						body: JSON.stringify({
							from_user: String(user.id),
							to_user: null,
							message: text,
							gift_type: gift,
							type: msgType,
							media_path: mediaPath,
							duration_ms: durationMs,
						}),
					});

					cleanupOldMessages();
				} catch (e) {
					console.warn('sendChat error:', e);
				}

				if (!payload) {
					input.value = '';
				}

				setTimeout(loadChat, 300);
			}

			/* long press to delete own message */

			let chatLongPressTimer = null;
			const CHAT_LONG_PRESS_MS = 600;

			function setupChatLongPress() {
				const container = document.getElementById('chatMessages');
				if (!container) return;

				if (container.dataset.longPressInit === '1') return;
				container.dataset.longPressInit = '1';

				container.addEventListener('pointerdown', e => {
					const msgEl = e.target.closest('.chat-message');
					if (!msgEl) return;

					const fromId = msgEl.getAttribute('data-from-id') || '';
					const current = getCurrentUser();
					const myId = current && current.id ? String(current.id) : null;

					if (!myId || fromId !== myId) {
						return;
					}

					const id = msgEl.getAttribute('data-msg-id') || '';
					if (!id) return;

					chatLongPressTimer = setTimeout(() => {
						chatLongPressTimer = null;
						if (!confirm('Delete this message?')) return;
						deleteChatMessage(id);
					}, CHAT_LONG_PRESS_MS);
				});

				['pointerup', 'pointerleave', 'pointercancel'].forEach(ev => {
					container.addEventListener(ev, () => {
						if (chatLongPressTimer) {
							clearTimeout(chatLongPressTimer);
							chatLongPressTimer = null;
						}
					});
				});
			}

			let chatImagePreviewOverlay = null;
			let chatImagePreviewImg = null;

			function ensureChatImagePreviewOverlay() {
				if (chatImagePreviewOverlay) return;

				const overlay = document.createElement('div');
				overlay.id = 'chatImagePreviewOverlay';
				overlay.style.position = 'fixed';
				overlay.style.top = '0';
				overlay.style.left = '0';
				overlay.style.right = '0';
				overlay.style.bottom = '0';
				overlay.style.background = 'transparent';

				overlay.style.display = 'none';
				overlay.style.alignItems = 'center';
				overlay.style.justifyContent = 'center';
				overlay.style.zIndex = '4000';
				overlay.style.cursor = 'zoom-out';

				const img = document.createElement('div');
				img.style.width = '100%';
				img.style.height = '100%';
				img.style.backgroundSize = 'contain';
				img.style.backgroundRepeat = 'no-repeat';
				img.style.backgroundPosition = 'center';
				img.style.pointerEvents = 'none'; // long-press игнорируется
				overlay.appendChild(img);

				overlay.addEventListener('click', () => {
					overlay.style.display = 'none';
				});

				document.body.appendChild(overlay);

				chatImagePreviewOverlay = overlay;
				chatImagePreviewImg = img;
			}

			function openChatImagePreview(el) {
				if (!el) return;
				ensureChatImagePreviewOverlay();

				const url =
					el.dataset && el.dataset.photoUrl
						? el.dataset.photoUrl
						: (el.getAttribute && el.getAttribute('src')) || '';

				if (!url) return;

				chatImagePreviewImg.style.backgroundImage = `url('${url}')`;

				chatImagePreviewOverlay.style.display = 'flex';
			}

			function setupChatImagePreview() {
				const container = document.getElementById('chatMessages');
				if (!container) return;

				if (container.dataset.imagePreviewInit === '1') return;
				container.dataset.imagePreviewInit = '1';

				container.addEventListener('click', ev => {
					const img = ev.target.closest('.chat-photo');
					if (!img) return;

					// prevent Telegram / browser default image viewer
					ev.preventDefault();
					ev.stopPropagation();

					openChatImagePreview(img);
				});
			}

			function setupChatControls() {
				const popup = document.getElementById('chatPopup');
				if (!popup) return;

				if (popup.dataset.controlsInit === '1') return;
				popup.dataset.controlsInit = '1';

				const attachBtn = document.getElementById('chatAttachBtn');
				const imageInput = document.getElementById('chatImageInput');
				const voiceBtn = document.getElementById('chatVoiceBtn');

				if (attachBtn && imageInput) {
					attachBtn.addEventListener('click', () => {
						imageInput.click();
					});

					imageInput.addEventListener('change', async ev => {
						const file = ev.target.files && ev.target.files[0];
						if (!file) return;

						try {
							const objectName = await uploadChatMedia(file, 'image');
							await sendChat({
								type: 'image',
								media_path: objectName,
							});
						} catch (err) {
							console.warn('chat image upload error:', err);
							alert('Failed to send image.');
						} finally {
							ev.target.value = '';
						}
					});
				}

				if (voiceBtn) {
					voiceBtn.addEventListener('click', handleChatVoiceToggle);
				}
			}

			async function handleChatVoiceToggle() {
				const btn = document.getElementById('chatVoiceBtn');

				if (!chatIsRecording) {
					try {
						const stream = await navigator.mediaDevices.getUserMedia({
							audio: true,
						});
						chatRecorderStream = stream;
						chatRecorder = new MediaRecorder(stream);
						chatRecorderChunks = [];

						chatRecorder.ondataavailable = e => {
							if (e.data && e.data.size > 0) {
								chatRecorderChunks.push(e.data);
							}
						};

						chatRecorder.onstop = async () => {
							try {
								const blob = new Blob(chatRecorderChunks, {
									type: chatRecorder.mimeType || 'audio/webm',
								});
								chatRecorderChunks = [];

								const objectName = await uploadChatMedia(blob, 'audio');
								await sendChat({
									type: 'audio',
									media_path: objectName,
								});
							} catch (err) {
								console.warn('chat audio upload error:', err);
								alert('Failed to send voice message.');
							} finally {
								if (chatRecorderStream) {
									chatRecorderStream.getTracks().forEach(t => t.stop());
								}
								chatRecorder = null;
								chatRecorderStream = null;
								chatIsRecording = false;
								if (btn) btn.textContent = '🎙';
							}
						};

						chatRecorder.start();
						chatIsRecording = true;
						if (btn) btn.textContent = '■';
					} catch (err) {
						console.warn('chat voice start error:', err);
						alert('Microphone is not available.');
					}
				} else {
					if (chatRecorder && chatRecorder.state !== 'inactive') {
						chatRecorder.stop();
					}
				}
			}

			async function deleteChatMessage(id) {
				try {
					await fetch(
						`${window.SUPABASE_URL}/rest/v1/messages_and_gifts?id=eq.${id}`,
						{
							method: 'DELETE',
							headers: {
								apikey: window.SUPABASE_ANON_KEY,
								Authorization: `Bearer ${window.SUPABASE_ANON_KEY}`,
								Prefer: 'return=minimal',
							},
						}
					);
					loadChat();
				} catch (e) {
					console.warn('deleteChatMessage error:', e);
				}
			}

			/* remove old messages from DB, keep only last ~30 */

			async function cleanupOldMessages() {
				try {
					const res = await fetch(
						`${window.SUPABASE_URL}/rest/v1/messages_and_gifts?select=id,type,media_path&order=created_at.desc&offset=30`,
						{
							headers: {
								apikey: window.SUPABASE_ANON_KEY,
								Authorization: `Bearer ${window.SUPABASE_ANON_KEY}`,
							},
						}
					);
					const rows = await res.json();
					if (!Array.isArray(rows) || rows.length === 0) return;

					// delete media files first
					for (const row of rows) {
						if (!row) continue;
						if (
							(row.type === 'image' || row.type === 'audio') &&
							row.media_path
						) {
							await deleteChatMedia(row.media_path);
						}
					}

					const ids = rows.map(r => r.id).filter(Boolean);
					if (!ids.length) return;

					const inList = ids.map(x => `"${x}"`).join(',');
					await fetch(
						`${window.SUPABASE_URL}/rest/v1/messages_and_gifts?id=in.(${inList})`,
						{
							method: 'DELETE',
							headers: {
								apikey: window.SUPABASE_ANON_KEY,
								Authorization: `Bearer ${window.SUPABASE_ANON_KEY}`,
								Prefer: 'return=minimal',
							},
						}
					);
				} catch (e) {
					console.warn('cleanupOldMessages error:', e);
				}
			}

			/* auto refresh while chat is open */

			setInterval(() => {
				const popup = document.getElementById('chatPopup');
				if (popup && popup.style.display !== 'none') {
					loadChat();
				}
			}, 8000);

			function escapeHTML(str) {
				if (!str) return '';
				return str.replace(
					/[<>&"]/g,
					c => ({ '<': '&lt;', '>': '&gt;', '&': '&amp;', '"': '&quot;' }[c])
				);
			}

			/* ===== RADIO
/* ===== RADIO (multi-station + NowPlaying) ===== */
			const radioAudio = document.getElementById('radioAudio');

			// keep this flag if not defined yet
			if (typeof window.radioIsPlaying !== 'boolean') {
				window.radioIsPlaying = false;
			}

			/* Список станций:
			 * 0: SomaFM Groove Salad (US)
			 * 1: Radio Swiss Jazz (CH)
			 * 2: FIP Paris (FR) – c красивым now playing, но может быть заблокирован где-то
			 */
			const RADIO_STATIONS = [
				{
					name: 'SomaFM: Groove Salad (US)',
					emoji: '🎧',
					url: 'https://ice6.somafm.com/groovesalad-128-mp3',
					type: 'generic',
				},

				{
					name: 'Radio Swiss Jazz (CH)',
					emoji: '🎷',
					url: 'https://stream.srg-ssr.ch/m/rsj/aacp_96',
					type: 'generic',
				},
				{
					name: 'FIP (Paris, FR)',
					emoji: '🎺',
					url: 'https://icecast.radiofrance.fr/fip-hifi.aac',
					type: 'fip',
				},
			];

			// общее состояние радио
			window.RADIO_STATE = window.RADIO_STATE || {
				currentIndex: -1,
				metaTimer: null,
			};

			let currentStationIndex = parseInt(
				localStorage.getItem('radio_station_index') ??
					String(window.RADIO_STATE.currentIndex),
				10
			);
			if (Number.isNaN(currentStationIndex)) currentStationIndex = -1;

			// при воспроизведении/паузе – синхронизируем флаг и громкость двигателя
			radioAudio.addEventListener('playing', () => {
				radioIsPlaying = true;
				window.radioIsPlaying = true;

				try {
					if (
						typeof carAudio !== 'undefined' &&
						!carAudio.paused &&
						!isEngineMuted &&
						typeof engineTargetVolume === 'function'
					) {
						carAudio.volume = engineTargetVolume('drive');
					}
				} catch (_) {}
			});

			radioAudio.addEventListener('pause', () => {
				radioIsPlaying = false;
				window.radioIsPlaying = false;
				radioStopNowPlayingUpdates();
			});

			radioAudio.addEventListener('ended', () => {
				radioIsPlaying = false;
				window.radioIsPlaying = false;
				radioStopNowPlayingUpdates();
			});

			function resumeRadioIfNeeded() {
				if (!radioIsPlaying) return;
				try {
					if (radioAudio && radioAudio.paused) {
						radioAudio.play().catch(() => {});
					}
				} catch (_) {}
			}

			// resume when app returns to foreground
			document.addEventListener('visibilitychange', () => {
				if (document.visibilityState === 'visible') resumeRadioIfNeeded();
			});
			window.addEventListener('focus', resumeRadioIfNeeded);

			// Telegram Mini App: after invoice or other overlays
			try {
				if (
					window.Telegram &&
					Telegram.WebApp &&
					typeof Telegram.WebApp.onEvent === 'function'
				) {
					Telegram.WebApp.onEvent('invoiceClosed', resumeRadioIfNeeded);
					Telegram.WebApp.onEvent('viewportChanged', function () {
						resumeRadioIfNeeded();
						try {
							fitViewport();
						} catch (e) {}
					});
				}
			} catch (_) {}

			/* ==== helpers ==== */

			function radioStop() {
				try {
					radioAudio.pause();
				} catch (_) {}
				radioStopNowPlayingUpdates();
			}

			// остановить периодическое обновление now playing
			function radioStopNowPlayingUpdates() {
				if (window.RADIO_STATE.metaTimer) {
					clearInterval(window.RADIO_STATE.metaTimer);
					window.RADIO_STATE.metaTimer = null;
				}
			}

			// FIP JSON now playing
			async function radioFetchFipNowPlaying() {
				const r = await fetch('https://api.radiofrance.fr/livemeta/pull/7', {
					cache: 'no-store',
				});
				const data = await r.json();
				const level = data?.levels?.[0];
				const uid = level?.items?.[level?.position];
				const step = uid ? data?.steps?.[uid] : null;
				if (!step) return null;

				const title = step.title || step.titre || '';
				const artist = step.authors || step.subtitle || '';
				const cover = step.visual || step.cover || step.image || null;
				return { title, artist, cover };
			}

			/**
			 * Запускает обновление надписи "Now playing".
			 * Для type === 'fip' тянем JSON, иначе показываем просто название станции.
			 */
			function radioStartNowPlayingUpdates(labelEl, station) {
				const targetEl = labelEl || document.getElementById('radioNowPlaying');
				radioStopNowPlayingUpdates();

				if (!station || !targetEl) return;
				if (!radioIsPlaying) {
					targetEl.textContent = t('nowPlaying') + ': …';
					return;
				}

				// generic – только имя станции
				if (station.type !== 'fip') {
					targetEl.textContent = `${t('nowPlaying')}: ${station.name}`;
					// MediaSession без обложки
					try {
						if ('mediaSession' in navigator) {
							navigator.mediaSession.metadata = new MediaMetadata({
								title: station.name,
								artist: '',
								album: 'Radio',
							});
						}
					} catch (_) {}
					return;
				}

				// FIP – JSON meta
				const tick = async () => {
					try {
						const np = await radioFetchFipNowPlaying();
						if (!np) return;

						const text = np.artist ? `${np.title} — ${np.artist}` : np.title;

						targetEl.textContent = text;

						try {
							if ('mediaSession' in navigator) {
								navigator.mediaSession.metadata = new MediaMetadata({
									title: np.title || 'FIP',
									artist: np.artist || '',
									album: 'FIP',
									artwork: np.cover ? [{ src: np.cover }] : [],
								});
							}
						} catch (_) {}
					} catch (_) {}
				};

				tick();
				window.RADIO_STATE.metaTimer = setInterval(tick, 15000);
			}

			/**
			 * Проиграть выбранную станцию.
			 */
			async function radioPlayStation(index) {
				const st = RADIO_STATIONS[index];
				if (!st) return;

				try {
					if (radioAudio.src !== st.url) {
						radioAudio.src = st.url;
					}
					await radioAudio.play();

					radioIsPlaying = true;
					window.radioIsPlaying = true;

					currentStationIndex = index;
					window.RADIO_STATE.currentIndex = index;
					localStorage.setItem('radio_station_index', String(index));

					// обновляем now playing
					const npLabel = document.getElementById('radioNowPlaying');
					radioStartNowPlayingUpdates(npLabel, st);
				} catch (err) {
					alert(
						'Не удалось запустить радио.\n' +
							'Станция может быть недоступна в вашем регионе или заблокирована.\n' +
							'Попробуйте другую станцию в списке.'
					);
				}
			}

			/**
			 * Простое меню с выбором станции и надписью Now playing.
			 */
			function showRadioMenu() {
				const old = document.getElementById('radioMenu');
				if (old) old.remove();

				const wrap = document.createElement('div');
				wrap.id = 'radioMenu';
				Object.assign(wrap.style, {
					position: 'fixed',
					inset: '0',
					background: 'rgba(0,0,0,.45)',
					display: 'flex',
					alignItems: 'center',
					justifyContent: 'center',
					zIndex: '3000',
				});

				const box = document.createElement('div');
				Object.assign(box.style, {
					background: '#111c',
					backdropFilter: 'blur(3px)',
					color: '#fff',
					padding: '14px 16px',
					borderRadius: '12px',
					fontWeight: '900',
					boxShadow: '0 10px 32px rgba(0,0,0,.35)',
					minWidth: '280px',
				});

				const title = document.createElement('div');
				title.textContent = t('nowPlaying');
				title.style.cssText =
					'font-size:14px;margin-bottom:8px;text-align:center;';
				box.appendChild(title);

				const now = document.createElement('div');
				now.id = 'radioNowPlaying';
				now.textContent = t('nowPlaying') + ': …';
				now.style.cssText =
					'font-size:12px;margin:6px 0 10px;text-align:center;opacity:.9';
				box.appendChild(now);

				RADIO_STATIONS.forEach((st, idx) => {
					const b = document.createElement('button');
					b.textContent = `${st.emoji} ${st.name}`;
					Object.assign(b.style, {
						display: 'block',
						width: '100%',
						textAlign: 'left',
						margin: '4px 0',
						padding: '8px 10px',
						border: 'none',
						borderRadius: '8px',
						cursor: 'pointer',
						fontWeight: '900',
						background: idx === currentStationIndex ? '#26a96e' : '#3498db',
						color: '#fff',
					});

					b.onclick = async () => {
						await radioPlayStation(idx);
						// после выбора — обновим подсветку активной кнопки
						box.querySelectorAll('button').forEach(btn => {
							if (btn === b) {
								btn.style.background = '#26a96e';
							} else if (btn !== stopBtn && btn !== closeBtn) {
								btn.style.background = '#3498db';
							}
						});
					};

					box.appendChild(b);
				});

				const row = document.createElement('div');
				row.style.cssText = 'display:flex;gap:8px;margin-top:10px;';

				const stopBtn = document.createElement('button');
				stopBtn.textContent = t('stop');
				Object.assign(stopBtn.style, {
					flex: '1',
					padding: '8px 10px',
					border: 'none',
					borderRadius: '8px',
					background: '#ff4d57',
					color: '#fff',
					fontWeight: '900',
					cursor: 'pointer',
				});
				stopBtn.onclick = () => {
					radioStop();
					now.textContent = t('nowPlaying') + ': …';
				};

				const closeBtn = document.createElement('button');
				closeBtn.textContent = t('closeBtn');
				Object.assign(closeBtn.style, {
					flex: '1',
					padding: '8px 10px',
					border: 'none',
					borderRadius: '8px',
					background: '#555',
					color: '#fff',
					fontWeight: '900',
					cursor: 'pointer',
				});
				closeBtn.onclick = () => wrap.remove();

				row.appendChild(stopBtn);
				row.appendChild(closeBtn);
				box.appendChild(row);

				wrap.appendChild(box);
				document.body.appendChild(wrap);

				// если уже что-то играет – сразу показать now playing
				const current = RADIO_STATIONS[currentStationIndex];
				if (current && radioIsPlaying) {
					radioStartNowPlayingUpdates(now, current);
				}
			}

			function openHudMenu() {
				const overlay = document.getElementById('menuOverlay');
				const drawer = document.getElementById('menuDrawer');
				if (!overlay || !drawer) return;
				overlay.style.display = 'block';
				requestAnimationFrame(() => drawer.classList.add('open'));
			}
			function closeHudMenu() {
				const overlay = document.getElementById('menuOverlay');
				const drawer = document.getElementById('menuDrawer');
				if (!overlay || !drawer) return;
				drawer.classList.remove('open');
				setTimeout(() => {
					overlay.style.display = 'none';
				}, 250);
			}
			function wireHudMenu() {
				const overlay = document.getElementById('menuOverlay');
				const closeBtn = document.getElementById('menuClose');
				const mailBtn = document.getElementById('supportMail');
				const botBtn = document.getElementById('supportBot');

				overlay && overlay.addEventListener('click', closeHudMenu);
				closeBtn && closeBtn.addEventListener('click', closeHudMenu);
				const langSel = document.getElementById('langSelect');
				if (langSel) {
					langSel.value =
						window.currentLang || localStorage.getItem('lang') || 'ru';
					langSel.addEventListener('change', e => setLang(e.target.value));
				}

				document.addEventListener('keydown', e => {
					if (e.key === 'Escape') closeHudMenu();
				});

				// support
				mailBtn &&
					mailBtn.addEventListener('click', () => {
						window.location.href = SUPPORT_MAIL;
					});
				if (botBtn) {
					if (SUPPORT_BOT) {
						botBtn.style.display = '';
						botBtn.addEventListener('click', () => {
							try {
								if (window.Telegram?.WebApp?.openTelegramLink) {
									Telegram.WebApp.openTelegramLink(SUPPORT_BOT);
								} else {
									window.open(SUPPORT_BOT, '_blank');
								}
							} catch (e) {
								window.open(SUPPORT_BOT, '_blank');
							}
						});
					} else {
						botBtn.style.display = 'none';
					}
				}
			}
			function updateCityChipLabel(city) {
				const label = document.getElementById('currentCityLabel');
				if (!label) return;
				label.textContent = city;
			}

			function openCityMenu() {
				const overlay = document.getElementById('cityOverlay');
				const drawer = document.getElementById('cityDrawer');
				if (!overlay || !drawer) return;
				overlay.style.display = 'block';
				requestAnimationFrame(() => {
					drawer.classList.add('open');
				});
			}

			function closeCityMenu() {
				const overlay = document.getElementById('cityOverlay');
				const drawer = document.getElementById('cityDrawer');
				if (!overlay || !drawer) return;
				drawer.classList.remove('open');
				setTimeout(() => {
					overlay.style.display = 'none';
				}, 250);
			}

			function wireCityMenu() {
				const overlay = document.getElementById('cityOverlay');
				const drawer = document.getElementById('cityDrawer');
				const closeBtn = document.getElementById('cityClose');
				const chip = document.getElementById('cityChip');

				//if (chip) chip.addEventListener('click', openCityMenu);
				if (overlay) overlay.addEventListener('click', closeCityMenu);
				if (closeBtn) closeBtn.addEventListener('click', closeCityMenu);

				function getCurrentLevelForCityLock() {
					if (typeof window.getCurrentLevel === 'function') {
						try {
							return window.getCurrentLevel();
						} catch (e) {
							return 1;
						}
					}
					return 1;
				}

				function updateCityAvailability() {
					const currentLevel = getCurrentLevelForCityLock();
					document.querySelectorAll('[data-city-item]').forEach(btn => {
						const req = parseInt(
							btn.getAttribute('data-required-level') || '1',
							10
						);
						if (currentLevel < req) {
							btn.classList.add('locked');
						} else {
							btn.classList.remove('locked');
						}
					});
				}

				document.querySelectorAll('[data-city-item]').forEach(btn => {
					btn.addEventListener('click', () => {
						const city = btn.getAttribute('data-city');
						if (!city) return;

						const reqLevel = parseInt(
							btn.getAttribute('data-required-level') || '1',
							10
						);
						const currentLevel = getCurrentLevelForCityLock();

						if (currentLevel < reqLevel) {
							alert('Город станет доступен с уровня ' + reqLevel);
							return;
						}

						const sel = document.getElementById('citySelect');
						if (sel) {
							sel.value = city;
							const ev = new Event('change', { bubbles: true });
							sel.dispatchEvent(ev);
						}
						updateCityChipLabel(city);
						closeCityMenu();
					});
				});

				updateCityAvailability();
				setInterval(updateCityAvailability, 1000);
			}

			/* ===== INIT ===== */
			/* ===== INIT ===== */
			async function initApp() {
				// block direct open in normal browser: require Telegram WebApp context
				// var tg = window.Telegram && window.Telegram.WebApp;
				//if (!tg || !tg.initDataUnsafe || !tg.initDataUnsafe.user) {
				// completely clear page for normal browser
				//try {
				//document.documentElement.innerHTML = '';
				//} catch (e) {}
				//return;
				//}

				// 1) basic settings/state
				try {
					if (
						window.Telegram &&
						window.Telegram.WebApp &&
						window.Telegram.WebApp.ready
					) {
						window.Telegram.WebApp.ready();
						// сразу просим TonRoad открыть на весь экран
						if (window.Telegram.WebApp.expand) {
							window.Telegram.WebApp.expand();
						}
					}
				} catch (_) {}

				fitViewport();
				setLang(localStorage.getItem('lang') || 'ru');

				// selected city from localStorage or default
				const city = localStorage.getItem('selectedCity') || 'Paris';
				selectedCity = city;
				updateCityChipLabel(city);

				// 2) Берём последнюю позицию или дефолт
				const lastPos = await getLastPosition(city).catch(() => null);
				const startPos = lastPos
					? { lat: lastPos.lat, lng: lastPos.lng }
					: CITIES[city];
				const startHeading = lastPos ? lastPos.heading : 0;

				// 3) Ищем реальную панораму заранее (без «чёрного экрана»)
				const sv = new google.maps.StreetViewService();
				const panoData = await new Promise((resolve, reject) => {
					sv.getPanorama(
						{
							location: startPos,
							radius: 120,
							source: google.maps.StreetViewSource.OUTDOOR,
						},
						(data, status) => {
							if (status === google.maps.StreetViewStatus.OK) resolve(data);
							else reject(new Error('No pano nearby'));
						}
					);
				}).catch(() => null);

				const panoId = panoData?.location?.pano || null;
				const panoLL = panoData?.location?.latLng || null;
				const firstLat = panoLL ? panoLL.lat() : startPos.lat;
				const firstLng = panoLL ? panoLL.lng() : startPos.lng;

				fixedHeading = startHeading || 0;
				lastPosition = { lat: firstLat, lng: firstLng, heading: fixedHeading };

				// 4) Создаём панораму ОДИН РАЗ и сразу видимую
				const svContainer = document.getElementById('street-view');
				panorama = new google.maps.StreetViewPanorama(svContainer, {
					pano: panoId || undefined,
					position: { lat: firstLat, lng: firstLng },
					pov: { heading: fixedHeading, pitch: 0 },
					visible: true,
					disableDefaultUI: true,
					linksControl: true,
					addressControl: false,
					showRoadLabels: false,
					clickToGo: true,
					scrollwheel: false,
					motionTracking: allowRotation,
					motionTrackingControl: false,
				});

				document.querySelector('.app')?.classList.add('ready');
				if (typeof applySOSLayout === 'function') applySOSLayout();

				// фикс POV и стрелки
				try {
					await ensureLinksReady(7000);
				} catch (_) {}
				lockCamera();
				attachArrowVisibilityListeners();
				updateArrowVisibility();

				updateRotationUi();

				// 5) Карта (popup) + маршрут
				mapPopup = new google.maps.Map(document.getElementById('mapCanvas'), {
					center: { lat: firstLat, lng: firstLng },
					zoom: 15,
					mapTypeControl: true,
					streetViewControl: true,
					zoomControl: true,
					fullscreenControl: true,
				});
				// клик по карте -> телепорт
				// ===== Long-press teleport on MAP (5s) =====
				(function setupMapLongPressTeleport() {
					const LONG_PRESS_MS = 10000; //
					const MOVE_TOL_PX = 12; //
					let holdTimer = null;
					let startXY = null;
					let startLatLng = null;

					function showMapHint(text) {
						try {
							const id = 'mapHoldHint';
							document.getElementById(id)?.remove();
							const d = document.createElement('div');
							d.id = id;
							d.textContent = text;
							Object.assign(d.style, {
								position: 'absolute',
								left: '50%',
								top: '8px',
								transform: 'translateX(-50%)',
								background: '#222',
								color: '#fff',
								padding: '6px 10px',
								borderRadius: '8px',
								fontWeight: 900,
								zIndex: 9999,
								pointerEvents: 'none',
							});
							document.getElementById('mapCanvas').appendChild(d);
							setTimeout(() => d.remove(), LONG_PRESS_MS + 1200);
						} catch (_) {}
					}
					function removeMapHint() {
						try {
							document.getElementById('mapHoldHint')?.remove();
						} catch (_) {}
					}

					function clientXY(domEvent) {
						if (!domEvent) return { x: 0, y: 0 };
						if (domEvent.touches && domEvent.touches[0]) {
							return {
								x: domEvent.touches[0].clientX,
								y: domEvent.touches[0].clientY,
							};
						}
						return { x: domEvent.clientX ?? 0, y: domEvent.clientY ?? 0 };
					}
					function movedTooFar(domEvent) {
						const { x, y } = clientXY(domEvent);
						if (!startXY) return false;
						return (
							Math.abs(x - startXY.x) + Math.abs(y - startXY.y) > MOVE_TOL_PX
						);
					}
					function cancelHold() {
						if (holdTimer) {
							clearTimeout(holdTimer);
							holdTimer = null;
						}
						removeMapHint();
						startXY = null;
						startLatLng = null;
					}
					function startHold(e) {
						cancelHold();
						if (!e) return;
						// место старта
						startLatLng = e.latLng || null;
						startXY = clientXY(e.domEvent || e);

						holdTimer = setTimeout(async () => {
							holdTimer = null;

							// если точка определена — телепортируем
							if (startLatLng) {
								const pos = { lat: startLatLng.lat(), lng: startLatLng.lng() };
								try {
									await teleportToLatLng(pos);
									setTimeout(() => {
										updateRouteInfo().catch(() => {});
									}, 300);
								} catch (_) {}
							}
							startXY = null;
							startLatLng = null;
						}, LONG_PRESS_MS);
					}

					// запуск удержания
					mapPopup.addListener('mousedown', e => startHold(e));
					mapPopup.addListener('touchstart', e => startHold(e));

					// отмена при отпускании/клике/контекст-меню
					mapPopup.addListener('mouseup', () => cancelHold());
					mapPopup.addListener('touchend', () => cancelHold());
					mapPopup.addListener('rightclick', () => cancelHold());
					mapPopup.addListener('click', () => cancelHold());

					// отмена при существенном смещении пальца/мыши
					mapPopup.addListener('mousemove', e => {
						if (movedTooFar(e?.domEvent)) cancelHold();
					});
					mapPopup.addListener('touchmove', e => {
						if (movedTooFar(e?.domEvent)) cancelHold();
					});
				})();

				mapRoutePath = new google.maps.Polyline({
					path: [{ lat: firstLat, lng: firstLng }],
					geodesic: true,
					strokeColor: '#ff0000',
					strokeOpacity: 1,
					strokeWeight: 6,
				});
				mapRoutePath.setMap(mapPopup);

				routeCarMarker = new google.maps.Marker({
					position: { lat: firstLat, lng: firstLng },
					map: mapPopup,
					icon: getCarMarkerIcon(36),
					draggable: true,
				});

				routeCarMarker.addListener('dragend', e => {
					const tg = window.Telegram && window.Telegram.WebApp;
					const u = tg && tg.initDataUnsafe && tg.initDataUnsafe.user;
					const ownerId = 5959529178;

					// Если это НЕ ты — запрещаем перетаскивание
					if (!u || Number(u.id) !== ownerId) {
						// откатываем маркер обратно на прежнюю позицию
						const pos = routeHistory[selectedCity]?.at(-1);
						if (pos) {
							routeCarMarker.setPosition(pos);
						}
						return;
					}

					// Если это ТЫ → разрешаем телепорт
					if (!e || !e.latLng) return;
					teleportToLatLng({ lat: e.latLng.lat(), lng: e.latLng.lng() });
				});

				// 6) Подтягиваем маршрут из БД
				try {
					const loaded = await loadRoute(city);
					if (loaded.length) {
						routeHistory[city] = loaded;
						mapRoutePath.setPath(pointsToLatLng(loaded));
						routeCarMarker.setPosition(pointsToLatLng(loaded).at(-1));
					} else {
						routeHistory[city] = [{ lat: firstLat, lng: firstLng }];
						mapRoutePath.setPath(routeHistory[city]);
						routeCarMarker.setPosition({ lat: firstLat, lng: firstLng });
						await saveRoutePoint(city, firstLat, firstLng).catch(() => {});
					}
				} catch (_) {
					routeHistory[city] = [{ lat: firstLat, lng: firstLng }];
					mapRoutePath.setPath(routeHistory[city]);
					routeCarMarker.setPosition({ lat: firstLat, lng: firstLng });
					await saveRoutePoint(city, firstLat, firstLng).catch(() => {});
				}

				// 7) Проводка UI-кнопок/меню
				wireHudMenu();
				wireCityMenu();

				document.getElementById('btnMap').onclick = showMapPopup;
				document.getElementById('hideMapBtn').onclick = hideMapPopup;

				const topMenuBtn = document.getElementById('topMenuBtn');
				if (topMenuBtn)
					topMenuBtn.onclick = () => {
						openHudMenu();
					};

				const citySel = document.getElementById('citySelect');
				if (citySel) {
					citySel.value = city;
					citySel.onchange = async e => {
						selectedCity = e.target.value;
						localStorage.setItem('selectedCity', selectedCity);
						updateCityChipLabel(selectedCity);
						await syncCity(selectedCity);
					};
				}

				document.getElementById('btnDroneToggle').onclick = () => {
					const isDrone =
						document.getElementById('drone-map').style.display === 'block';
					if (isDrone) switchToCar();
					else {
						if (!droneInited) initDroneMap({ lat: firstLat, lng: firstLng });
						switchToDrone();
					}
				};

				const engineBtn = document.getElementById('toggle-engine');
				if (engineBtn) {
					updateEngineBtn();
					applyEngineMute();
					engineBtn.onclick = () => {
						isEngineMuted = !isEngineMuted;
						localStorage.setItem('engine_mute', isEngineMuted ? '1' : '0');
						updateEngineBtn();
						applyEngineMute();
					};
				}

				const rotBtn = document.getElementById('toggle-rotation');
				if (rotBtn) {
					updateRotationUi();
					rotBtn.onclick = () => {
						allowRotation = !allowRotation;
						updateRotationUi();
						if (allowRotation) {
							google.maps.event.clearListeners(panorama, 'pov_changed');

							// 🔒 Блокируем перемещение в Google Street View
							panorama.setOptions({
								clickToGo: false,
								linksControl: false,
								disableDoubleClickZoom: true,
								scrollwheel: false,
							});
						} else {
							lockCamera();
							panorama.setPov({ heading: fixedHeading, pitch: fixedPitch });
						}
					};
				}

				document.querySelectorAll('[data-dir]').forEach(a => {
					a.addEventListener('click', () => castVote(a.dataset.dir));
				});

				const hornBtn = document.getElementById('hornBtn');
				if (hornBtn) {
					hornBtn.addEventListener('click', honk);
					hornBtn.addEventListener(
						'touchstart',
						e => {
							e.preventDefault();
							honk();
						},
						{ passive: false }
					);
				}

				const radioBtn = document.getElementById('btnRadio');
				if (radioBtn) {
					radioBtn.onclick = showRadioMenu;
					radioBtn.style.pointerEvents = 'auto'; // на всякий случай
				}

				document.getElementById('btnReset').onclick = () => {
					showChat();
				};
				document.getElementById('chatCloseBtn').onclick = () => {
					hideChat();
				};
				document.getElementById('chatSendBtn').onclick = () => {
					sendChat();
				};

				// 8) Первый апдейт HUD без пустых состояний

				updateCoinsUI();
				await loadSyncedSettings().catch(() => {});

				// сохранить актуальные значения в window, чтобы UI (надписи, таймер) их видел
				window.moveSteps = moveSteps;
				window.timerSeconds = timerSeconds;

				if (typeof applyTranslations === 'function') {
					applyTranslations();
				}

				await updateVotes().catch(() => {});
				updateRouteInfo().catch(() => {});
				loadChampions().catch(() => {});

				// 9) Интервалы только после готовности
				setInterval(updateVotes, 2000);

				setInterval(loadOnlineUsers, 10000);
				setInterval(updateMyActivity, 10000);
				setInterval(() => {
					if (!isDriving) {
						syncPosition();
					}
				}, 3000);

				// we enforce defaults per city; avoid overriding them from server every 7s
				// setInterval(loadSyncedSettings, 7000);

				setInterval(updateRouteInfo, 4000);
				setInterval(loadChampions, 45000);

				loadOnlineUsers();

				// 10) Готово — показываем приложение
				document.querySelector('.app')?.classList.add('ready');
				if (typeof applySOSLayout === 'function') applySOSLayout();
			}

			/* ===== CITY SWITCH / RESET ===== */
			async function resetToStart(city) {
				// 1) Берём стартовые координаты выбранного города
				const c = CITIES[city];

				// 2) Переключаем Street View в стартовую точку (heading = 0)
				setStreetViewTo(c.lat, c.lng, 0);
				setTimeout(updateArrowVisibility, 500);

				// 3) Обновляем маркер машинки на всплывающей карте (если есть)
				if (routeCarMarker) {
					routeCarMarker.setPosition({ lat: c.lat, lng: c.lng });
				}
				if (mapPopup) {
					mapPopup.setCenter({ lat: c.lat, lng: c.lng });
				}

				// 4) ЧИСТИМ маршрут этого города в базе (route_points)
				//    и локальную историю — начинаем с чистого листа
				try {
					await clearRoute(city); // <-- важная новая строка
				} catch (_) {
					// тихо игнорируем ошибку очистки, чтобы не блокировать сброс
				}
				routeHistory[city] = [{ lat: c.lat, lng: c.lng }];
				if (mapRoutePath) {
					mapRoutePath.setPath(routeHistory[city]);
				}

				// 5) Фиксируем "последнюю позицию" для синхронизации с сервером
				await setLastPosition(city, c.lat, c.lng, 0).catch(() => {});

				// 6) Записываем СТАРТОВУЮ точку маршрута в БД (после очистки)
				await saveRoutePoint(city, c.lat, c.lng).catch(() => {});

				// 7) Сброс голосов/локальных флагов голосования
				try {
					await fetch(
						`${window.SUPABASE_URL}/rest/v1/votes_summary?city=eq.${city}&mode=eq.voting`,
						{
							method: 'PATCH',
							headers: {
								apikey: window.SUPABASE_ANON_KEY,
								'Content-Type': 'application/json',
							},
							body: JSON.stringify({ count: 0 }),
						}
					);
				} catch (_) {}

				hasVoted = false;
				localStorage.removeItem(`voted_${city}`);
				votes = { left: 0, straight: 0, right: 0, backward: 0 };
				await updateVotes();

				// 8) Сброс таймера и руля
				forcedDirection = null;
				resetTimer();
				resetWheel();
			}

			async function syncCity(city) {
				// 1) Берём последнюю позицию (или дефолт города)
				let lastPos = await getLastPosition(city);
				let pos = lastPos
					? { lat: lastPos.lat, lng: lastPos.lng }
					: CITIES[city];
				let heading = lastPos ? lastPos.heading : 0;

				// 2) Переключаем Street View и даём стрелкам обновиться
				setStreetViewTo(pos.lat, pos.lng, heading);
				setTimeout(updateArrowVisibility, 900);

				// 3) Обновляем маркеры/центры
				if (routeCarMarker) routeCarMarker.setPosition(pos);
				if (mapPopup) mapPopup.setCenter(pos);

				// 4) Грузим маршрут из БД (route_points). Если есть — рисуем его.
				//    Если нет — стартуем с одной точки и сохраняем её как начало.
				let loaded = [];
				try {
					loaded = await loadRoute(city);
				} catch (_) {
					loaded = [];
				}

				if (loaded && loaded.length > 0) {
					routeHistory[city] = loaded;
					if (mapRoutePath) mapRoutePath.setPath(loaded);
					if (routeCarMarker)
						routeCarMarker.setPosition(loaded[loaded.length - 1]);
				} else {
					routeHistory[city] = [pos];
					if (mapRoutePath) mapRoutePath.setPath([pos]);
					if (routeCarMarker) routeCarMarker.setPosition(pos);
					try {
						await saveRoutePoint(city, pos.lat, pos.lng);
					} catch (_) {}
				}

				// 5) Локальные флаги/сбросы/обновление голосов
				hasVoted = !!localStorage.getItem(`voted_${city}`);
				forcedDirection = null;
				resetTimer();
				resetWheel();
				await updateVotes();

				// load per-city steps/seconds from Supabase
				await loadSyncedSettings().catch(() => {});
				window.moveSteps = moveSteps;
				window.timerSeconds = timerSeconds;
				if (typeof applyTranslations === 'function') applyTranslations();
			}

			/* ===== ONLINE ===== */
			async function updateMyActivity() {
				const user = getCurrentUser();
				await fetch(`${window.SUPABASE_URL}/rest/v1/users`, {
					method: 'POST',
					headers: {
						apikey: window.SUPABASE_ANON_KEY,
						'Content-Type': 'application/json',
						Prefer: 'resolution=merge-duplicates',
					},
					body: JSON.stringify([
						{
							user_id: user.id,
							name: user.username,
							avatar: user.photo_url,
							last_active: new Date().toISOString(),
							registered_at: new Date().toISOString(),
						},
					]),
				});
			}
			async function loadOnlineUsers() {
				try {
					const res = await fetch(
						`${window.SUPABASE_URL}/rest/v1/users?select=user_id,name,avatar,last_active,clicks_total&order=last_active.desc`,
						{ headers: { apikey: window.SUPABASE_ANON_KEY } }
					);
					const users = await res.json();
					const now = Date.now();
					let html = '<div class="users-header">Онлайн:</div>';
					let body = '';
					users.forEach(u => {
						const last = new Date(u.last_active);
						const diffSec = (now - last.getTime()) / 1000;
						if (diffSec < 15) {
							body += `<div class="user-row">
          <img class="avatar" src="${
						u.avatar ? u.avatar : 'https://www.gravatar.com/avatar/?d=mp&s=40'
					}" />
          <span class="username">${u.name ? u.name : 'Anon'}</span>
          <span class="userid">#${
						u.user_id ? String(u.user_id).slice(0, 7) : '-'
					}</span>
          <span class="clicks" style="color:#ffc43c;font-weight:bold;margin-left:8px;">${
						typeof u.clicks_total === 'number'
							? 'Кликов: ' + u.clicks_total
							: ''
					}</span>
        </div>`;
						}
					});
					if (!body)
						body =
							'<div style="color:#aaa;font-size:13px;padding:6px 0;">Пока никого нет</div>';
					document.getElementById('onlineUsersPanel').innerHTML = html + body;
				} catch (e) {}
			}
			async function loadChampions() {
				const list = document.getElementById('championsList');
				if (!list) return;

				try {
					const res = await fetch(
						`${window.SUPABASE_URL}/rest/v1/users?select=user_id,name,avatar,clicks_total,last_active&order=clicks_total.desc&limit=20`,
						{
							headers: {
								apikey: window.SUPABASE_ANON_KEY,
								Authorization: `Bearer ${window.SUPABASE_ANON_KEY}`,
							},
						}
					);

					let rows = await res.json();

					// if nothing or error shape -> fallback to empty array
					if (!Array.isArray(rows)) rows = [];

					// prefer users with clicks_total > 0
					let withClicks = rows.filter(
						u => typeof u?.clicks_total === 'number' && u.clicks_total > 0
					);

					// if all clicks_total are null/zero -> just sort by last_active
					if (!withClicks.length) {
						withClicks = [...rows].sort((a, b) => {
							const ta = a?.last_active ? Date.parse(a.last_active) : 0;
							const tb = b?.last_active ? Date.parse(b.last_active) : 0;
							return tb - ta;
						});
					}

					// take top 3
					const top3 = withClicks.slice(0, 3);

					// if still nothing -> show fallback demo champions (to verify UI)
					const dataToRender = top3.length
						? top3
						: [
								{ name: 'Demo Driver 1', avatar: null, clicks_total: 111 },
								{ name: 'Demo Driver 2', avatar: null, clicks_total: 77 },
								{ name: 'Demo Driver 3', avatar: null, clicks_total: 42 },
						  ];

					list.innerHTML = '';

					const medals = ['🥇', '🥈', '🥉'];

					dataToRender.forEach((u, idx) => {
						if (!u) return;

						const card = document.createElement('div');
						card.className = 'champion-card';

						const medal = document.createElement('div');
						medal.className = 'champion-medal';
						medal.textContent = medals[idx] || '';

						const img = document.createElement('img');
						img.className = 'champion-avatar';
						img.src = u.avatar || 'https://www.gravatar.com/avatar/?d=mp&s=80';

						const name = document.createElement('div');
						name.className = 'champion-name';
						name.textContent = u.name || 'Driver';

						const clicks =
							typeof u.clicks_total === 'number' ? u.clicks_total : 0;
						card.title = `${name.textContent}: ${clicks} clicks`;

						card.appendChild(medal);
						card.appendChild(img);
						card.appendChild(name);
						list.appendChild(card);
					});
				} catch (e) {
					console.warn('loadChampions error:', e);

					// hard fallback: even if Supabase totally fails — show demo
					const list = document.getElementById('championsList');
					if (!list) return;
					list.innerHTML = '';

					const demo = [
						{ name: 'Demo Driver 1', avatar: null, clicks_total: 111 },
						{ name: 'Demo Driver 2', avatar: null, clicks_total: 77 },
						{ name: 'Demo Driver 3', avatar: null, clicks_total: 42 },
					];
					const medals = ['🥇', '🥈', '🥉'];

					demo.forEach((u, idx) => {
						const card = document.createElement('div');
						card.className = 'champion-card';

						const medal = document.createElement('div');
						medal.className = 'champion-medal';
						medal.textContent = medals[idx] || '';

						const img = document.createElement('img');
						img.className = 'champion-avatar';
						img.src = 'https://www.gravatar.com/avatar/?d=mp&s=80';

						const name = document.createElement('div');
						name.className = 'champion-name';
						name.textContent = u.name;

						card.title = `${name.textContent}: ${u.clicks_total} clicks`;

						card.appendChild(medal);
						card.appendChild(img);
						card.appendChild(name);
						list.appendChild(card);
					});
				}
			}

			/* ===== BOOT ===== */
			window.addEventListener('resize', fitViewport, { passive: true });
			window.addEventListener('orientationchange', fitViewport, {
				passive: true,
			});

			// ===== WAKE/SLEEP: устраняем серый/чёрный кадр при возврате из Telegram =====
			(function setupWakeSleep() {
				let waking = false;

				async function wakeUp() {
					if (waking) return;
					waking = true;
					try {
						fitViewport();

						if (panorama) {
							// сохранить тек. состояние
							const pov = (() => {
								try {
									return panorama.getPov();
								} catch (_) {
									return { heading: fixedHeading || 0, pitch: 0 };
								}
							})();
							const panoId = (() => {
								try {
									return panorama.getPano();
								} catch (_) {
									return null;
								}
							})();
							// 1) выключить на кадр, чтобы пересобрался слой
							try {
								panorama.setVisible(false);
							} catch (_) {}
							await new Promise(r => requestAnimationFrame(r));
							// 2) вернуть тот же pano/pov
							try {
								if (panoId) panorama.setPano(panoId);
								panorama.setPov({
									heading: pov?.heading ?? (fixedHeading || 0),
									pitch: pov?.pitch ?? 0,
								});
							} catch (_) {}
							// 3) включить обратно и триггеры перерисовки
							try {
								panorama.setVisible(true);
							} catch (_) {}
							setTimeout(() => {
								try {
									google.maps.event.trigger(panorama, 'resize');
								} catch (_) {}
								try {
									lockCamera();
								} catch (_) {}
								try {
									updateArrowVisibility();
								} catch (_) {}
							}, 120);
						}

						// гарантированно показать UI
						document.querySelector('.app')?.classList.add('ready');
						if (typeof applySOSLayout === 'function') applySOSLayout();
					} finally {
						waking = false;
					}
				}

				function sleep() {
					/* можно глушить звуки/таймеры при сворачивании */
				}

				document.addEventListener('visibilitychange', () => {
					if (document.visibilityState === 'visible') wakeUp();
					else sleep();
				});
				window.addEventListener('pageshow', wakeUp);
				window.addEventListener('focus', wakeUp);
			})();
		</script>

		<script>
			// ===== ARROW VISIBILITY LOGIC =====

			// Повесим апдейт на каждый переход панорамы и на смену POV (heading)
			// Дублируем после каждого движения, чтобы после drive тоже обновлялось:

			async function updateArrowVisibility() {
				if (!panorama) return;
				let links = [];
				try {
					links = panorama.getLinks() || [];
				} catch (e) {
					links = [];
				}

				const allowed = {
					straight: false,
					left: false,
					right: false,
					backward: false,
				};
				const baseHeading =
					typeof fixedHeading === 'number'
						? fixedHeading
						: panorama.getPov()?.heading || 0;

				function directionToTarget(dir) {
					switch (dir) {
						case 'left':
							return (baseHeading - 90 + 360) % 360;
						case 'right':
							return (baseHeading + 90) % 360;
						case 'backward':
							return (baseHeading + 180) % 360;
						case 'straight':
						default:
							return baseHeading;
					}
				}
				function angDiff(a, b) {
					let d = Math.abs(a - b) % 360;
					return d > 180 ? 360 - d : d;
				}

				// Асинхронная функция для проверки "не тупик ли там"
				async function willBeDeadEnd(panoId) {
					return new Promise(resolve => {
						const sv = new google.maps.StreetViewService();
						sv.getPanorama({ pano: panoId }, (data, status) => {
							if (status !== google.maps.StreetViewStatus.OK || !data) {
								resolve(true); // no data -> dead end
								return;
							}
							const links = Array.isArray(data.links) ? data.links : [];
							const currentPano = (function () {
								try {
									return panorama && typeof panorama.getPano === 'function'
										? panorama.getPano()
										: null;
								} catch (_) {
									return null;
								}
							})();

							// Dead-end rules:
							// - 0 links
							// - only links back to current pano
							// - 1 link total (prevents traps)
							if (links.length === 0) {
								resolve(true);
								return;
							}
							const nonBack = links.filter(
								l => l && l.pano && l.pano !== currentPano
							);
							if (nonBack.length === 0) {
								resolve(true);
								return;
							}
							if (links.length <= 1) {
								resolve(true);
								return;
							}

							resolve(false); // safe
						});
					});
				}

				// Для каждой стрелки проверяем наличие link и тупик ли там
				['straight', 'left', 'right', 'backward'].forEach(async dir => {
					const target = directionToTarget(dir);
					let found = null;
					for (const l of links) {
						if (typeof l.heading !== 'number') continue;
						if (angDiff(l.heading, target) < 45) {
							const deadEnd = await willBeDeadEnd(l.pano);
							if (!deadEnd) {
								found = l;
								break;
							}
							// continue searching another link in this sector
						}
					}
					allowed[dir] = !!found;
					// обновить кнопку, если уже есть на странице
					const btn = document.querySelector(
						`.control-arrows__btn[data-dir="${dir}"]`
					);
					if (btn) {
						if (allowed[dir]) {
							btn.style.opacity = '';
							btn.style.pointerEvents = '';
							btn.style.filter = '';
						} else {
							btn.style.opacity = '0.12';
							btn.style.pointerEvents = 'none';
							btn.style.filter = 'grayscale(100%)';
						}
					}
				});
			}
			// новый updateRouteInfo: берём точки из route_points (через loadRoute)
			// === Обновление инфо + линия/маркер на большой карте ===
			// === Обновление инфо + линия/маркер на большой карте (устойчиво к лагам БД) ===
			// === Обновление инфо + линия/маркер на большой карте (устойчиво к лагам БД) ===
			async function updateRouteInfo() {
				try {
					// 1) Тянем маршрут из БД
					const ptsFromDb = await loadRoute(selectedCity); // [{lat,lng,ts}, ...]
					const prev = routeHistory[selectedCity] || [];
					const prevLen = prev.length;
					const dbLen = Array.isArray(ptsFromDb) ? ptsFromDb.length : 0;

					// 2) Если БД отстала — НЕ затираем локальное
					const usePts = dbLen >= prevLen && dbLen > 0 ? ptsFromDb : prev;

					// 3) Обновляем lastPosition из current_position (самая свежая точка)
					try {
						const p = await getLastPosition(selectedCity);
						if (p) {
							lastPosition = {
								lat: p.lat,
								lng: p.lng,
								heading: p.heading || 0,
							};
							if (routeCarMarker)
								routeCarMarker.setPosition({ lat: p.lat, lng: p.lng });
						}
					} catch (_) {}

					// 4) Рисуем линию: из БД/локала + «оптимистичный хвост» до машины
					routeHistory[selectedCity] = usePts;
					if (mapRoutePath) {
						let path = (usePts || []).map(p => ({ lat: p.lat, lng: p.lng }));

						if (lastPosition && path.length > 0) {
							const last = path[path.length - 1];
							const gapMeters = getDistance(last, {
								lat: lastPosition.lat,
								lng: lastPosition.lng,
							});
							const EPS = 25;
							if (gapMeters > EPS) {
								path = [
									...path,
									{ lat: lastPosition.lat, lng: lastPosition.lng },
								];
							}
						}

						mapRoutePath.setPath(path);
					}

					// 5) Метрики (дистанция/часы/голоса/участники)
					const totalKm = getRouteDistanceKm(
						(routeHistory[selectedCity] || []).map(p => ({
							lat: p.lat,
							lng: p.lng,
						}))
					);
					const hours = getRouteHours(routeHistory[selectedCity] || []);
					const votesAll = await getVotesTotalAllTime();
					const participantsTotal = await getTotalParticipants();

					// строка под панелью — путь + время + голоса
					const infoEl = document.getElementById('routeInfo');
					if (infoEl) {
						const days = Math.floor(hours / 24);
						const hrs = Math.floor(hours % 24);
						const part =
							days > 0
								? `${days} ${t('daysShort')} ${hrs} ${t('hoursShort')}`
								: `${hrs} ${t('hoursShort')}`;

						infoEl.textContent = `${t('enRoute')}: ${totalKm} ${t(
							'km'
						)} · ${part} · ${t('votes')}: ${votesAll.toLocaleString()}`;
					}

					// надпись в белой панели возле "Голоса: ..."
					const pEl = document.getElementById('participantsInfo');
					if (pEl) {
						pEl.textContent = `${t(
							'participants'
						)}: ${participantsTotal.toLocaleString()}`;
					}
				} catch (_) {
					// тихо, без блокировки HUD
				}
			}

			// Сумма всех кликов/голосов за всё время (через RPC) — БЕЗ 400
			async function getVotesTotalAllTime() {
				try {
					const res = await fetch(
						`${window.SUPABASE_URL}/rest/v1/rpc/total_clicks`,
						{
							method: 'POST',
							headers: {
								apikey: window.SUPABASE_ANON_KEY,
								Authorization: `Bearer ${window.SUPABASE_ANON_KEY}`,
								'Content-Type': 'application/json',
							},
							// тело не нужно — функция без параметров
							body: JSON.stringify({}),
						}
					);
					if (res.ok) {
						// PostgREST вернёт просто число
						const total = await res.json();
						return Number(total) || 0;
					}
				} catch (_) {}

				// Фолбэк (если RPC недоступен): тихо вернём 0
				return 0;
			}

			// Сумма голосов/кликов за всё время по всем игрокам
			// Общее количество уникальных игроков (все, кто хоть раз заходил)
			async function getTotalParticipants() {
				try {
					const res = await fetch(
						`${window.SUPABASE_URL}/rest/v1/users?select=user_id&limit=1`,
						{
							headers: {
								apikey: window.SUPABASE_ANON_KEY,
								Prefer: 'count=exact',
							},
						}
					);

					const cr = res.headers.get('Content-Range'); // "0-0/123"
					if (cr && cr.includes('/')) {
						const totalStr = cr.split('/')[1];
						const total = parseInt(totalStr, 10);
						if (!Number.isNaN(total)) return total;
					}
				} catch (_) {}

				// если что-то пошло не так — просто 0, без ошибок на экране
				return 0;
			}

			function getDistance(a, b) {
				if (!a || !b) return 0;
				const R = 6371000;
				const lat1 = (a.lat * Math.PI) / 180,
					lat2 = (b.lat * Math.PI) / 180;
				const dLat = ((b.lat - a.lat) * Math.PI) / 180;
				const dLng = ((b.lng - a.lng) * Math.PI) / 180;
				const c =
					Math.sin(dLat / 2) ** 2 +
					Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLng / 2) ** 2;
				return 2 * R * Math.asin(Math.sqrt(c));
			}
			function getRouteDistanceKm(points) {
				let sum = 0;
				for (let i = 1; i < points.length; i++)
					sum += getDistance(points[i - 1], points[i]);
				return (sum / 1000).toFixed(2);
			}
		</script>

		<script>
			(function () {
				// Cumulative coins required for each level (from Excel)
				const LEVEL_THRESHOLDS = [
					0, // lvl 1
					10, // lvl 2
					30, // lvl 3
					60, // lvl 4
					100, // lvl 5
					160, // lvl 6
					230, // lvl 7
					310, // lvl 8
					400, // lvl 9
					500, // lvl 10
					519, // lvl 11
					541, // lvl 12
					566, // lvl 13
					594, // lvl 14
					625, // lvl 15
					659, // lvl 16
					696, // lvl 17
					735, // lvl 18
					777, // lvl 19
					822, // lvl 20
					869, // lvl 21
					919, // lvl 22
					972, // lvl 23
					1027, // lvl 24
					1085, // lvl 25
					1146, // lvl 26
					1209, // lvl 27
					1275, // lvl 28
					1343, // lvl 29
					1414, // lvl 30
					1487, // lvl 31
					1563, // lvl 32
					1641, // lvl 33
				];

				function getCoinsFromLS() {
					try {
						const tg = window.Telegram && window.Telegram.WebApp;
						const u = tg && tg.initDataUnsafe && tg.initDataUnsafe.user;
						const uid = u && u.id ? String(u.id) : 'guest';
						return parseInt(
							localStorage.getItem(`coins_total_${uid}`) || '0',
							10
						);
					} catch (e) {
						return parseInt(localStorage.getItem('coins_total') || '0', 10);
					}
				}

				function calcLevel() {
					const coins = getCoinsFromLS();
					let level = 1;

					for (let i = 0; i < LEVEL_THRESHOLDS.length; i++) {
						if (coins >= LEVEL_THRESHOLDS[i]) {
							level = i + 1; // level index = threshold index + 1
						} else {
							break;
						}
					}

					return level;
				}

				// expose for other scripts (city locks etc.)
				window.getCurrentLevel = calcLevel;

				function renderLevel() {
					const levelEl = document.getElementById('playerLevel');
					if (levelEl) levelEl.textContent = String(calcLevel());
				}

				// Обновлять уровень каждые 0.5 секунды (или по сво

				setInterval(renderLevel, 500);

				// Если хочешь сразу — вызови
				renderLevel();

				// При добавлении монет — перерисовать уровень
				const prevAddCoins = window.addCoins;
				if (typeof prevAddCoins === 'function') {
					window.addCoins = function (n) {
						const res = prevAddCoins.call(this, n);
						renderLevel();
						return res;
					};
				}
			})();
		</script>

		<script>
			(function () {
				'use strict';

				async function clearServiceWorkers() {
					try {
						if (
							'serviceWorker' in navigator &&
							navigator.serviceWorker.getRegistrations
						) {
							const regs = await navigator.serviceWorker.getRegistrations();
							regs.forEach(r => r.unregister());
						}
					} catch (e) {}
				}
				async function clearCaches() {
					try {
						if (window.caches && caches.keys) {
							const keys = await caches.keys();
							await Promise.all(keys.map(k => caches.delete(k)));
						}
					} catch (e) {}
				}
				function clearStorages() {
					try {
						localStorage.clear();
					} catch (e) {}
					try {
						sessionStorage.clear();
					} catch (e) {}
				}
				function clearCookies() {
					try {
						(document.cookie || '').split(';').forEach(c => {
							const eq = c.indexOf('=');
							const name = (eq > -1 ? c.slice(0, eq) : c).trim();
							['', '/'].forEach(p => {
								document.cookie =
									name +
									'=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=' +
									(p || '/') +
									';SameSite=Lax';
								const parts = location.hostname.split('.');
								if (parts.length > 1) {
									const base = '.' + parts.slice(-2).join('.');
									document.cookie =
										name +
										'=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=' +
										(p || '/') +
										';domain=' +
										base +
										';SameSite=Lax';
								}
							});
						});
					} catch (e) {}
				}
				function clearIndexedDB() {
					return new Promise(resolve => {
						try {
							if (window.indexedDB && indexedDB.databases) {
								indexedDB
									.databases()
									.then(dbs => {
										Promise.all(
											(dbs || []).map(db =>
												db && db.name ? indexedDB.deleteDatabase(db.name) : null
											)
										).finally(resolve);
									})
									.catch(() => resolve());
							} else {
								[
									'tonroad',
									'tonroad-cache',
									'tonroad-store',
									'tr_store',
									'tr_cache',
									'supabase',
									'supabase-auth',
									'workbox-precache',
									'workbox-runtime',
								].forEach(n => {
									try {
										indexedDB.deleteDatabase(n);
									} catch (e) {}
								});
								resolve();
							}
						} catch (e) {
							resolve();
						}
					});
				}
				function clearTgCloud() {
					return new Promise(resolve => {
						try {
							const W =
								window.Telegram &&
								Telegram.WebApp &&
								Telegram.WebApp.CloudStorage;
							if (!W || !W.getKeys) return resolve();
							W.getKeys((err, keys) => {
								if (err || !keys || !keys.length) return resolve();
								let left = keys.length;
								keys.forEach(k => {
									try {
										W.removeItem(k, () => {
											if (--left === 0) resolve();
										});
									} catch (e) {
										if (--left === 0) resolve();
									}
								});
							});
						} catch (e) {
							resolve();
						}
					});
				}
				async function resetAll() {
					await Promise.all([
						clearServiceWorkers(),
						clearCaches(),
						clearIndexedDB(),
					]);
					clearStorages();
					clearCookies();
					await clearTgCloud(); // noop вне Telegram
					const url = new URL(location.href);
					url.searchParams.set('cleared', String(Date.now()));
					location.replace(url.toString());
				}
				// Long-press 10s anywhere to trigger reset (owner only in Telegram)
				(function attachLongPress() {
					let timer = null;
					let startX = 0,
						startY = 0;

					const HOLD_MS = 10000; // 10 seconds
					const MOVE_TOL = 9999; // do not cancel on small moves

					function start(e) {
						// no filtering by target: allow hold on top of HUD
						startX = e.clientX || (e.touches && e.touches[0]?.clientX) || 0;
						startY = e.clientY || (e.touches && e.touches[0]?.clientY) || 0;

						clearTimeout(timer);
						timer = setTimeout(async () => {
							clearTimeout(timer);
							timer = null;

							const tg = window.Telegram && window.Telegram.WebApp;
							const user = tg && tg.initDataUnsafe && tg.initDataUnsafe.user;
							const ownerId = 5959529178;

							// outside Telegram: allow reset (for tests in browser)
							if (!tg || !user) {
								if (confirm('Reset local data on this device?')) {
									await resetAll();
								}
								return;
							}

							// inside Telegram: only owner can reset
							if (Number(user.id) === ownerId) {
								if (confirm('Reset local data on this device?')) {
									await resetAll();
								}
							}
						}, HOLD_MS);
					}

					function end() {
						clearTimeout(timer);
						timer = null;
					}

					function move(e) {
						if (!timer) return;
						const p = e.touches ? e.touches[0] : e;
						const dx = Math.abs((p?.clientX || 0) - startX);
						const dy = Math.abs((p?.clientY || 0) - startY);
						if (dx + dy > MOVE_TOL) {
							end();
						}
					}

					document.addEventListener('pointerdown', start, { passive: true });
					document.addEventListener('pointerup', end, { passive: true });
					document.addEventListener('pointercancel', end, { passive: true });
					document.addEventListener('pointermove', move, { passive: true });

					// touch fallback
					document.addEventListener('touchstart', start, { passive: true });
					document.addEventListener('touchend', end, { passive: true });
					document.addEventListener('touchcancel', end, { passive: true });
					document.addEventListener('touchmove', move, { passive: true });
				})();
			})();
		</script>

		<script>
			/* ===== DECOR SYNC (plant/car/sticker) ===== */
			function isNftCarUrl(s) {
				return typeof s === 'string' && /\/car(\.png|\.webp|\.svg)?$/i.test(s);
			}

			function syncDecorSlots() {
				const plantEl = document.getElementById('plantSlot');
				const carEl = document.getElementById('carModel');
				const stickerEl = document.getElementById('toySlot');

				// РАСТЕНИЕ (слева)
				if (plantEl) {
					const v =
						localStorage.getItem('active_plant_img') ||
						plantEl.getAttribute('data-default-src') ||
						'cactus.png';
					plantEl.src = v;
				}

				// МАШИНА (справа)
				if (carEl) {
					const v =
						localStorage.getItem('active_car_img') ||
						carEl.getAttribute('data-default-src') ||
						'car.png';
					carEl.src = v;
				}

				// СТИКЕР (по умолчанию пусто и скрыт)
				if (stickerEl) {
					const v = (localStorage.getItem('active_sticker_img') || '').trim();
					if (v) {
						stickerEl.src = v;
						stickerEl.style.visibility = '';
					} else {
						stickerEl.removeAttribute('src');
						stickerEl.style.visibility = 'hidden';
					}
				}
			}

			document.addEventListener('DOMContentLoaded', () => {
				try {
					syncDecorSlots();
				} catch (e) {}
				try {
					if (typeof refreshCarIcon === 'function') refreshCarIcon();
				} catch (e) {}
			});

			window.addEventListener('storage', e => {
				if (
					e.key === 'active_plant_img' ||
					e.key === 'active_car_img' ||
					e.key === 'active_sticker_img' ||
					e.key === 'last_apply_ts'
				) {
					try {
						syncDecorSlots();
					} catch (e) {}
					try {
						if (typeof refreshCarIcon === 'function') refreshCarIcon();
					} catch (e) {}
				}
			});
		</script>

		<script>
			window.SOS_MODE = false;
			function applySOSLayout() {
				const app = document.querySelector('.app');
				const bg = app && app.querySelector('.app__bg');
				if (app && bg) {
					Array.from(app.children).forEach(ch => {
						if (ch === bg) return;
						ch.style.display = window.SOS_MODE ? 'none' : '';
					});
				}

				// Google Street View настройки
				if (window.panorama && typeof panorama.setOptions === 'function') {
					if (window.SOS_MODE) {
						panorama.setOptions({
							disableDefaultUI: false,
							linksControl: true,
							addressControl: true,
							showRoadLabels: true,
							clickToGo: true,
							scrollwheel: true,
						});
					} else {
						panorama.setOptions({
							disableDefaultUI: true,
							linksControl: false,
							addressControl: false,
							showRoadLabels: false,
							clickToGo: false,
							scrollwheel: false,
						});
					}
				}

				// Включаем/выключаем режим sos-mode для CSS и блокировщика тачей
				const body = document.body;
				const blocker = document.getElementById('block-touch');
				const backBtn = document.getElementById('btnBackTonRoad');

				if (body) {
					if (window.SOS_MODE) {
						body.classList.add('sos-mode');
						if (blocker) blocker.style.pointerEvents = 'none'; // не блокируем Гугл
						if (backBtn) backBtn.style.display = 'block';
					} else {
						body.classList.remove('sos-mode');
						if (blocker)
							blocker.style.pointerEvents = allowRotation ? 'none' : 'auto';
						if (backBtn) backBtn.style.display = 'none';
					}
				}

				// Высота хедера/футера
				const root = document.documentElement;
				if (root) {
					root.style.setProperty(
						'--header-h',
						window.SOS_MODE ? '0px' : '150px'
					);
					root.style.setProperty(
						'--footer-h',
						window.SOS_MODE ? '0px' : '188px'
					);
				}
			}
		</script>

		<script>
			window.initApp = initApp;
			(function loadGMaps() {
				const s = document.createElement('script');
				s.src = `https://maps.googleapis.com/maps/api/js?key=${window.GOOGLE_MAPS_KEY}&callback=initApp`;
				s.async = true;
				s.defer = true;
				document.head.appendChild(s);
			})();
		</script>

		<!-- Кнопка возврата из Google в TonRoad (видна только в SOS-режиме) -->
		<button
			id="btnBackTonRoad"
			class="sos-back-tonroad"
			type="button"
			style="display: none"
		>
			TonRoad
		</button>

		<script>
			const sosBtn = document.getElementById('sosToggle');

			let sosHideTimer = null;

			function showSosButtonTemp(durationMs = 5000) {
				if (!sosBtn) return;
				sosBtn.classList.add('visible');
				if (sosHideTimer) {
					clearTimeout(sosHideTimer);
				}
				sosHideTimer = setTimeout(() => {
					sosBtn.classList.remove('visible');
				}, durationMs);
			}

			if (sosBtn) {
				sosBtn.onclick = () => {
					window.SOS_MODE = !window.SOS_MODE;
					sosBtn.innerText = window.SOS_MODE ? 'G' : 'SOS';
					if (typeof applySOSLayout === 'function') applySOSLayout();
					// после нажатия по SOS тоже держим кнопку ещё немного видимой
					showSosButtonTemp();
				};

				// показать SOS-кнопку только при долгом нажатии (5 секунд) на экран
				let sosLongPressTimer = null;
				const SOS_LONG_PRESS_MS = 5000;

				document.addEventListener(
					'pointerdown',
					ev => {
						// не запускаем таймер, если нажали по самой SOS-кнопке
						if (ev.target.closest('#sosToggle')) return;

						if (sosLongPressTimer) {
							clearTimeout(sosLongPressTimer);
							sosLongPressTimer = null;
						}

						sosLongPressTimer = setTimeout(() => {
							showSosButtonTemp();
						}, SOS_LONG_PRESS_MS);
					},
					{ passive: true }
				);

				const cancelSosLongPress = () => {
					if (sosLongPressTimer) {
						clearTimeout(sosLongPressTimer);
						sosLongPressTimer = null;
					}
				};

				document.addEventListener('pointerup', cancelSosLongPress, {
					passive: true,
				});
				document.addEventListener('pointercancel', cancelSosLongPress, {
					passive: true,
				});
				document.addEventListener('pointerleave', cancelSosLongPress, {
					passive: true,
				});
			}

			const backBtn = document.getElementById('btnBackTonRoad');
			if (backBtn && sosBtn) {
				backBtn.onclick = () => {
					if (window.SOS_MODE) {
						sosBtn.click(); // используем ту же логику переключения
					}
				};
			}

			document.addEventListener(
				'contextmenu',
				function (e) {
					const isChatImage =
						e.target.classList && e.target.classList.contains('chat-photo');
					if (isChatImage) {
						e.preventDefault();
						e.stopPropagation();
					}
				},
				{ passive: false }
			);
		</script>

		<script>
			document.addEventListener('DOMContentLoaded', function () {
				var menuBtn = document.querySelector('.header__btn-menu');
				if (menuBtn) {
					menuBtn.addEventListener('click', function () {
						window.location.href = '/menu.html';
					});
				}
			});
		</script>
	</body>
</html>
