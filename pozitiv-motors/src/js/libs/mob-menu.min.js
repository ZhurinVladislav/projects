/**
 * Класс для управления мобильным меню.
 * Пример использования:
 * const mobMenu = new MobMenu(document.documentElement, document.body, mobMenuBtn, mobMenuWrap);
 * mobMenu.init();
 */
class MobMenu {
  constructor(html, body, btn, menu, isInnerMenu = false) {
    if (!html || !body || !btn || !menu) {
      throw new Error('Все DOM-элементы должны быть переданы в конструктор.');
    }

    this.html = html;
    this.body = body;
    this.btn = btn;
    this.menu = menu;
    this.isMenuOpen = false;
    this.isInnerMenu = isInnerMenu;
  }

  /**
   * Обработчик клика по кнопке открытия/закрытия меню.
   */
  handleBtn = () => {
    this.btn.addEventListener('click', () => {
      this.isMenuOpen ? this.close() : this.open();
    });
  };

  /**
   * Обработчик закрытия меню при нажатии клавиши ESC.
   */
  handleESC = () => {
    window.addEventListener('keydown', event => {
      if (event.key === 'Escape' && this.isMenuOpen) {
        this.close();
      }
    });
  };

  /**
   * Открытие мобильного меню.
   */
  open = () => {
    this.isMenuOpen = true;
    this.btn.classList.add('active');
    this.btn.setAttribute('aria-label', 'Закрыть мобильное меню');
    this.menu.classList.add('active');
    this.body.classList.add('menu-open');
    this.html.classList.add('menu-open');
  };

  /**
   * Закрытие мобильного меню.
   */
  close = () => {
    this.isMenuOpen = false;
    this.btn.classList.remove('active');
    this.btn.setAttribute('aria-label', 'Открыть мобильное меню');
    this.menu.classList.remove('active');
    this.body.classList.remove('menu-open');
    this.html.classList.remove('menu-open');
  };

  /**
   * Обработчик клика по кнопке открытия/закрытия меню.
   */
  toggleInnerMenu = () => {
    if (this.isInnerMenu) {
      const btn = this.menu.querySelectorAll('.js-mobile-list-btn');
      const list = this.menu.querySelectorAll('.js-mobile-list');

      if (!btn || !list) {
        throw new Error('Не найдены элементы внутреннего списка, проверить название классов "js-mobile-list-btn" и "js-mobile-list"');
      }

      list.forEach(el => {
        el.classList.add('hidden');
        el.style.display = 'none';
      });

      btn.forEach(el => {
        el.addEventListener('click', () => {
          const listEl = el.nextElementSibling;

          el.classList.toggle('active');
          listEl.classList.toggle('hidden');
          listEl.style.display = listEl.classList.contains('hidden') ? 'none' : 'flex';
        });
      });

      list.forEach(el => {
        const activeChild = el.querySelector('.active');

        if (activeChild) {
          const parentList = el.closest('.js-mobile-list');
          const parentBtn = parentList?.previousElementSibling;

          parentBtn?.classList.add('active');
          parentList?.classList.remove('hidden');
          parentList.style.display = 'flex';

          activeChild.querySelector('.js-mobile-btn')?.classList.add('active');
          const childList = activeChild.querySelector('.js-mobile-list');

          if (childList) {
            childList.classList.remove('hidden');
            childList.style.display = 'flex';
          }
        }
      });
    }
  };

  /**
   * Инициализация обработчиков.
   */
  init = () => {
    if (this.html && this.body && this.btn && this.menu) {
      this.handleBtn();
      this.handleESC();
      this.toggleInnerMenu();
    } else {
      console.warn('Не все элементы найдены. MobMenu не инициализирован.');
    }
  };
}

export default MobMenu;
